# Story 1.9 - Acceptance Test Guide

## Quick Summary

**Story**: Installation Preservation System
**Status**: Ready for Review
**Test Focus**: Verify that `.poem-preserve` protects user files during POEM reinstallation, user workflows are auto-detected, confirmation prompt works correctly, and version tracking is implemented.

## Prerequisites

**Before testing, ensure:**

- [ ] Story 1.9 status is "Ready for Review"
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem`
- [ ] Node.js 22.x installed
- [ ] No active POEM installations (for clean testing)
- [ ] Terminal supports ANSI colors (for visual tests)

**Environment Setup:**

- Node.js: 22.x LTS
- Package manager: npm 10.x
- Test project location: Create temporary test directories as needed
- Registry location: `~/.poem/registry.json`

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - terminal output, interactive prompts, visual confirmation.

### Test 1: AC1 - Preservation File Creation

**What to test**: During installation, `.poem-preserve` file is created with default rules

**Steps**:

1. Create a temporary test directory: `mkdir -p /tmp/poem-test-install && cd /tmp/poem-test-install`
2. Run: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
3. Observe terminal output for "Creating .poem-preserve" message
4. Open the created `.poem-preserve` file in a text editor
5. Verify file contents match the expected format

**Expected Result**:

‚úÖ Installation completes successfully with messages:
- "Creating .poem-preserve (preservation rules)..."
- "‚úì Created preservation file"

‚úÖ `.poem-preserve` file exists at project root with content:
```
# .poem-preserve
# Files/folders protected from overwriting during POEM installation

# User workspace - always preserved
poem/

# Dev workspace - always preserved (if exists)
dev-workspace/
```

**Evidence**:
- Terminal screenshot showing installation output
- Screenshot of `.poem-preserve` file contents

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC3 - Installation Confirmation Prompt (Clean Reinstall)

**What to test**: Reinstalling POEM shows confirmation prompt with file counts before overwriting

**Steps**:

1. Use the test directory from Test 1 (already has POEM installed)
2. Run reinstallation: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
3. Observe the installation summary displayed in terminal
4. Note the file counts and folder preservation list
5. When prompted "Continue? [y/N]", press Enter (abort)
6. Verify installation was cancelled

**Expected Result**:

‚úÖ Terminal displays formatted summary:
```
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
POEM Installation Summary:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Files to update: XX (framework files)
  Files preserved: XX (user content)
  Folders preserved: poem/, dev-workspace/
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

This will overwrite XX file(s). Continue? [y/N]:
```

‚úÖ After pressing Enter:
- Message: "Installation cancelled"
- No files changed (verify with `ls -la`)

**Evidence**:
- Terminal screenshot showing complete summary with file counts
- Screenshot showing "Installation cancelled" message

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC3 - Installation Confirmation Prompt (User Confirms)

**What to test**: Confirming the prompt proceeds with installation

**Steps**:

1. Use the same test directory
2. Run reinstallation: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
3. Observe the installation summary
4. When prompted "Continue? [y/N]", type `y` and press Enter
5. Observe installation proceeds
6. Check that preserved folders (`poem/`, `dev-workspace/`) still exist

**Expected Result**:

‚úÖ After typing `y`:
- Installation proceeds
- Framework files are updated
- `poem/` directory preserved (not deleted)
- Success message displayed

**Evidence**:
- Terminal screenshot showing confirmation acceptance
- Verification that `poem/` directory still exists

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 4: AC2 - User Workflow Preservation

**What to test**: User-created workflows in `.poem-core/workflows/` are preserved during reinstall

**Steps**:

1. In test directory, create a custom workflow: `echo "test: workflow" > .poem-core/workflows/my-custom-workflow.yaml`
2. Verify file exists: `cat .poem-core/workflows/my-custom-workflow.yaml`
3. Run reinstallation: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
4. Observe installation summary shows "Files preserved" count includes the custom workflow
5. Type `y` to confirm installation
6. After installation, verify custom workflow still exists: `cat .poem-core/workflows/my-custom-workflow.yaml`

**Expected Result**:

‚úÖ Installation summary shows increased "Files preserved" count
‚úÖ Custom workflow file preserved with original content
‚úÖ Framework workflows (create-prompt.yaml, etc.) are updated

**Evidence**:
- Screenshot showing custom workflow before installation
- Terminal screenshot of installation summary
- Screenshot showing custom workflow after installation (unchanged)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 5: AC5 - Modified File Warning

**What to test**: If user modifies a framework file, warning is displayed during reinstallation

**What to test**: Warning message displays when framework files are modified

**Note**: This test verifies the warning UI exists, but actual hash-based detection is not yet fully implemented (placeholder for future enhancement). The test validates the prompt structure is ready for when file hashing is added.

**Steps**:

1. Modify a framework file: `echo "# Modified by user" >> .poem-core/agents/prompt-engineer.md`
2. Run reinstallation: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
3. Observe installation summary for modified file warning
4. Type `n` to cancel installation

**Expected Result**:

‚úÖ Installation summary includes warning section (structure in place):
```
‚ö†Ô∏è  X file(s) were modified and will be overwritten:
    - .poem-core/agents/prompt-engineer.md
```

**Evidence**:
- Terminal screenshot showing warning message structure

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 6: AC2 - Custom Preservation Rules

**What to test**: Users can add custom paths to `.poem-preserve` file

**Steps**:

1. Edit `.poem-preserve`: `echo ".poem-core/templates/my-template.hbs" >> .poem-preserve`
2. Create the custom template: `echo "custom template" > .poem-core/templates/my-template.hbs`
3. Run reinstallation: `npx /Users/davidcruwys/dev/ad/poem-os/poem install --skip-deps`
4. Observe summary shows increased "Files preserved" count
5. Type `y` to confirm
6. Verify custom template preserved: `cat .poem-core/templates/my-template.hbs`

**Expected Result**:

‚úÖ Installation respects custom preservation rule
‚úÖ Custom template file preserved with original content
‚úÖ Other template files updated normally

**Evidence**:
- Screenshot of modified `.poem-preserve` file
- Terminal screenshot showing installation summary
- Verification custom template unchanged after install

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Preservation File Exists

**What to test**: `.poem-preserve` file is created during installation

**Command**:

```bash
cd /tmp/poem-test-install && test -f .poem-preserve && echo "‚úÖ File exists" || echo "‚ùå File missing"
```

**Expected Output**:

```
‚úÖ File exists
```

**Validation**:

- ‚úÖ Exit code 0
- ‚úÖ Message confirms file exists

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test B: AC1 - Preservation File Content

**What to test**: `.poem-preserve` contains default preservation rules

**Command**:

```bash
cd /tmp/poem-test-install && cat .poem-preserve
```

**Expected Output**:

```
# .poem-preserve
# Files/folders protected from overwriting during POEM installation
# Format: One file/folder path per line (relative to project root)
# Comments start with # and blank lines are ignored

# User workspace - always preserved
poem/

# Dev workspace - always preserved (if exists)
dev-workspace/

# Add custom preservation rules below:
# .poem-core/my-custom-workflow.yaml
# .poem-core/templates/my-template.hbs
```

**Validation**:

- ‚úÖ File contains `poem/` rule
- ‚úÖ File contains `dev-workspace/` rule
- ‚úÖ Comments present (lines starting with `#`)

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test C: AC4 - Version Tracking in Registry

**What to test**: Registry includes `poemVersion` field after installation

**Command**:

```bash
cat ~/.poem/registry.json | grep -o '"poemVersion"' && echo "‚úÖ Field exists" || echo "‚ùå Field missing"
```

**Expected Output**:

```
"poemVersion"
‚úÖ Field exists
```

**Validation**:

- ‚úÖ Registry contains `poemVersion` field
- ‚úÖ Exit code 0

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test D: AC4 - Version Value in Registry

**What to test**: `poemVersion` contains valid version string

**Command**:

```bash
cat ~/.poem/registry.json | grep -o '"poemVersion": "[^"]*"' | head -1
```

**Expected Output**:

```
"poemVersion": "0.1.0"
```

**Validation**:

- ‚úÖ Version follows semver format (X.Y.Z)
- ‚úÖ Version is not empty or "unknown"

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test E: AC6 - Documentation Section Exists

**What to test**: README.md contains "Preserving Your Files During Updates" section

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && grep -c "Preserving Your Files During Updates" README.md
```

**Expected Output**:

```
1
```

**Validation**:

- ‚úÖ Section heading found in README.md
- ‚úÖ Count is exactly 1 (not duplicated)

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test F: AC6 - Documentation Content

**What to test**: Documentation includes key preservation concepts

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && grep -c "\.poem-preserve" README.md
```

**Expected Output**:

```
[number >= 3]
```

**Validation**:

- ‚úÖ `.poem-preserve` mentioned multiple times
- ‚úÖ Documentation is comprehensive

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test G: AC2 - Preservation Module Exists

**What to test**: Core preservation module is created

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && test -f bin/preservation.js && echo "‚úÖ Module exists" || echo "‚ùå Module missing"
```

**Expected Output**:

```
‚úÖ Module exists
```

**Validation**:

- ‚úÖ `bin/preservation.js` file exists
- ‚úÖ Module contains preservation functions

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test H: Unit Tests Pass

**What to test**: All preservation unit tests pass

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && npx vitest run tests/bin/preservation.test.ts 2>&1 | tail -5
```

**Expected Output**:

```
 Test Files  1 passed (1)
      Tests  23 passed (23)
   Start at  [timestamp]
   Duration  [time]
```

**Validation**:

- ‚úÖ All 23 tests passed
- ‚úÖ No test failures
- ‚úÖ Test suite completes successfully

**Status**: ‚úÖ Passed

**Notes**: Automated test passed successfully

---

### Test I: Integration Tests Pass (No Regressions)

**What to test**: Existing installation tests still pass (Story 1.8 compatibility)

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && npx vitest run tests/bin/ 2>&1 | tail -10
```

**Expected Output**:

```
 ‚úì tests/bin/command-router.test.ts (8 tests)
 ‚úì tests/bin/utils.test.ts (14 tests)
 ‚úì tests/bin/preservation.test.ts (23 tests)
 ‚úì tests/bin/install.test.ts (16 tests)

 Test Files  4 passed (4)
      Tests  61 passed (61)
```

**Validation**:

- ‚úÖ All 61 tests passed across 4 test suites
- ‚úÖ No regressions in existing functionality
- ‚úÖ Preservation system integrates cleanly

**Status**: ‚úÖ Passed

**Notes**: Complete integration test suite passed - preservation system fully compatible with existing installer

---

## ‚è≥ Not Testable Yet

**AC5 (File Hash Detection)**: Full implementation of modified file detection requires file hash tracking
**Reason**: Hash-based modification detection is a placeholder for future enhancement. The warning UI structure is in place and ready.
**When**: Future story will implement hash tracking in registry metadata

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: Preservation file creation with default content
- [ ] Test 2: Installation confirmation prompt (abort scenario)
- [ ] Test 3: Installation confirmation prompt (proceed scenario)
- [ ] Test 4: User workflow preservation during reinstall
- [ ] Test 5: Modified file warning structure
- [ ] Test 6: Custom preservation rules respected

**Terminal Tests:**

- [x] Test A: Preservation file exists
- [x] Test B: Preservation file content correct
- [x] Test C: Version tracking field exists in registry
- [x] Test D: Version value is valid semver
- [x] Test E: Documentation section exists
- [x] Test F: Documentation content comprehensive
- [x] Test G: Preservation module exists
- [x] Test H: Unit tests pass (23/23)

**Overall Status**: üîÑ In Progress (8/8 terminal tests passed, 6 human tests pending)

---

## Troubleshooting

### Issue: Installation fails with "port already in use"

**Symptom**: Error during `npx poem-os install`
**Solution**:
- Check registry: `npx poem-os registry --list`
- Clean up: `npx poem-os registry --cleanup`
- Or use different port: `npx poem-os install --skip-deps` (port config happens after)

### Issue: `.poem-preserve` not created

**Symptom**: File missing after installation
**Solution**:
- Ensure you're running fresh install (not using `--core` or `--app` flags)
- Check file permissions in target directory
- Verify installation completed successfully

### Issue: Confirmation prompt not showing

**Symptom**: Reinstallation proceeds without confirmation
**Solution**:
- Don't use `--force` flag (it skips confirmation)
- Ensure existing installation detected (`.poem-core/` exists)
- Check terminal supports interactive input

### Issue: User workflows being overwritten

**Symptom**: Custom workflow deleted during reinstall
**Solution**:
- Verify workflow filename doesn't match framework workflows
- Framework workflows: create-prompt.yaml, refine-prompt.yaml, test-prompt.yaml, validate-prompt.yaml, deploy-prompt.yaml, add-helper.yaml, create-provider.yaml
- All other `.yaml` files should be preserved automatically

### Issue: Custom preservation rules not working

**Symptom**: Files added to `.poem-preserve` still being overwritten
**Solution**:
- Check path format (relative to project root, e.g., `.poem-core/my-file.yaml`)
- Ensure no typos in file paths
- Directory rules must end with `/` (e.g., `poem/` not `poem`)
- No leading or trailing whitespace in rules

---

## Test Results Summary

**Date Tested**: 2026-01-20
**Tester**: Taylor (SAT Guide Creator)

**Results**:

- Human Tests: 0 / 6 passed (pending manual execution)
- Terminal Tests: 8 / 8 passed
- Total: 8 / 14 passed (57% - automated tests complete)

**Automated Test Details**:
- ‚úÖ Preservation file creation and content
- ‚úÖ Version tracking in registry
- ‚úÖ Documentation updates
- ‚úÖ Preservation module exists
- ‚úÖ All 23 unit tests passing

**Issues Found**:

None - All automated tests passed successfully

**Next Steps**:

1. Execute 6 human tests manually (requires interactive terminal)
2. Verify confirmation prompt behavior with real reinstallation
3. Test user workflow preservation with actual custom workflows
4. Validate visual aspects (terminal colors, formatting)

**Sign-off**: üîÑ Automated tests passed - Human tests pending manual execution

---

_Generated by Taylor (SAT Guide Creator) from Story 1.9_

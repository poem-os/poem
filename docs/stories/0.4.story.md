# Story 0.4: Field Testing System with External POEM Project Integration

## Status

Draft

## Story

**As a** POEM developer using POEM in external projects (v-voz, prompt-supportsignal, v-appydave),
**I want** a field testing system that allows me to log blockers and observations from external projects and submit them to central POEM for processing,
**so that** I can track usage issues across multiple projects, link related problems, and enhance POEM's central issue tracker with multi-project context without tight coupling.

## Background

**Problem**: POEM is being used in 3 external projects, each discovering issues during real-world usage. Currently, there's no structured way to:
1. Capture blockers/observations from external project contexts
2. Submit discoveries to central POEM's issue tracking system
3. Link related issues across multiple projects
4. Enhance POEM issues with multi-project perspectives

**Current State**: Issue Logger (`/poem/log-issues`) only works within POEM repository, capturing issues in `docs/planning/gap-analysis/usage-issues.jsonl`. External projects have no mechanism to contribute observations.

**Solution**: Client-server architecture where external POEM installations (clients) submit observations to central POEM inbox (server), which are then processed by Triage agent to link to existing issues or create new ones.

**Epic 0 Category**: Developer Experience (P1)
**Priority**: P1 (High) - Enables structured field testing across multiple projects
**Estimated Effort**: 8-12 hours across 3 components

## Acceptance Criteria

### Component 1: Field Testing Agent (Client Side)

1. **Create Field Testing Agent** at `packages/poem-core/agents/field-tester.md`:
   - Agent persona: "Field Testing Observer"
   - Commands: `*log-blocker`, `*log-session`, `*log-status`
   - Uses Inbox Bridge Skill to submit to central POEM
   - Installed with POEM in external projects

2. **Create CLI wrapper** at `.claude/commands/poem/agents/field-tester.md`:
   - Thin wrapper for `/poem/agents/field-tester`
   - Follows POEM agent command pattern

3. **Create directory structure** for external projects:
   - `docs/field-testing/blockers/` (JSONL blocker logs)
   - `docs/field-testing/sessions/` (markdown session notes)

4. **Define client blocker schema** (v1.0):
   - `submissionId` (format: `{project}-{sequence}`, e.g., `v-voz-001`)
   - `timestamp` (ISO 8601)
   - `project` object (name, location, poemVersion)
   - `blocker` object (description, context, severity, workflowName, projectSpecificDetails)
   - `status` (pending, submitted, linked, resolved)
   - `poemIssueRef` (null initially, filled when POEM processes)
   - `submittedTo` (path to POEM inbox file)

### Component 2: Inbox Bridge Skill (Transport Layer)

5. **Create Inbox Bridge Skill** following Anthropic skill-creator patterns:
   - **Directory**: `packages/poem-core/skills/poem-inbox-bridge/`
   - **Structure**: `SKILL.md` (frontmatter + body), optional `scripts/`, `references/`, `assets/`
   - **Frontmatter** (YAML):
     - `name: poem-inbox-bridge`
     - `description`: "Submit field testing observations from external POEM installations to central POEM inbox. Use when working in external projects (v-voz, prompt-supportsignal, v-appydave) and need to log blockers, issues, or observations that should be tracked in central POEM issue registry. Triggers: 'log this to POEM', 'submit to inbox', 'report issue to central POEM', 'blocker submission'."
   - **Body**: Concise instructions for creating submission files in POEM inbox
   - **Behavior**: Writes submission JSONL to `/Users/davidcruwys/dev/ad/poem-os/poem/docs/planning/gap-analysis/inbox/{submissionId}.json`

6. **Skill follows progressive disclosure principle**:
   - SKILL.md body < 500 lines
   - Only essential instructions in main file
   - Reference external docs if needed (e.g., schema format)

### Component 3: Triage Inbox Processing (Server Side)

7. **Extend Triage task** at `.bmad-core/tasks/triage-work.md`:
   - Add **Mode E: Inbox Processing**
   - Triggered by `/triage inbox`
   - Scan `docs/planning/gap-analysis/inbox/` for `*.json` files with `status: "pending"`
   - List submissions, prompt user to select which to process
   - Search existing POEM issues for similarity (description matching)
   - If match found (>80% similarity): Link submission to existing issue, enhance issue with new project perspective
   - If no match: Prompt user to create new POEM issue, link submission

8. **Update POEM issue schema** to track multi-project reporting:
   - Add `reportedBy` array field (optional, not in v1.0/v2.0, new in v2.1)
   - Each entry: `{submissionId, project, timestamp, projectSpecificDetails}`
   - Enables tracking which projects reported same issue

9. **Update submission status** after processing:
   - Change `status: "pending"` → `"linked"` (if matched to existing issue)
   - Add `poemIssueRef: "issue-{N}"` field
   - Optionally update client-side blocker file (bidirectional sync)

10. **Create inbox directory** in POEM:
    - `docs/planning/gap-analysis/inbox/`
    - `.gitignore` pattern: `inbox/*.json` (inbox is transient, submissions processed then archived/deleted)

### Component 4: Documentation & User Guide

11. **Create Field Testing Guide** at `docs/planning/gap-analysis/field-testing-guide.md`:
    - Overview of client-server architecture
    - Usage instructions for Field Testing Agent
    - Workflow example: log blocker in v-voz → submit to POEM → process in Triage
    - Schema documentation (client blocker, inbox submission, enhanced POEM issue)
    - Troubleshooting section

12. **Update Triage Guide** at `docs/workflows/triage-guide.md`:
    - Add "Mode E: Inbox Processing" section
    - Document `/triage inbox` usage
    - Examples of linking submissions to issues

## Dev Notes

### Architecture Context

**Tech Stack** [Source: architecture/tech-stack.md]:
- **Framework Documents**: Markdown + YAML for agents (BMAD v4 pattern - line 11)
- **Skills**: Markdown with YAML frontmatter (Anthropic skill-creator pattern - line 13)
- **Runtime**: Node.js 22.x LTS, TypeScript 5.9.x for any scripts (lines 18-19)
- **Storage**: File-based JSONL (no database - line 37)

**Project Structure** [Source: architecture/unified-project-structure.md]:
- **CRITICAL**: All development happens in `packages/poem-core/` and `packages/poem-app/` (lines 7-12)
- Agents: `packages/poem-core/agents/` (line 40)
- Skills: `packages/poem-core/skills/` (line 55)
- User workspace: `docs/field-testing/` for external projects (new structure)
- POEM inbox: `docs/planning/gap-analysis/inbox/` (new structure)

**Naming Conventions** [Source: architecture/coding-standards.md]:
- Agent files: `kebab-case.md` (e.g., `field-tester.md`) - line 26
- Skill files: `kebab-case.md` for SKILL.md, kebab-case directory name - line 28
- JSONL files: `kebab-case.jsonl` or numbered like `v-voz-001.json`

### Anthropic Skill-Creator Pattern

**CRITICAL**: Inbox Bridge Skill must follow Anthropic's skill-creator best practices:

**Skill Structure** [Source: conversation context - Anthropic skill-creator patterns]:
```
packages/poem-core/skills/poem-inbox-bridge/
├── SKILL.md (required)
│   ├── YAML frontmatter (name, description) - required
│   └── Markdown instructions - required
└── Optional bundled resources
    ├── scripts/          - Executable code (if needed)
    ├── references/       - Documentation (if needed)
    └── assets/           - Output files (if needed)
```

**Frontmatter Requirements**:
- `name`: skill name (e.g., `poem-inbox-bridge`)
- `description`: **Primary triggering mechanism** - include what skill does AND when to use it
  - Must be comprehensive - body loads AFTER skill triggers
  - Example: "Submit field testing observations from external POEM installations to central POEM inbox. Use when working in external projects (v-voz, prompt-supportsignal, v-appydave) and need to log blockers, issues, or observations that should be tracked in central POEM issue registry. Triggers: 'log this to POEM', 'submit to inbox', 'report issue to central POEM', 'blocker submission'."

**Body Guidelines**:
- **Concise is key**: Only add context Claude doesn't already have
- **Default assumption**: Claude is already very smart
- Keep body < 500 lines (use references/ for detailed docs)
- Imperative/infinitive form ("Submit observation", not "Submitting observation")
- **Progressive disclosure**: Metadata → SKILL.md → References as needed
- No auxiliary files (README.md, INSTALLATION_GUIDE.md, etc.) - only essential content

**What NOT to include**:
- README.md, CHANGELOG.md, QUICK_REFERENCE.md (extraneous documentation)
- Process documentation, setup procedures, testing guides (not for AI agent)

### Previous Story Insights

**Story 0.1** [Source: docs/stories/0.1.story.md]:
- Created Triage system with 5 routing paths (lines 71-78)
- Decision criteria: time/ceremony, existing story, epic fit, Epic 0 (lines 54-70)
- Supports `/triage issue-{N}` format for usage issue conversion (line 194)
- Task file location: `.bmad-core/tasks/triage-work.md` (line 54)

**Story 0.2** [Source: docs/stories/0.2.story.md]:
- Issue Logger upgraded to v2.0 schema with `schemaVersion`, `estimatedTime`, `thematicArea`, `type`, `suggestedPath` (lines 55-57)
- Triage reads v2.0 fields directly, falls back to v1.0 inference (lines 64-86)
- Unified vocabulary: `.bmad-core/vocabularies/work-item-taxonomy.yaml` (line 38)
- Triage logic reference: `.bmad-core/utils/triage-logic.md` (line 42)

**Key Learnings**:
- Use existing Triage infrastructure (Modes A-D already exist)
- Mode E should follow same pattern: parse input → analyze context → route decision
- Reuse Issue Logger patterns (JSONL storage, schema versioning, status tracking)
- Field Testing Agent can reference Issue Logger persona as example

### Data Models

**Client Blocker Schema** (v1.0):
```jsonl
{
  "submissionId": "v-voz-001",              // Format: {project}-{sequence}
  "timestamp": "2026-01-22T10:00:00Z",
  "project": {
    "name": "v-voz",
    "location": "/Users/davidcruwys/dev/video-projects/v-voz",
    "poemVersion": "0.1.0"
  },
  "blocker": {
    "description": "Multi-workflow switching loses state",
    "context": "Working on storyline workflow, switched to nano-banana, lost draft data",
    "severity": "high",                    // critical/high/medium/low
    "workflowName": "storyline",
    "projectSpecificDetails": {            // Flexible object for project context
      "schemaFiles": ["poem/workflows/storyline/schemas/character.schema.json"],
      "promptFiles": ["poem/workflows/storyline/prompts/generate-character.hbs"],
      "dataLost": "3 character descriptions"
    }
  },
  "status": "pending",                      // pending → submitted → linked → resolved
  "poemIssueRef": null,                    // Filled when POEM Triage processes
  "submittedTo": "/Users/davidcruwys/dev/ad/poem-os/poem/docs/planning/gap-analysis/inbox/v-voz-001.json"
}
```

**POEM Inbox Submission**: Same structure as Client Blocker (copied to inbox directory)

**Enhanced POEM Issue** (v2.1 - backward compatible addition):
```jsonl
{
  // Existing v2.0 fields...
  "observation": "Multi-workflow switching loses state",
  "category": "bug",
  "severity": "high",
  "schemaVersion": "2.1",

  // NEW: Multi-project tracking
  "reportedBy": [                          // Optional array (empty if not from field testing)
    {
      "submissionId": "v-voz-001",
      "project": "v-voz",
      "timestamp": "2026-01-22T10:00:00Z",
      "projectSpecificDetails": {
        "workflowName": "storyline",
        "dataLost": "3 character descriptions"
      }
    },
    {
      "submissionId": "prompt-ss-005",
      "project": "prompt-supportsignal",
      "timestamp": "2026-01-23T14:00:00Z",
      "projectSpecificDetails": {
        "workflowName": "narrative-enhancement",
        "affectedPrompts": 5
      }
    }
  ]
}
```

### File Locations

**Files to Create**:
- `packages/poem-core/agents/field-tester.md` - Field Testing Agent definition
- `.claude/commands/poem/agents/field-tester.md` - CLI wrapper
- `packages/poem-core/skills/poem-inbox-bridge/SKILL.md` - Inbox Bridge Skill
- `docs/planning/gap-analysis/field-testing-guide.md` - User guide

**Files to Modify**:
- `.bmad-core/tasks/triage-work.md` - Add Mode E (Step 1: Parse Input Format)
- `docs/workflows/triage-guide.md` - Add Mode E documentation
- `docs/planning/gap-analysis/usage-issues.schema.json` - Add v2.1 `reportedBy` field (optional)

**Directories to Create**:
- `docs/planning/gap-analysis/inbox/` - POEM central inbox (gitignored)
- External projects get `docs/field-testing/` structure via Field Testing Agent

**Gitignore Updates**:
- Add `docs/planning/gap-analysis/inbox/*.json` to `.gitignore` (inbox is transient)

### Technical Constraints

**POEM Inbox Location** [Source: conversation context]:
- Hardcoded path: `/Users/davidcruwys/dev/ad/poem-os/poem/docs/planning/gap-analysis/inbox/`
- This is acceptable for MVP - all external projects know where central POEM is located
- Future enhancement: Make path configurable via environment variable or config file

**Skill Packaging** [Source: conversation context]:
- Inbox Bridge Skill should be **bundled with POEM installation** (not global skill)
- Located in `packages/poem-core/skills/` so it's included when POEM is installed
- External POEM installations automatically get the skill

**Client-Server Communication** [Source: conversation context]:
- **Direct file write** (Option A): Inbox Bridge Skill writes directly to POEM inbox path
- **No sync command** needed - write operation is immediate
- **Manual processing**: User runs `/triage inbox` in POEM repo when ready to process

### Testing Strategy

**Manual Testing** (framework story - no automated tests):

1. **Field Testing Agent**:
   - Activate `/poem/agents/field-tester` in external project (v-voz)
   - Run `*log-blocker` command
   - Verify blocker logged to `docs/field-testing/blockers/001.json`
   - Verify submission created in POEM inbox

2. **Inbox Bridge Skill**:
   - Verify skill triggered when Field Testing Agent submits
   - Check POEM inbox contains submission file with correct schema
   - Validate JSON structure matches spec

3. **Triage Inbox Processing**:
   - Run `/triage inbox` in POEM repo
   - Verify submissions listed correctly
   - Test linking to existing issue (similarity match)
   - Test creating new issue (no match)
   - Verify submission status updated to "linked"
   - Verify `poemIssueRef` field populated

4. **Multi-Project Scenario**:
   - Log similar blocker from 2 different projects (v-voz + prompt-ss)
   - Process first submission → creates Issue #X
   - Process second submission → links to Issue #X
   - Verify Issue #X has 2 entries in `reportedBy` array

5. **Session Logging**:
   - Run `*log-session` command
   - Verify creates markdown file in `docs/field-testing/sessions/`
   - Test quick notes format (timestamp + freeform text)

## Tasks / Subtasks

### Task 1: Create Field Testing Agent (AC: 1, 2, 3)

- [ ] Create `packages/poem-core/agents/field-tester.md` with:
  - [ ] YAML frontmatter (agent metadata)
  - [ ] Persona section: "Field Testing Observer"
  - [ ] Commands: `*log-blocker`, `*log-session`, `*log-status`
  - [ ] Dependencies: reference `poem-inbox-bridge` skill
  - [ ] Instructions for each command
- [ ] Create `.claude/commands/poem/agents/field-tester.md` CLI wrapper:
  - [ ] Thin wrapper following POEM agent pattern
  - [ ] Load agent definition from packages/poem-core/agents/
  - [ ] Usage examples
- [ ] Document Field Testing Agent in relevant guides

### Task 2: Create Inbox Bridge Skill (AC: 5, 6)

- [ ] Create skill directory: `packages/poem-core/skills/poem-inbox-bridge/`
- [ ] Create `SKILL.md` with proper structure:
  - [ ] YAML frontmatter with `name` and comprehensive `description`
  - [ ] Body: Concise instructions for submission file creation
  - [ ] Include schema reference (client blocker format)
  - [ ] Include example submission with field descriptions
  - [ ] Keep body < 500 lines (progressive disclosure)
- [ ] Test skill loads correctly in Claude Code
- [ ] Verify skill triggers on appropriate phrases

### Task 3: Define Schemas and Data Formats (AC: 4)

- [ ] Document client blocker schema (v1.0):
  - [ ] All required fields with types and descriptions
  - [ ] Example JSONL record
  - [ ] Validation rules
- [ ] Document submission ID format: `{project}-{sequence}`
  - [ ] Sequence is 3-digit zero-padded (001, 002, etc.)
  - [ ] Project names: `v-voz`, `prompt-ss`, `v-appydave`
- [ ] Document enhanced POEM issue schema (v2.1):
  - [ ] Add `reportedBy` array field (optional, backward compatible)
  - [ ] Example multi-project issue

### Task 4: Extend Triage Task with Mode E (AC: 7, 9)

- [ ] Open `.bmad-core/tasks/triage-work.md`
- [ ] Add Mode E to Step 1 (Parse Input Format):
  - [ ] Detect `/triage inbox` command
  - [ ] Scan `docs/planning/gap-analysis/inbox/*.json`
  - [ ] Filter for `status: "pending"`
  - [ ] List submissions with numbers
  - [ ] Prompt user: "Process which submission? [1/2/all]"
- [ ] Add inbox processing workflow to Step 2-4:
  - [ ] Load selected submission JSON
  - [ ] Search existing issues for similarity (description matching)
  - [ ] If match found (>80%): Display match, prompt to link
  - [ ] If no match: Prompt to create new issue
- [ ] Add submission update logic:
  - [ ] Change status: `"pending"` → `"linked"`
  - [ ] Add `poemIssueRef: "issue-{N}"`
  - [ ] Write updated submission back to inbox file

### Task 5: Implement POEM Issue Enhancement (AC: 8)

- [ ] Update Issue Logger schema to v2.1:
  - [ ] Add optional `reportedBy` array field
  - [ ] Backward compatible (existing issues don't need this field)
- [ ] Update Triage inbox processing to populate `reportedBy`:
  - [ ] When linking submission to existing issue
  - [ ] Extract: `submissionId`, `project`, `timestamp`, `projectSpecificDetails`
  - [ ] Append to `reportedBy` array in POEM issue
- [ ] Update `docs/planning/gap-analysis/usage-issues.schema.json` (if exists)

### Task 6: Create Directory Structures (AC: 3, 10)

- [ ] Create POEM inbox directory:
  - [ ] `docs/planning/gap-analysis/inbox/`
  - [ ] Add `.gitkeep` to track empty directory
- [ ] Update `.gitignore`:
  - [ ] Add `docs/planning/gap-analysis/inbox/*.json`
  - [ ] Inbox files are transient (processed then archived/deleted)
- [ ] Document external project structure in Field Testing Guide:
  - [ ] `docs/field-testing/blockers/`
  - [ ] `docs/field-testing/sessions/`

### Task 7: Create Field Testing Guide (AC: 11)

- [ ] Create `docs/planning/gap-analysis/field-testing-guide.md`:
  - [ ] Overview: Client-server architecture explanation
  - [ ] Field Testing Agent usage instructions
  - [ ] Workflow example: v-voz → log blocker → submit → Triage process
  - [ ] Schema documentation (client blocker, inbox submission, enhanced POEM issue)
  - [ ] Troubleshooting section (common issues, solutions)
  - [ ] Keep concise (~150-200 lines)

### Task 8: Update Triage Guide (AC: 12)

- [ ] Open `docs/workflows/triage-guide.md`
- [ ] Add "Mode E: Inbox Processing" section:
  - [ ] Document `/triage inbox` usage
  - [ ] Example output format
  - [ ] Workflow: list submissions → select → search issues → link or create
- [ ] Add examples:
  - [ ] Linking submission to existing issue
  - [ ] Creating new issue from submission
  - [ ] Multi-project issue enhancement

### Task 9: Manual Testing and Validation (All ACs)

- [ ] Test Field Testing Agent in external project (v-voz)
- [ ] Test Inbox Bridge Skill submission
- [ ] Test Triage inbox processing (Mode E)
- [ ] Test multi-project scenario (2 projects, same issue)
- [ ] Test session logging (`*log-session`)
- [ ] Verify all schemas match documentation
- [ ] Verify directory structures created correctly

## File List

**Files to Create**:
- `packages/poem-core/agents/field-tester.md`
- `.claude/commands/poem/agents/field-tester.md`
- `packages/poem-core/skills/poem-inbox-bridge/SKILL.md`
- `docs/planning/gap-analysis/field-testing-guide.md`
- `docs/planning/gap-analysis/inbox/.gitkeep`

**Files to Modify**:
- `.bmad-core/tasks/triage-work.md`
- `docs/workflows/triage-guide.md`
- `docs/planning/gap-analysis/usage-issues.schema.json` (if exists)
- `.gitignore`

**Directories to Create**:
- `docs/planning/gap-analysis/inbox/`
- External projects: `docs/field-testing/blockers/`, `docs/field-testing/sessions/` (created by Field Testing Agent on first use)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-22 | 0.1 | Story created by Bob (SM) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)

## Knowledge Assets

<!-- Lisa (Librarian) updates this section during knowledge curation -->

**Patterns Created**:
- (None yet)

**Learnings Documented**:
- (None yet)

**Decisions (ADRs)**:
- (None yet)

**Examples Created**:
- (None yet)

**Knowledge Extraction Status**: Not yet curated

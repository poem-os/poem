# Story 2.1 - Acceptance Test Guide

## Quick Summary

**Story**: Configure Astro Server
**Status**: Review
**Test Focus**: Verify Astro server starts reliably with proper logging, health endpoint, graceful shutdown, and error handling

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review"
- [ ] No servers running on port 4321 (run `lsof -i :4321` to check)
- [ ] Dependencies installed (`npm install` in project root)
- [ ] Working directory is `packages/poem-app`

**Environment Setup:**

- Node.js: 22.x LTS
- Default Port: 4321
- Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`

---

## ğŸ§‘ Human Tests (Visual/Manual)

Tests requiring human observation - terminal colors, interactive behavior, visual output.

### Test 1: AC5 - Server logs startup information

**What to test**: Server displays formatted startup message with port, environment, and version

**Steps**:

1. Open terminal in `packages/poem-app` directory
2. Run `npm run dev`
3. Observe terminal output

**Expected Result**:
âœ… Terminal shows colored startup messages:

- Cyan colored "ğŸš€ POEM Server starting..." message
- Port number displayed (e.g., "Port: 4321")
- Environment displayed (e.g., "Environment: development")
- Version displayed (e.g., "Version: 0.1.0")
- Green colored "âœ… Server ready in XXms" message

**Evidence**:

- Screenshot showing colored terminal output
- Startup time shown in milliseconds

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 2: AC6 - Graceful shutdown on SIGINT (Ctrl+C)

**What to test**: Server shuts down gracefully when user presses Ctrl+C

**Steps**:

1. Start server with `npm run dev`
2. Wait for "Server ready" message
3. Press Ctrl+C in terminal

**Expected Result**:
âœ… Terminal shows shutdown messages:

- Yellow colored "âš ï¸ Received SIGINT, shutting down gracefully..." message
- Green colored "âœ… POEM Server stopped" message
- Process exits cleanly (returns to command prompt)

**Evidence**:

- Screenshot showing shutdown messages with colors
- Verify terminal returns to command prompt

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 3: AC7 - Port conflict error with helpful message

**What to test**: When port is in use, server displays helpful error message and exits

**Steps**:

1. Start first server: `npm run dev`
2. Wait for "Server ready" message
3. Open NEW terminal in same directory
4. Try to start second server: `PORT=4321 npm run dev`
5. Observe error output in second terminal

**Expected Result**:
âœ… Second terminal shows:

- Red colored "âŒ Port 4321 is already in use" message
- Helpful suggestions including:
  - "Use a different port: PORT=4322 npm run dev"
  - "Find and stop the process using port 4321"
  - "Use 'lsof -i :4321' to identify the process"
- Process exits with error code (not zero)

**Evidence**:

- Screenshot showing red error message
- Screenshot showing helpful suggestions

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 4: AC4 - Health endpoint in browser

**What to test**: Health endpoint returns JSON when accessed in browser

**Steps**:

1. Start server with `npm run dev`
2. Open browser to http://localhost:4321/api/health
3. Observe JSON response

**Expected Result**:
âœ… Browser displays JSON with:

- `status`: "ok"
- `version`: string (e.g., "0.1.0")
- `uptime`: number (seconds since server started)
- `helpersLoaded`: number (0 for now)

**Evidence**:

- Screenshot of browser showing JSON response
- Refresh page and verify uptime increases

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

## ğŸ¤– Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Server starts with npm run dev

**What to test**: Astro server starts successfully

**Prerequisite**: No server running on port 4321

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npm run dev &
sleep 3
curl -s http://localhost:4321/api/health
pkill -f "astro dev"
```

**Expected Output**:

```json
{"status":"ok","version":"0.1.0","uptime":...,"helpersLoaded":0}
```

**Validation**:

- âœ… Server starts without errors
- âœ… Health endpoint responds
- âœ… Response is valid JSON

**Status**: âœ… Passed

**Notes**: Tested 2025-12-28. Response: `{"status":"ok","version":"0.1.0","uptime":0.005,"helpersLoaded":0}`

---

### Test B: AC2 - PORT environment variable works

**What to test**: Server respects PORT environment variable

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && PORT=4500 npm run dev &
sleep 3
curl -s http://localhost:4500/api/health
pkill -f "astro dev"
```

**Expected Output**:

```json
{"status":"ok","version":"0.1.0","uptime":...,"helpersLoaded":0}
```

**Validation**:

- âœ… Server starts on port 4500
- âœ… Health endpoint responds on new port
- âœ… Default port 4321 is NOT used

**Status**: âœ… Passed

**Notes**: Tested 2025-12-28. Response on port 4500: `{"status":"ok","version":"0.1.0","uptime":0.008,"helpersLoaded":0}`

---

### Test C: AC3 - Server startup time under 3 seconds (NFR2)

**What to test**: Server starts in less than 3 seconds

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npm test 2>&1 | grep "NFR2"
```

**Expected Output**:

```
âœ“ NFR2: Server starts in under 3 seconds
```

**Validation**:

- âœ… NFR2 test passes
- âœ… Startup time is well under 3000ms

**Status**: âœ… Passed

**Notes**: Tested 2025-12-28. NFR2 test passed with 1243ms startup time.

---

### Test D: AC4 - Health endpoint returns all required fields

**What to test**: Health endpoint response matches API specification

**Prerequisite**: Server running on port 4321

**Command**:

```bash
curl -s http://localhost:4321/api/health | python3 -c "import sys,json; d=json.load(sys.stdin); print('status:', d.get('status')); print('version:', d.get('version')); print('uptime:', type(d.get('uptime')).__name__); print('helpersLoaded:', type(d.get('helpersLoaded')).__name__)"
```

**Expected Output**:

```
status: ok
version: 0.1.0
uptime: float
helpersLoaded: int
```

**Validation**:

- âœ… `status` is "ok"
- âœ… `version` is a semver string
- âœ… `uptime` is a number
- âœ… `helpersLoaded` is a number

**Status**: âœ… Passed

**Notes**: Tested 2025-12-28. All fields present and correct types verified.

---

### Test E: All automated tests pass

**What to test**: Full test suite passes

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem && npm test 2>&1
```

**Expected Output**:

```
âœ“ tests/api/health.test.ts (7 tests)
Test Files  1 passed
Tests  7 passed
```

**Validation**:

- âœ… All 7 tests pass
- âœ… No test failures
- âœ… No errors

**Status**: âœ… Passed

**Notes**: Tested 2025-12-28. 7/7 tests passed in 2.71s. NFR2 startup time: 1243ms.

---

## â³ Not Testable Yet

None - all acceptance criteria are testable in this story.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: AC5 - Startup logging with colors
- [ ] Test 2: AC6 - Graceful shutdown (Ctrl+C)
- [ ] Test 3: AC7 - Port conflict error message
- [ ] Test 4: AC4 - Health endpoint in browser

**Terminal Tests:**

- [x] Test A: AC1 - Server starts with npm run dev
- [x] Test B: AC2 - PORT environment variable
- [x] Test C: AC3 - NFR2 startup time
- [x] Test D: AC4 - Health endpoint fields
- [x] Test E: All automated tests pass

**Overall Status**: ğŸ”„ In Progress (Terminal tests complete, Human tests pending)

---

## Troubleshooting

### Issue: Port already in use

**Symptom**: Server fails to start with "Port 4321 is in use"
**Solution**:
```bash
pkill -f "astro dev"
# or
lsof -i :4321 | grep LISTEN | awk '{print $2}' | xargs kill
```

### Issue: Server starts but health endpoint fails

**Symptom**: curl returns connection refused
**Solution**: Wait a few seconds for server to fully initialize, then retry

### Issue: Colors not showing in terminal

**Symptom**: Output shows escape codes like `[36m` instead of colors
**Solution**: Use a terminal that supports ANSI colors (iTerm2, VS Code terminal, etc.)

### Issue: npm run dev not found

**Symptom**: Command not found error
**Solution**:
```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem
npm install
cd packages/poem-app
npm run dev
```

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:

- Human Tests: __ / 4 passed
- Terminal Tests: __ / 5 passed
- Total: __ / 9 passed

**Issues Found**:

1. _________________
2. _________________

**Sign-off**: âœ… Story accepted | âŒ Issues require fixes

---

_Generated by Taylor (SAT Guide Creator) from Story 2.1_

# Story 2.4: Implement Hot-Reload for Helpers

## Status

Done

## Story

**As a** developer,
**I want** helpers to hot-reload when modified,
**so that** I can develop helpers without restarting the server.

## Acceptance Criteria

1. File watcher monitors `src/services/handlebars/helpers/` directory
2. New helper files automatically loaded and registered
3. Modified helper files reloaded without server restart
4. Deleted helper files unregistered from Handlebars
5. Hot-reload logs which helpers were added/modified/removed
6. Syntax errors in helpers logged but don't crash server
7. Hot-reload completes within 1 second of file change

## Tasks / Subtasks

- [x] Task 1: Create HelperWatcher class (AC: 1, 5)
  - [x] Add `chokidar` to `packages/poem-app/package.json` devDependencies (`^3.6.0`)
  - [x] Create `packages/poem-app/src/services/handlebars/watcher.ts`
  - [x] Implement `HelperWatcher` class with `start()` and `stop()` methods
  - [x] Use `chokidar` for cross-platform file watching (NOT native fs.watch)
  - [x] Watch only `.js` files in helpers directory (ignore `.d.ts`, `_` prefixed files)
  - [x] In `stop()` method: clean up all pending debounce timers before closing watcher
  - [x] Export singleton pattern consistent with `HandlebarsService`

- [x] Task 2: Implement helper add detection (AC: 2, 5)
  - [x] Detect new `.js` files added to helpers directory
  - [x] Dynamically import new helper module using `import()` with cache busting
  - [x] Register helper with `HandlebarsService` using existing `registerHelper()` method
  - [x] Log: `[HotReload] âž• Added helper: {name}`

- [x] Task 3: Implement helper modify detection (AC: 3, 5)
  - [x] Detect modifications to existing `.js` helper files
  - [x] Unregister old helper using `unregisterHelper()`
  - [x] Re-import module with cache-busting query string (`?t=${Date.now()}`)
  - [x] Register updated helper with fresh metadata
  - [x] Log: `[HotReload] ðŸ”„ Reloaded helper: {name}`

- [x] Task 4: Implement helper delete detection (AC: 4, 5)
  - [x] Detect deletion of `.js` helper files
  - [x] Unregister helper from `HandlebarsService`
  - [x] Clean up any cached imports
  - [x] Log: `[HotReload] âž– Removed helper: {name}`

- [x] Task 5: Implement error handling for invalid helpers (AC: 6)
  - [x] Wrap dynamic imports in try-catch
  - [x] Log syntax errors with file path and error message
  - [x] Do NOT crash server on invalid helper syntax
  - [x] Do NOT unregister working helper if modified version has errors
  - [x] Log: `[HotReload] âŒ Error loading {name}: {error.message}`

- [x] Task 6: Integrate watcher with server startup
  - [x] Modify server startup to initialize and start `HelperWatcher`
  - [x] Ensure watcher starts AFTER initial helper loading completes
  - [x] Add graceful shutdown of watcher on SIGTERM/SIGINT
  - [x] Log watcher status on startup: `[HotReload] ðŸ‘€ Watching for helper changes...`

- [x] Task 7: Add debouncing for rapid file changes (AC: 7)
  - [x] Implement 100ms debounce to batch rapid changes
  - [x] Prevent duplicate reload events for single save operation
  - [x] Ensure total hot-reload time stays under 1 second

- [x] Task 8: Write unit tests for HelperWatcher (AC: 1-7)
  - [x] Create `packages/poem-app/tests/services/handlebars/watcher.test.ts`
  - [x] Test watcher start/stop lifecycle
  - [x] Test add detection with mock file creation
  - [x] Test modify detection with mock file update
  - [x] Test delete detection with mock file removal
  - [x] Test error handling with invalid syntax
  - [x] Test debouncing behavior
  - [x] Test hot-reload completes within 1 second (NFR)

## Dev Notes

### Out of Scope (Future Story)

**Health endpoint watcher status:** Adding `watcherActive` and `lastHotReloadTimestamp` to `/api/health` is a useful enhancement but not required by any AC. Defer to a future story focused on observability improvements.

**Dev vs Production mode:** See [kdd/learnings/hot-reload-production-mode.md](../kdd/learnings/hot-reload-production-mode.md) for consideration about disabling hot-reload in production builds. Current implementation enables hot-reload in all modes. Can be addressed in future story if performance concerns arise.

### Previous Story Insights

[Source: Story 2.3 Completion Notes]

Story 2.3 established the helper infrastructure:
- Helpers use ESM (`export default`) for Vite compatibility
- Loader uses `import.meta.glob('./helpers/*.js', { eager: true })` for static imports
- Each helper has `.description` and `.example` metadata properties
- `HandlebarsService.registerHelper(name, fn, metadata)` and `unregisterHelper(name)` methods exist
- Helper files are in `packages/poem-app/src/services/handlebars/helpers/`
- 6 helpers currently exist: dateFormat, default, json, lowerCase, titleCase, upperCase

**Key Challenge:** The current loader uses `import.meta.glob` which is resolved at build time. Hot-reload requires runtime dynamic imports, which will need a different approach than the static loader.

### File Locations

[Source: architecture/unified-project-structure.md]

```
packages/poem-app/
â”œâ”€â”€ src/services/handlebars/
â”‚   â”œâ”€â”€ index.ts           â† HandlebarsService (existing)
â”‚   â”œâ”€â”€ loader.ts          â† Static loader (existing, uses import.meta.glob)
â”‚   â”œâ”€â”€ watcher.ts         â† CREATE: HelperWatcher class
â”‚   â””â”€â”€ helpers/           â† Watch this directory
â”‚       â”œâ”€â”€ *.js           â† Helper files to watch
â”‚       â””â”€â”€ *.d.ts         â† Type declarations (ignore in watcher)
â”‚
â””â”€â”€ tests/services/handlebars/
    â””â”€â”€ watcher.test.ts    â† CREATE: Watcher tests
```

### Technical Approach

[Source: architecture/coding-standards.md#helper-hot-reload-safety]

**Critical Rule:** "New helpers must be valid JavaScript modules. Invalid syntax must not crash the server â€” log and skip."

**Dynamic Import Pattern for Hot-Reload:**
```typescript
// Cache-busting for re-imports
const modulePath = `./helpers/${name}.js?t=${Date.now()}`;
const helperModule = await import(modulePath);
const helperFn = helperModule.default;
```

**File Watcher Decision: Use chokidar**

Use `chokidar` (not Node.js native `fs.watch`) for cross-platform reliability:
- Native `fs.watch` has platform-specific quirks (macOS FSEvents issues, Linux inotify limits)
- `chokidar` is battle-tested, used by Vite/webpack/nodemon
- Already common in Vite ecosystem

**Required:** Add `chokidar` to `packages/poem-app/package.json` devDependencies:
```bash
npm install chokidar --save-dev
```

Version: Use latest 3.x (e.g., `"chokidar": "^3.6.0"`).

### HandlebarsService API

[Source: packages/poem-app/src/services/handlebars/index.ts]

```typescript
// Get singleton service instance
import { getHandlebarsService } from './index.js';
const service = getHandlebarsService();

// Register a helper
service.registerHelper(name: string, fn: HelperFunction, info?: { description, example }): void

// Unregister a helper
service.unregisterHelper(name: string): void

// Check if helper exists
service.hasHelper(name: string): boolean

// Get helper count
service.getHelperCount(): number
```

### Loader API

[Source: packages/poem-app/src/services/handlebars/loader.ts]

```typescript
// Get helpers directory path
import { getHelpersDirectory } from './loader.js';
const helpersDir = getHelpersDirectory();
// Returns: absolute path to packages/poem-app/src/services/handlebars/helpers/
```

### Testing Standards

[Source: architecture/testing-strategy.md]

**Test file location:** `packages/poem-app/tests/services/handlebars/watcher.test.ts`

**Coverage target:** 90% for Handlebars Service (watcher is part of this)

**Test pattern:**
```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { HelperWatcher } from '../../../src/services/handlebars/watcher';
import { getHandlebarsService, resetHandlebarsService } from '../../../src/services/handlebars';
import * as fs from 'node:fs/promises';
import * as path from 'node:path';

describe('HelperWatcher', () => {
  let watcher: HelperWatcher;

  beforeEach(() => {
    resetHandlebarsService();
    watcher = new HelperWatcher(getHandlebarsService());
  });

  afterEach(async () => {
    await watcher.stop();
  });

  it('should detect new helper files', async () => {
    await watcher.start();
    // Create test helper file
    // Assert helper gets registered
  });

  // ... more tests
});
```

### Debouncing Implementation

[Source: No specific guidance - general best practice]

Use a Map to track pending reload operations with setTimeout:

```typescript
private pendingReloads = new Map<string, NodeJS.Timeout>();

private scheduleReload(name: string, action: () => void) {
  // Clear existing timer if any
  const existing = this.pendingReloads.get(name);
  if (existing) clearTimeout(existing);

  // Schedule new reload in 100ms
  const timer = setTimeout(() => {
    this.pendingReloads.delete(name);
    action();
  }, 100);

  this.pendingReloads.set(name, timer);
}

// IMPORTANT: Clean up timers in stop() method
async stop(): Promise<void> {
  // Clear all pending debounce timers
  for (const timer of this.pendingReloads.values()) {
    clearTimeout(timer);
  }
  this.pendingReloads.clear();

  // Then close the watcher
  await this.watcher?.close();
}
```

### Server Integration Points

[Source: Inferred from Story 2.1/2.2 patterns]

The watcher should integrate with server startup after `loadHelpers()` completes:

```typescript
// In server startup sequence:
const service = initHandlebarsService();
await loadHelpers(service);  // Existing static load
const watcher = new HelperWatcher(service);
await watcher.start();  // Start watching for changes
```

Graceful shutdown should call `watcher.stop()` before server closes.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-29 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-29 | 0.2 | PO validation: chokidar decision finalized, Task 9 moved out of scope, debounce timer cleanup added | Sarah (PO Agent) |
| 2025-12-29 | 0.3 | Status changed to Ready | Sarah (PO Agent) |
| 2025-12-29 | 0.4 | Implementation complete, all tests passing | James (Dev Agent) |
| 2025-12-29 | 0.5 | DoD checklist passed, status set to Review | James (Dev Agent) |
| 2025-12-29 | 0.6 | QA review PASS, status set to Done | Quinn (QA Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None required - implementation proceeded without blockers.

### Completion Notes List

1. **chokidar Integration:** Added chokidar ^3.6.0 for cross-platform file watching. Used chokidar's glob pattern support to watch only `.js` files while ignoring `.d.ts` and `_` prefixed files.

2. **Dynamic Import Cache-Busting:** Implemented `pathToFileURL()` with query string `?t=${Date.now()}` for cache-busting on re-imports. Note: This works in Vite dev mode but Node.js ESM caching in Vitest prevents testing actual content changes. Tests verify the reload workflow (unregister/register) instead.

3. **Singleton Pattern:** Followed `HandlebarsService` pattern with `getHelperWatcher()` and `resetHelperWatcher()` exports.

4. **Graceful Shutdown:** Integrated watcher stop into server shutdown handlers. Debounce timer cleanup happens in `stop()` before closing watcher.

5. **Test Suite:** 18 comprehensive tests covering lifecycle, add/modify/delete detection, error handling, debouncing, performance (NFR), and file filtering.

6. **Pre-existing Flaky Test:** NFR2 server startup test in `health.test.ts` fails intermittently - documented in maintenance backlog, not related to this story.

### File List

**Created:**
- `packages/poem-app/src/services/handlebars/watcher.ts` - HelperWatcher class implementation
- `packages/poem-app/tests/services/handlebars/watcher.test.ts` - 18 unit tests

**Modified:**
- `packages/poem-app/package.json` - Added chokidar ^3.6.0 to devDependencies
- `packages/poem-app/src/integrations/poem-server.ts` - Integrated watcher startup
- `packages/poem-app/src/services/server/index.ts` - Added watcher shutdown to graceful shutdown handlers

---

## QA Results

### Review Date: 2025-12-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of the hot-reload system. The code demonstrates:
- **Clean architecture**: Clear separation between watcher lifecycle, debouncing, and reload execution
- **Robust error handling**: Syntax errors are caught and logged without crashing the server; working helpers are preserved when modified versions fail
- **Cross-platform reliability**: Uses chokidar instead of native fs.watch for consistent behavior
- **ESM compatibility**: Proper use of `pathToFileURL()` with cache-busting query strings for dynamic imports
- **Consistent patterns**: Follows existing singleton pattern from HandlebarsService

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: âœ“ Follows helper hot-reload safety rule (invalid syntax logs and skips, doesn't crash)
- Project Structure: âœ“ Files in correct locations (watcher.ts in services/handlebars, tests in tests/services/handlebars)
- Testing Strategy: âœ“ 18 unit tests with vitest, comprehensive coverage of all ACs
- All ACs Met: âœ“ All 7 acceptance criteria fully implemented and tested

### Requirements Traceability

| AC | Description | Test Coverage |
|----|-------------|---------------|
| AC1 | File watcher monitors helpers directory | Lifecycle tests (start/stop), integration with poem-server.ts |
| AC2 | New helpers loaded and registered | Add Detection tests (2 tests) |
| AC3 | Modified helpers reloaded | Modify Detection tests (1 test with workflow verification) |
| AC4 | Deleted helpers unregistered | Delete Detection tests (1 test) |
| AC5 | Hot-reload logs actions | Verified in all Add/Modify/Delete tests via console output |
| AC6 | Syntax errors don't crash server | Error Handling tests (2 tests: crash prevention, helper preservation) |
| AC7 | Hot-reload under 1 second | Performance NFR test (verified < 1000ms) |

### Improvements Checklist

All items handled appropriately:

- [x] Debounce timer cleanup in stop() method prevents timer leaks
- [x] Error handling preserves working helpers when modifications fail
- [x] ESM cache-busting with timestamp query string
- [x] File filtering correctly ignores `_` prefixed and `.d.ts` files
- [x] Graceful shutdown integrated with server lifecycle
- [x] Test modification detection verifies workflow (unregister/register) rather than content change (ESM caching limitation documented)

### Security Review

No security concerns. File operations are constrained to the helpers directory. No user input is processed in a way that could lead to path traversal or injection.

### Performance Considerations

- **100ms debounce**: Prevents excessive reloads from rapid editor saves
- **Hot-reload timing**: Tests verify completion under 1 second (typical: 2-10ms)
- **Minimal overhead**: Watcher uses chokidar's efficient event system

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** â†’ docs/qa/gates/2.4-hot-reload-helpers.yml

### Recommended Status

âœ“ **Ready for Done** - All acceptance criteria met, tests passing, code follows standards.

---

## Knowledge Assets

<!-- Lisa (Librarian) updates this section during knowledge curation -->

**Patterns Created**:
- (None in this story)

**Learnings Documented**:
- [Hot-Reload: Development vs Production Mode Consideration](../kdd/learnings/hot-reload-production-mode.md)

**Decisions (ADRs)**:
- (None in this story)

**Examples Created**:
- (None in this story)

**Knowledge Extraction Status**: Curated on 2026-01-22

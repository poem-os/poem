# Story 2.2: Implement Handlebars Service

## Status

Done

## Story

**As a** developer,
**I want** a Handlebars service that compiles and renders templates,
**so that** API endpoints can process `.hbs` files.

## Acceptance Criteria

1. Handlebars service initializes on server start
2. Service loads helpers from `src/services/handlebars/helpers/` directory
3. Eager loading of all helpers during initialization
4. Service exposes `compile(template)` and `render(compiled, data)` methods
5. Template compilation errors return helpful messages with line numbers
6. Service handles missing placeholders gracefully (empty string or configurable)
7. Performance: render typical template (< 5KB) in under 100ms

## Tasks / Subtasks

- [x] Task 1: Create Handlebars Service module (AC: 1, 4)
  - [x] Create `src/services/handlebars/index.ts` with HandlebarsService class
  - [x] Implement `compile(template: string): CompiledTemplate` method
  - [x] Implement `render(template: string, data: object): string` convenience method
  - [x] Implement `registerHelper(name: string, fn: Function): void` method
  - [x] Export service instance and types

- [x] Task 2: Implement helper loading system (AC: 2, 3)
  - [x] Create `src/services/handlebars/loader.ts` for helper discovery
  - [x] Scan `src/services/handlebars/helpers/` directory for `.js` files
  - [x] Load and register each helper file with Handlebars
  - [x] Track loaded helpers count for health endpoint
  - [x] Log loaded helpers on initialization

- [x] Task 3: Integrate service with server startup (AC: 1)
  - [x] Initialize HandlebarsService in `src/integrations/poem-server.ts`
  - [x] Expose helper count via server lifecycle for health endpoint
  - [x] Update health endpoint to return actual `helpersLoaded` count

- [x] Task 4: Implement error handling for compilation (AC: 5)
  - [x] Catch Handlebars compilation errors
  - [x] Extract line number and column from error
  - [x] Return helpful error message with template location context
  - [x] Include snippet of template around error location

- [x] Task 5: Implement graceful missing placeholder handling (AC: 6)
  - [x] Configure Handlebars to not throw on missing properties
  - [x] Return empty string for missing placeholders by default
  - [x] Add optional strict mode configuration
  - [x] Track and report missing placeholders as warnings

- [x] Task 6: Write unit tests for Handlebars service (AC: 4, 5, 6, 7)
  - [x] Test compile with valid template
  - [x] Test compile with invalid syntax (error handling)
  - [x] Test render with complete data
  - [x] Test render with nested data (`{{user.name}}`)
  - [x] Test render with missing data (graceful degradation)
  - [x] Test render performance (< 100ms for 5KB template)
  - [x] Test helper registration and usage

## Dev Notes

### Previous Story Insights

[Source: Story 2.1 Completion Notes]

Story 2.1 established server lifecycle infrastructure:
- Server lifecycle service at `src/services/server/index.ts` tracks uptime
- Astro integration at `src/integrations/poem-server.ts` handles startup/shutdown hooks
- Health endpoint returns `helpersLoaded: 0` - this story needs to update with real count
- Config service at `src/config/index.ts` provides version and environment info
- Vitest is configured with `packages/poem-app/vitest.config.ts`

**Key files from 2.1:**
- `packages/poem-app/src/services/server/index.ts` - Server lifecycle utilities
- `packages/poem-app/src/integrations/poem-server.ts` - Astro integration hooks
- `packages/poem-app/src/pages/api/health.ts` - Health endpoint (needs helpersLoaded update)

### Handlebars Service Component

[Source: architecture/components.md#component-handlebars-service-poem-app]

**Responsibility:** Compile Handlebars templates, register helpers, render with data.

**Key Interfaces:**
- `compile(template: string): CompiledTemplate`
- `render(compiled: CompiledTemplate, data: object): string`
- `registerHelper(name: string, fn: Function): void`
- `extractPlaceholders(template: string): PlaceholderInfo[]` (for later stories)

**Initialization:**
1. Server starts
2. Scan `src/services/handlebars/helpers/` directory
3. Load and register all `.js` helper files
4. Watch directory for hot-reload (Story 2.4 - not this story)

### Project Structure

[Source: architecture/unified-project-structure.md]

```
packages/poem-app/
├── src/
│   ├── services/
│   │   └── handlebars/
│   │       ├── index.ts          ← Create: Main service
│   │       ├── loader.ts         ← Create: Helper loader
│   │       └── helpers/          ← Directory for helper files
│   │           └── README.md     ← Create: Helper documentation
│   │
│   ├── integrations/
│   │   └── poem-server.ts        ← Modify: Initialize Handlebars service
│   │
│   └── pages/api/
│       └── health.ts             ← Modify: Return actual helper count
│
└── tests/
    └── services/
        └── handlebars/
            └── service.test.ts   ← Create: Unit tests
```

### Tech Stack

[Source: architecture/tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| Handlebars.js | 4.7.x | Compile and render .hbs templates |
| TypeScript | 5.9.x | Type-safe server code |
| Vitest | 4.x | Unit/integration testing |

**Note:** Handlebars.js should already be installed from Story 1.3. Verify with `npm list handlebars` in `packages/poem-app/`.

### Coding Standards

[Source: architecture/coding-standards.md]

**TypeScript Standards:**
```typescript
// ✅ DO: Use explicit types for API responses
interface RenderResponse {
  rendered: string;
  renderTimeMs: number;
  warnings: string[];
}

// ✅ DO: Use Result types for operations that can fail
type Result<T> = { success: true; data: T } | { success: false; error: string };
```

**Graceful Degradation Rule:**
- Missing template placeholders render as empty string (not error)
- Missing helpers log warning but render template

**Service Naming:**
- Services use PascalCase classes: `HandlebarsService`
- Helpers use camelCase files: `titleCase.js`, `formatTimestamp.js`

### Error Handling

[Source: architecture/coding-standards.md#error-handling-strategy]

Template compilation errors must include:
- Error type
- Error message
- Template path or identifier
- Line number and column (if available)
- Snippet of template around error location

Example error format:
```typescript
{
  success: false,
  error: "Template compilation failed",
  details: {
    type: "ParseError",
    message: "Expecting 'ID', 'STRING', 'NUMBER', got 'INVALID'",
    line: 5,
    column: 12,
    snippet: "{{#if user}\n{{name}\n^--- error here"
  }
}
```

### API Integration

[Source: architecture/api-specification.md]

The `/api/helpers` endpoint (Story 2.3+) will need:
```json
{
  "helpers": [
    {
      "name": "titleCase",
      "description": "Convert string to title case",
      "example": "{{titleCase \"hello world\"}} → \"Hello World\""
    }
  ]
}
```

The health endpoint needs `helpersLoaded` to return actual count from service.

### Testing

[Source: architecture/testing-strategy.md]

**Test file location:** `packages/poem-app/tests/services/handlebars/service.test.ts`

**Coverage target:** 90% for Handlebars Service

**Test patterns from architecture:**
```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { HandlebarsService } from '../../../src/services/handlebars';

describe('HandlebarsService', () => {
  let service: HandlebarsService;

  beforeEach(() => {
    service = new HandlebarsService();
  });

  describe('compile', () => {
    it('should compile a simple template', () => {
      const template = 'Hello {{name}}';
      const compiled = service.compile(template);
      expect(compiled).toBeDefined();
    });

    it('should throw on invalid syntax', () => {
      const template = 'Hello {{name}'; // Missing closing
      expect(() => service.compile(template)).toThrow();
    });
  });

  describe('render', () => {
    it('should render template with data', () => {
      const template = 'Hello {{name}}';
      const result = service.render(template, { name: 'World' });
      expect(result).toBe('Hello World');
    });

    it('should handle missing data gracefully', () => {
      const template = 'Hello {{name}}';
      const result = service.render(template, {});
      expect(result).toBe('Hello ');
    });
  });
});
```

**Performance test (NFR - 100ms for 5KB template):**
```typescript
it('should render 5KB template in under 100ms', async () => {
  const largeTemplate = generateLargeTemplate(5000); // 5KB
  const data = generateTestData();

  const start = Date.now();
  service.render(largeTemplate, data);
  const elapsed = Date.now() - start;

  expect(elapsed).toBeLessThan(100);
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-28 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-28 | 1.0 | Implementation complete | James (Dev Agent) |
| 2025-12-28 | 1.1 | QA Review PASS, Story Done | Quinn (QA Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered during implementation.

### Completion Notes List

- Task 1: Created HandlebarsService class with compile(), render(), renderWithWarnings(), registerHelper() methods. Uses isolated Handlebars instance via Handlebars.create().
- Task 2: Created loader.ts that scans helpers/ directory for .js files and registers them. Logs loaded/failed helpers.
- Task 3: Integrated with poem-server.ts Astro integration. Added setHelpersLoadedCount() to server lifecycle service.
- Task 4: Error handling via CompileResult type with details (type, message, line, column, snippet). Handlebars is lenient at compile time - most errors surface at runtime.
- Task 5: Default strict=false allows missing placeholders to render as empty string. renderWithWarnings() tracks missing fields.
- Task 6: 31 unit tests covering compile, render, helpers, singleton, strict mode, and performance (5KB template < 100ms).
- ESLint: 0 errors, 1 intentional warning (_context unused param in health.ts)
- All 38 tests passing (31 handlebars + 7 health endpoint)

### File List

**Created:**
- `packages/poem-app/src/services/handlebars/index.ts` - Main HandlebarsService class with compile, render, helper management
- `packages/poem-app/src/services/handlebars/loader.ts` - Helper discovery and loading from helpers/ directory
- `packages/poem-app/src/services/handlebars/helpers/README.md` - Documentation for creating helpers
- `packages/poem-app/tests/services/handlebars/service.test.ts` - 31 unit tests for HandlebarsService

**Modified:**
- `packages/poem-app/src/integrations/poem-server.ts` - Added Handlebars service initialization on startup
- `packages/poem-app/src/services/server/index.ts` - Added setHelpersLoadedCount() function, updated getHelpersLoadedCount()

---

## QA Results

### Review Date: 2025-12-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The HandlebarsService follows clean architecture principles with:
- Isolated Handlebars instance via `Handlebars.create()` preventing global state pollution
- Result type pattern (`CompileResult`) for operations that can fail
- Comprehensive TypeScript typing with explicit interfaces
- Well-documented JSDoc comments on all public methods
- Singleton pattern with `init/get/reset` functions for testability

### Refactoring Performed

None required - code quality is high.

### Compliance Check

- Coding Standards: ✓ Follows TypeScript standards, naming conventions, error handling patterns
- Project Structure: ✓ Files in correct locations per unified-project-structure.md
- Testing Strategy: ✓ 31 unit tests with Vitest, 90%+ coverage target met
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and tested

### Improvements Checklist

All items handled by implementation:

- [x] HandlebarsService with compile/render methods (AC4)
- [x] Helper loading from directory (AC2, AC3)
- [x] Server startup integration (AC1)
- [x] Error handling with line numbers (AC5)
- [x] Graceful missing placeholder handling (AC6)
- [x] Performance validation < 100ms (AC7)
- [x] Comprehensive unit tests (31 tests)

Future considerations (non-blocking):
- [ ] Consider dedicated unit tests for loader.ts (currently tested via integration)
- [ ] Consider exposing extractPlaceholders() publicly for future API needs

### Security Review

No concerns. The service:
- Does not handle external user input directly
- Loads helpers only from a fixed internal directory
- Uses isolated Handlebars instance

### Performance Considerations

Validated by test suite:
- 5KB template renders in < 100ms (AC7)
- 1000 consecutive renders complete in < 1000ms total
- Handlebars.create() provides instance isolation without significant overhead

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-handlebars-service.yml
Quality Score: 100/100

### Recommended Status

✓ Ready for Done

Story meets all acceptance criteria with comprehensive test coverage and clean implementation.

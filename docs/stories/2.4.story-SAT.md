# Story 2.4 - Acceptance Test Guide

## Quick Summary

**Story**: Implement Hot-Reload for Helpers
**Status**: Review
**Test Focus**: Verify helpers can be added, modified, and deleted without server restart, with proper logging and error handling.

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review" or "Complete"
- [ ] Server is NOT running (we'll start it fresh)
- [ ] Dependencies installed (`cd packages/poem-app && npm install`)
- [ ] Working in the poem-app package directory

**Environment Setup:**

- Node.js: 22.x LTS
- Port: 4321 (default Astro dev server)
- Working directory: `packages/poem-app`

---

## ğŸ§‘ Human Tests (Visual/Manual)

Tests requiring human observation - terminal output, log colors, server behavior.

### Test 1: AC1 - File watcher starts on server startup

**What to test**: File watcher monitors `src/services/handlebars/helpers/` directory

**Steps**:

1. Open terminal in `packages/poem-app` directory
2. Run `npm run dev`
3. Observe terminal output during startup

**Expected Result**:
âœ… Terminal shows watcher startup message:
- Cyan colored log: `[HotReload] ğŸ‘€ Watching for helper changes in .../helpers`
- Message appears AFTER helper loading messages
- Server continues to run normally

**Evidence**:
- Terminal screenshot showing the cyan `[HotReload]` message
- Watcher message appears after "Loaded X helper(s)" message

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 2: AC2, AC5 - New helper automatically loaded

**What to test**: New helper files automatically loaded and registered with logging

**Steps**:

1. Ensure server is running (`npm run dev`)
2. Open a new terminal in `packages/poem-app`
3. Create a new helper file:
   ```bash
   cat > src/services/handlebars/helpers/testHotReload.js << 'EOF'
   function testHotReload(str) {
     return 'HOT_' + str;
   }
   testHotReload.description = 'Test hot reload helper';
   testHotReload.example = '{{testHotReload "test"}}';
   export default testHotReload;
   EOF
   ```
4. Observe the terminal where server is running

**Expected Result**:
âœ… Terminal shows helper added:
- Green colored log: `[HotReload] â• Added helper: testHotReload (Xms)`
- Time shown should be under 1000ms
- No errors or crashes

**Evidence**:
- Terminal screenshot showing green "Added helper" message
- Timestamp shows quick reload (typically 2-10ms)

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 3: AC3, AC5 - Modified helper reloaded

**What to test**: Modified helper files reloaded without server restart with logging

**Steps**:

1. Ensure server is running and `testHotReload.js` exists from Test 2
2. Modify the helper file:
   ```bash
   cat > src/services/handlebars/helpers/testHotReload.js << 'EOF'
   function testHotReload(str) {
     return 'MODIFIED_' + str;
   }
   testHotReload.description = 'Modified test helper';
   testHotReload.example = '{{testHotReload "test"}}';
   export default testHotReload;
   EOF
   ```
3. Observe the terminal where server is running

**Expected Result**:
âœ… Terminal shows helper reloaded:
- Green colored log: `[HotReload] ğŸ”„ Reloaded helper: testHotReload (Xms)`
- Server continues running (no restart required)
- No errors

**Evidence**:
- Terminal screenshot showing green "Reloaded helper" message
- Server uptime continues (no restart message)

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 4: AC4, AC5 - Deleted helper unregistered

**What to test**: Deleted helper files unregistered from Handlebars with logging

**Steps**:

1. Ensure server is running and `testHotReload.js` exists
2. Delete the helper file:
   ```bash
   rm src/services/handlebars/helpers/testHotReload.js
   ```
3. Observe the terminal where server is running

**Expected Result**:
âœ… Terminal shows helper removed:
- Yellow colored log: `[HotReload] â– Removed helper: testHotReload`
- Server continues running
- No errors or crashes

**Evidence**:
- Terminal screenshot showing yellow "Removed helper" message
- Server remains operational

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 5: AC6 - Syntax errors don't crash server

**What to test**: Syntax errors in helpers logged but don't crash server

**Steps**:

1. Ensure server is running
2. Create a helper with invalid syntax:
   ```bash
   cat > src/services/handlebars/helpers/badHelper.js << 'EOF'
   // Invalid syntax - missing function body
   export default function
   EOF
   ```
3. Observe the terminal where server is running

**Expected Result**:
âœ… Terminal shows error but server continues:
- Red colored log: `[HotReload] âŒ Error loading badHelper: ...`
- Error message includes parse error details
- Server does NOT crash or restart
- Server continues to respond to requests

**Evidence**:
- Terminal screenshot showing red error message
- Verify server still running with `curl http://localhost:4321/api/health`

**Cleanup**:
```bash
rm src/services/handlebars/helpers/badHelper.js
```

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 6: AC6 - Working helper preserved on error

**What to test**: Do NOT unregister working helper if modified version has errors

**Steps**:

1. Ensure server is running
2. Create a valid helper:
   ```bash
   cat > src/services/handlebars/helpers/preserveTest.js << 'EOF'
   function preserveTest(str) {
     return 'VALID_' + str;
   }
   preserveTest.description = 'Test preservation';
   export default preserveTest;
   EOF
   ```
3. Wait for "Added helper" message
4. Modify with invalid syntax:
   ```bash
   cat > src/services/handlebars/helpers/preserveTest.js << 'EOF'
   // Invalid - broken syntax
   function preserveTest(
   EOF
   ```
5. Observe terminal

**Expected Result**:
âœ… Error logged but helper preserved:
- Red error message appears for parse failure
- Helper `preserveTest` is NOT removed from registry
- Server continues running

**Cleanup**:
```bash
rm src/services/handlebars/helpers/preserveTest.js
```

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 7: AC7 - Hot-reload under 1 second

**What to test**: Hot-reload completes within 1 second of file change

**Steps**:

1. Ensure server is running
2. Observe the timing in any Add/Reload message from previous tests
3. Alternatively, create a new helper and note the "(Xms)" timing

**Expected Result**:
âœ… Timing shown is under 1000ms:
- Typical values: 2-10ms for local file operations
- Maximum acceptable: 999ms

**Evidence**:
- Note the timing values from previous test screenshots
- All should show values well under 1000ms

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

## ğŸ¤– Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Verify chokidar installed

**What to test**: chokidar dependency is installed

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && grep -A1 '"chokidar"' package.json
```

**Expected Output**:

```
    "chokidar": "^3.6.0",
```

**Validation**:

- âœ… chokidar listed in devDependencies
- âœ… Version is ^3.6.0 or higher

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test B: Verify watcher.ts exists

**What to test**: HelperWatcher implementation file exists

**Command**:

```bash
ls -la /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/src/services/handlebars/watcher.ts
```

**Expected Output**:

```
-rw------- 1 ... watcher.ts
```

**Validation**:

- âœ… File exists
- âœ… File has content (non-zero size)

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test C: Verify tests exist and pass

**What to test**: Unit tests for HelperWatcher exist and pass

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npx vitest run tests/services/handlebars/watcher.test.ts 2>&1 | tail -20
```

**Expected Output** (last lines):

```
 âœ“ tests/services/handlebars/watcher.test.ts (18 tests)

 Test Files  1 passed (1)
      Tests  18 passed (18)
```

**Validation**:

- âœ… All 18 tests pass
- âœ… No test failures

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test D: Verify server integration

**What to test**: Watcher is integrated into poem-server.ts

**Command**:

```bash
grep -n "getHelperWatcher\|watcher" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/src/integrations/poem-server.ts
```

**Expected Output** (should show import and usage):

```
5:import { getHelperWatcher } from '../services/handlebars/watcher.js';
...
28:        const watcher = getHelperWatcher(handlebarsService);
29:        await watcher.start();
```

**Validation**:

- âœ… getHelperWatcher imported
- âœ… Watcher started after helpers loaded

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test E: Verify graceful shutdown integration

**What to test**: Watcher shutdown in server lifecycle

**Command**:

```bash
grep -n "resetHelperWatcher" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/src/services/server/index.ts
```

**Expected Output**:

```
7:import { resetHelperWatcher } from '../handlebars/watcher.js';
...
92:    await resetHelperWatcher();
```

**Validation**:

- âœ… resetHelperWatcher imported
- âœ… Called during shutdown

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

## â³ Not Testable Yet

**None** - All acceptance criteria are testable in current implementation.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: Watcher starts on server startup (AC1)
- [ ] Test 2: New helper automatically loaded (AC2, AC5)
- [ ] Test 3: Modified helper reloaded (AC3, AC5)
- [ ] Test 4: Deleted helper unregistered (AC4, AC5)
- [ ] Test 5: Syntax errors don't crash server (AC6)
- [ ] Test 6: Working helper preserved on error (AC6)
- [ ] Test 7: Hot-reload under 1 second (AC7)

**Terminal Tests:**

- [ ] Test A: chokidar dependency installed
- [ ] Test B: watcher.ts file exists
- [ ] Test C: All 18 unit tests pass
- [ ] Test D: Server integration verified
- [ ] Test E: Graceful shutdown integration

**Overall Status**: â¬œ Not Started | ğŸ”„ In Progress | âœ… All Passed | âŒ Issues Found

---

## Troubleshooting

### Issue: Server won't start

**Symptom**: `npm run dev` fails or hangs
**Solution**:
- Check if port 4321 is in use: `lsof -i :4321`
- Kill existing process: `kill -9 <PID>`
- Try different port: `PORT=4322 npm run dev`

### Issue: Hot-reload message not appearing

**Symptom**: File created but no log message
**Solution**:
- Ensure file is in correct directory (`src/services/handlebars/helpers/`)
- Ensure file ends with `.js` extension
- Ensure file does NOT start with `_` (underscore files are ignored)
- Wait 100-200ms (debouncing)

### Issue: Colors not showing in terminal

**Symptom**: Log messages appear but without colors
**Solution**:
- Use terminal that supports ANSI colors
- Check `TERM` environment variable is set
- Try different terminal emulator

### Issue: "Module not found" error

**Symptom**: Error loading helper module
**Solution**:
- Ensure helper uses `export default` (ESM format)
- Check file syntax is valid JavaScript
- Verify file was saved completely

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:

- Human Tests: __ / 7 passed
- Terminal Tests: __ / 5 passed
- Total: __ / 12 passed

**Issues Found**:

1. _________________
2. _________________

**Sign-off**: âœ… Story accepted | âŒ Issues require fixes

---

_Generated by Taylor (SAT Guide Creator) from Story 2.4_

# Story 3.2.5: Implement Dev Workspace Separation & Config Source-of-Truth

## Status

Ready for Review

## Story

**As a** POEM framework developer,
**I want** user-generated content isolated in `dev-workspace/` AND workspace paths defined in a single source of truth (config),
**so that** test content doesn't pollute source code, and future workflows automatically inherit correct paths without duplication.

## Acceptance Criteria

1. Development mode uses `dev-workspace/` for user content, not root-level directories
2. `dev-workspace/prompts/`, `dev-workspace/schemas/`, `dev-workspace/mock-data/` created by dev-setup.sh
3. `dev-workspace/` added to `.gitignore`
4. Config service is the single source of truth for workspace paths
5. Production mode continues using `poem/prompts/`, `poem/schemas/`, `poem/mock-data/`
6. Workflows do NOT duplicate path definitions - they reference config or use agent path resolution
7. `new-prompt.yaml` updated to remove hardcoded paths section
8. Existing root-level `prompts/`, `schemas/`, `mock-data/` directories removed
9. `prompts/test/hello.hbs` moved to `packages/poem-app/tests/fixtures/prompts/`
10. All existing tests pass with the new path structure
11. Pattern documented so future workflows (refine, test, validate) follow it automatically
12. CLAUDE.md updated with dev workspace and config source-of-truth documentation

## Tasks / Subtasks

- [x] Task 1: Audit and Relocate Test Fixtures (AC: 8, 9)
  - [x] Move `prompts/test/hello.hbs` to `packages/poem-app/tests/fixtures/prompts/hello.hbs`
  - [x] Create `packages/poem-app/tests/fixtures/prompts/` directory
  - [x] Delete `prompts/` directory from root
  - [x] Delete `schemas/` directory from root
  - [x] Delete `mock-data/` directory from root
  - [x] Document in completion notes what was moved/deleted
  - **Note:** Test path references and assertions are updated in Tasks 8-9, not here

- [x] Task 2: Create Dev Workspace Directory Structure (AC: 2, 3)
  - [x] Create `dev-workspace/` directory at monorepo root
  - [x] Create subdirectories: `prompts/`, `schemas/`, `mock-data/`, `config/`, `workflow-data/`
  - [x] Add `dev-workspace/` to `.gitignore`
  - [x] Add README.md in dev-workspace explaining its purpose

- [x] Task 3: Update POEM Config Service - Single Source of Truth (AC: 1, 4, 5)
  - [x] Modify `packages/poem-app/src/services/config/poem-config.ts`
  - [x] Update development mode defaults:
    ```typescript
    const DEV_DEFAULTS: WorkspacePaths = {
      prompts: 'dev-workspace/prompts',
      schemas: 'dev-workspace/schemas',
      mockData: 'dev-workspace/mock-data',
      config: 'dev-workspace/config',
      workflowData: 'dev-workspace/workflow-data'
    };
    ```
  - [x] Keep production defaults unchanged (`poem/prompts/`, etc.)
  - [x] Add JSDoc comment: "Config service is the single source of truth for workspace paths"
  - [x] Verify `resolvePath()` and `resolvePathAsync()` return correct paths

- [x] Task 4: Update poem-core-config.yaml (AC: 4)
  - [x] Modify `packages/poem-core/poem-core-config.yaml`
  - [x] Update workspace paths:
    ```yaml
    # Workspace directories - SINGLE SOURCE OF TRUTH
    # These paths are read by the config service.
    # Workflows should NOT duplicate these - they inherit from config.
    workspace:
      prompts: dev-workspace/prompts
      schemas: dev-workspace/schemas
      mockData: dev-workspace/mock-data
      config: dev-workspace/config
      workflowData: dev-workspace/workflow-data
    ```
  - [x] Add prominent comment about single source of truth

- [x] Task 5: Remove Path Duplication from new-prompt.yaml (AC: 6, 7)
  - [x] Modify `packages/poem-core/workflows/new-prompt.yaml`
  - [x] Remove the `paths:` section (lines 24-32) entirely
  - [x] Update `instruction:` blocks that reference paths to say:
    ```yaml
    instruction: |
      Use the workspace paths from poem-core-config.yaml (loaded by config service).
      In development: dev-workspace/prompts/, dev-workspace/schemas/, etc.
      In production: poem/prompts/, poem/schemas/, etc.

      The agent detects mode by checking for packages/poem-core/ (dev) vs .poem-core/ (prod).
    ```
  - [x] Add workflow metadata noting it relies on config for paths:
    ```yaml
    # Path resolution: Inherited from poem-core-config.yaml
    # DO NOT add a paths: section - config service is the source of truth
    pathResolution: config
    ```

- [x] Task 6: Document Pattern for Future Workflows (AC: 11)
  - [x] Create `packages/poem-core/workflows/README.md` with:
    - [x] Explanation: "Workflows do NOT define paths - config is source of truth"
    - [x] Pattern: How agents should resolve workspace paths
    - [x] Example: Reference to new-prompt.yaml as the model
    - [x] Anti-pattern: Never duplicate paths in workflow YAML
  - [x] This ensures Stories 3.3, 3.4, 3.5 (refine, test, validate) follow the pattern

- [x] Task 7: Update dev-setup.sh Script (AC: 2)
  - [x] Modify `scripts/dev-setup.sh` to create dev-workspace structure
  - [x] Add step: `mkdir -p dev-workspace/{prompts,schemas,mock-data,config,workflow-data}`
  - [x] Add informational message:
    ```
    Created dev-workspace/ for development testing.
    User-generated prompts, schemas, and mock-data go here (gitignored).
    ```

- [x] Task 8: Update API Tests for New Fixture Path (AC: 10)
  - [x] Update `packages/poem-app/tests/api/schema-extract.test.ts` (not prompt-render.test.ts)
  - [x] Updated tests to copy fixture to dev-workspace during test setup
  - [x] Added cleanup in afterAll to remove test fixture
  - [x] Tests pass with fixture in tests/fixtures/prompts/

- [x] Task 9: Update Config Service Tests (AC: 10)
  - [x] Update `packages/poem-app/tests/services/poem-config.test.ts`
  - [x] Add test: "dev mode resolves to dev-workspace paths"
  - [x] Add test: "prod mode resolves to poem/ paths"
  - [x] Add test: "should resolve full paths with dev-workspace in dev mode"
  - [x] Run tests: all 25 config tests pass

- [x] Task 10: Update Documentation (AC: 12)
  - [x] Update `CLAUDE.md`:
    - [x] Add "Dev Workspace" section explaining dev-workspace/
    - [x] Add "Config Source-of-Truth" section explaining the pattern
    - [x] Update path resolution table with correct development paths
    - [x] Note: "Workflows inherit paths from config - never duplicate"
  - [x] Update `packages/poem-core/poem-core-config.yaml` header comments

- [x] Task 11: End-to-End Verification (AC: 1-12)
  - [x] Verified dev-workspace exists with all subdirectories
  - [x] Verified dev-workspace is gitignored
  - [x] Verified root directories (prompts/, schemas/, mock-data/) are removed
  - [x] Verified test fixture at packages/poem-app/tests/fixtures/prompts/hello.hbs
  - [x] Verified no paths section in new-prompt.yaml
  - [x] Verified workflow README.md exists with pattern documentation
  - [x] Run full test suite: 208 tests pass (2 pre-existing flaky tests documented)

## Dev Notes

### Background Context

This story addresses TWO related issues discovered during Story 3.2 (New Prompt Workflow) testing:

**Issue 1: Test Pollution**
When running `/poem/agents/prompt-engineer` and executing `*new` in development mode, files are created at:
- `/poem-os/poem/prompts/generate-video-chapters.hbs`
- `/poem-os/poem/schemas/generate-video-chapters.json`

These directories are at the **monorepo root**, polluting POEM's source code.

**Issue 2: Path Duplication**
Workspace paths are defined in THREE places:
1. `poem-core-config.yaml` (workspace section)
2. `new-prompt.yaml` (paths section, lines 24-32)
3. `poem-config.ts` (fallback defaults)

This DRY violation means:
- Every future workflow would need to copy path definitions
- Inconsistencies are likely
- Stories 3.3, 3.4, 3.5 would face the same problem

### The hello.hbs Origin

[Source: git log]

`prompts/test/hello.hbs` was created in commit `42bbe65` during Stories 2.5, 2.6, 3.1, 3.1.5 implementation. It's a simple test fixture:
```handlebars
Hello, {{name}}!

Welcome to POEM - the Prompt Orchestration and Engineering Method.
```

**Decision:** Move to `packages/poem-app/tests/fixtures/prompts/hello.hbs` as it's needed for API testing.

### Architecture Reference

[Source: docs/architecture/unified-project-structure.md]

**Development Repository Structure** (lines 7-139) shows:
- `packages/` - Framework source code
- `data/` - Example data for development
- NO `prompts/`, `schemas/`, `mock-data/` at root

**Installed Structure** (lines 141-179) shows:
- `poem/` - User workspace with `prompts/`, `schemas/`, `mock-data/`

### Solution Overview

**Part 1: Dev Workspace**
```
poem-os/poem/
├── packages/                      # Framework source (unchanged)
├── data/                          # Reference examples (unchanged)
├── dev-workspace/                 # NEW: Developer testing workspace (gitignored)
│   ├── prompts/
│   ├── schemas/
│   ├── mock-data/
│   ├── config/
│   └── workflow-data/
└── ...
```

**Part 2: Config Source-of-Truth**
```
BEFORE (bad - duplication):
├── poem-core-config.yaml    → defines paths
├── new-prompt.yaml          → ALSO defines paths (duplicate!)
├── refine-prompt.yaml       → would ALSO define paths
├── test-prompt.yaml         → would ALSO define paths
└── poem-config.ts           → fallback defaults

AFTER (good - single source):
├── poem-core-config.yaml    → ONLY place paths are defined
├── new-prompt.yaml          → references config (no paths section)
├── refine-prompt.yaml       → references config (no paths section)
├── test-prompt.yaml         → references config (no paths section)
└── poem-config.ts           → reads from config file
```

### Path Resolution After This Story

| Mode | Prompts | Schemas | Mock Data |
|------|---------|---------|-----------|
| **Development** | `dev-workspace/prompts/` | `dev-workspace/schemas/` | `dev-workspace/mock-data/` |
| **Production** | `poem/prompts/` | `poem/schemas/` | `poem/mock-data/` |

### Future Workflow Impact

After this story, Stories 3.3, 3.4, 3.5 (refine, test, validate workflows) will:
1. NOT need to define paths in their YAML files
2. Automatically use correct workspace paths via config
3. Follow the pattern documented in `packages/poem-core/workflows/README.md`

### Files to Modify

```
packages/poem-app/
├── src/services/config/
│   └── poem-config.ts                    # MODIFY: Update DEV_DEFAULTS
├── tests/
│   ├── fixtures/prompts/
│   │   └── hello.hbs                     # CREATE: Moved from root
│   ├── services/
│   │   └── poem-config.test.ts           # MODIFY: Update path assertions
│   └── api/
│       └── prompt-render.test.ts         # MODIFY: Update fixture path

packages/poem-core/
├── poem-core-config.yaml                 # MODIFY: Update paths, add comments
└── workflows/
    ├── new-prompt.yaml                   # MODIFY: Remove paths section
    └── README.md                         # CREATE: Document pattern

scripts/
└── dev-setup.sh                          # MODIFY: Create dev-workspace

Root level:
├── .gitignore                            # MODIFY: Add dev-workspace/
├── CLAUDE.md                             # MODIFY: Document pattern
├── dev-workspace/                        # CREATE: With subdirs
│   └── README.md                         # CREATE: Explain purpose
├── prompts/                              # DELETE: Move fixture, then delete
├── schemas/                              # DELETE
└── mock-data/                            # DELETE
```

### Testing

[Source: docs/architecture/testing-strategy.md]

**Test Location:** `packages/poem-app/tests/`

**Tests to Update:**
1. `poem-config.test.ts` - Change path assertions to `dev-workspace/`
2. `prompt-render.test.ts` - Change fixture path to `tests/fixtures/prompts/`

**New Behavior to Verify:**
1. Config service returns `dev-workspace/prompts/` in dev mode
2. Config service returns `poem/prompts/` in prod mode
3. API tests use fixture from tests/fixtures/
4. `*new` workflow creates files in dev-workspace/

### Coding Standards

[Source: docs/architecture/coding-standards.md]

- Config changes should maintain backwards compatibility
- Fallback defaults must work when config file is missing
- Directory creation should be idempotent
- Workflows should NOT duplicate configuration data

## Story Acceptance Test (SAT) Guide

### Prerequisites

- [ ] Story status is "Ready for Review"
- [ ] All implementation files created per Dev Agent Record
- [ ] POEM_DEV=true is set in `.env` file

### Terminal Tests

#### Test A: Dev workspace directory exists

```bash
ls -la dev-workspace/
```

**Expected:** Directory exists with subdirs: prompts/, schemas/, mock-data/, config/, workflow-data/

---

#### Test B: Dev workspace is gitignored

```bash
grep "dev-workspace" .gitignore
```

**Expected:** `dev-workspace/` appears in .gitignore

---

#### Test C: Root-level directories removed

```bash
ls -d prompts schemas mock-data 2>/dev/null || echo "Directories correctly removed"
```

**Expected:** "Directories correctly removed"

---

#### Test D: Test fixture relocated

```bash
cat packages/poem-app/tests/fixtures/prompts/hello.hbs
```

**Expected:** Shows hello.hbs content (Hello, {{name}}!)

---

#### Test E: Config service returns dev-workspace paths

```bash
cd packages/poem-app && POEM_DEV=true npm test -- -t "dev-workspace" 2>&1 | tail -10
```

**Expected:** Tests pass showing dev-workspace path resolution

---

#### Test F: new-prompt.yaml has no paths section

```bash
grep -A5 "^paths:" packages/poem-core/workflows/new-prompt.yaml || echo "No paths section found (correct)"
```

**Expected:** "No paths section found (correct)"

---

#### Test G: Workflow README exists

```bash
head -10 packages/poem-core/workflows/README.md
```

**Expected:** Shows documentation about config source-of-truth pattern

---

#### Test H: All tests pass

```bash
cd packages/poem-app && npm test 2>&1 | tail -5
```

**Expected:** All tests pass

---

### Human Tests (Claude Code Conversation)

#### Test 1: Agent Creates Files in Dev Workspace

**Steps:**
1. Navigate to poem project: `cd ~/dev/ad/poem-os/poem`
2. Activate: `/poem/agents/prompt-engineer`
3. Run `*new` command
4. Create a test prompt (any simple prompt)

**Expected:**
- Files created in `dev-workspace/prompts/`, `dev-workspace/schemas/`
- NO files created at root level

---

#### Test 2: Verify Pattern Documentation

**Steps:**
1. Ask agent: "Where should prompts be created?"

**Expected:**
- Agent references config for paths
- Mentions dev-workspace for development mode
- Mentions poem/ for production mode

---

### Test Checklist

**Terminal Tests:**
- [ ] Test A: Dev workspace exists
- [ ] Test B: Gitignored
- [ ] Test C: Root dirs removed
- [ ] Test D: Fixture relocated
- [ ] Test E: Config service paths
- [ ] Test F: No paths in workflow
- [ ] Test G: Workflow README exists
- [ ] Test H: All tests pass

**Human Tests:**
- [ ] Test 1: Files in dev-workspace
- [ ] Test 2: Pattern documentation

**Overall Status:** ⬜ Pending

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-01 | 0.1 | Initial draft - Dev workspace separation | Bob (SM Agent) |
| 2026-01-01 | 0.2 | Expanded scope - Config source-of-truth, workflow pattern | Bob (SM Agent) |
| 2026-01-01 | 0.3 | PO validation: Added Task 1 clarification, SAT guide | Sarah (PO Agent) |
| 2026-01-01 | 1.0 | Implementation complete - All 11 tasks done, 208 tests pass | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Watcher test `should detect new helper files and register them` - pre-existing flaky test (file system timing)
- NFR2 server startup test - pre-existing flaky test, documented in maintenance backlog

### Completion Notes List

1. **Task 1**: Root directories (prompts/, schemas/, mock-data/) were already clean from git. Created test fixture at `packages/poem-app/tests/fixtures/prompts/hello.hbs`.

2. **Task 2**: Created `dev-workspace/` with all subdirectories and README. Added to .gitignore.

3. **Task 3**: Updated DEV_DEFAULTS in poem-config.ts to use dev-workspace/ paths.

4. **Task 4**: Updated poem-core-config.yaml with SINGLE SOURCE OF TRUTH header and dev-workspace paths.

5. **Task 5**: Removed paths section from new-prompt.yaml, added pathResolution: config metadata.

6. **Task 6**: Created workflows/README.md documenting the config source-of-truth pattern.

7. **Task 7**: Updated dev-setup.sh to create dev-workspace/ directory structure.

8. **Task 8**: Updated schema-extract.test.ts to copy fixture to dev-workspace during test setup.

9. **Task 9**: Added explicit dev-workspace path resolution tests to poem-config.test.ts.

10. **Task 10**: Updated CLAUDE.md with Dev Workspace and Config Source-of-Truth documentation.

11. **Task 11**: All SAT terminal tests pass. 208 tests pass (2 pre-existing flaky tests documented).

### File List

**Created:**
- `dev-workspace/README.md` - Developer testing workspace documentation
- `dev-workspace/prompts/` - Directory for user-created prompts (gitignored)
- `dev-workspace/schemas/` - Directory for JSON schemas (gitignored)
- `dev-workspace/mock-data/` - Directory for mock data (gitignored)
- `dev-workspace/config/` - Directory for user config (gitignored)
- `dev-workspace/workflow-data/` - Directory for workflow state (gitignored)
- `packages/poem-app/tests/fixtures/prompts/hello.hbs` - Relocated test fixture
- `packages/poem-core/workflows/README.md` - Workflow pattern documentation

**Modified:**
- `.gitignore` - Added dev-workspace/ entry
- `packages/poem-app/src/services/config/poem-config.ts` - Updated DEV_DEFAULTS to dev-workspace paths
- `packages/poem-core/poem-core-config.yaml` - Updated workspace paths, added source-of-truth comments
- `packages/poem-core/workflows/new-prompt.yaml` - Removed paths section, added pathResolution: config
- `scripts/dev-setup.sh` - Added dev-workspace directory creation
- `packages/poem-app/tests/api/schema-extract.test.ts` - Updated to use fixture from tests/fixtures
- `packages/poem-app/tests/services/poem-config.test.ts` - Added dev-workspace path resolution tests
- `CLAUDE.md` - Added Dev Workspace and Config Source-of-Truth documentation

**Deleted:**
- None (root directories prompts/, schemas/, mock-data/ were already clean)

## QA Results

### Review Date: 2026-01-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, well-documented implementation that achieves both objectives: dev workspace isolation and config source-of-truth pattern.

**Highlights:**
- TypeScript types properly defined (WorkspacePaths, PoemConfig, WorkspacePathType)
- JSDoc comments explain purpose and usage clearly
- Singleton pattern with `resetConfig()` for testing
- Graceful degradation with fallback defaults and console warnings
- DRY principle applied - eliminated path duplication across 3 files

### Refactoring Performed

None required - implementation is clean and follows best practices.

### Compliance Check

- Coding Standards: ✓ Clean TypeScript, proper error handling, consistent naming
- Project Structure: ✓ Config in services/, fixtures in tests/fixtures/, docs updated
- Testing Strategy: ✓ 28 unit tests + integration tests with proper setup/teardown
- All ACs Met: ✓ All 12 acceptance criteria verified

### Requirements Traceability

| AC | Requirement | Test Coverage |
|----|-------------|---------------|
| 1 | Dev mode uses dev-workspace/ | `should resolve to dev-workspace paths in dev mode` |
| 2 | Subdirs created by dev-setup.sh | SAT Test A verified |
| 3 | dev-workspace/ gitignored | SAT Test B verified |
| 4 | Config is single source of truth | poem-config.ts, poem-core-config.yaml updated |
| 5 | Production unchanged | `should resolve to poem/ paths in prod mode` |
| 6 | Workflows don't duplicate paths | new-prompt.yaml paths section removed |
| 7 | new-prompt.yaml updated | pathResolution: config added |
| 8 | Root dirs removed | SAT Test C verified |
| 9 | hello.hbs relocated | SAT Test D verified, tests/fixtures/prompts/ |
| 10 | All tests pass | 208/210 pass (2 pre-existing flaky) |
| 11 | Pattern documented | workflows/README.md created |
| 12 | CLAUDE.md updated | Dev Workspace + Config Source-of-Truth sections |

### Improvements Checklist

All items handled by developer - no outstanding issues:

- [x] Config service updated with dev-workspace defaults
- [x] Fallback defaults work when config file missing
- [x] Integration tests copy/cleanup fixtures properly
- [x] Pattern documentation comprehensive
- [x] CLAUDE.md path resolution table updated

### Security Review

No security concerns. This story handles configuration and path resolution only - no authentication, authorization, or sensitive data handling.

### Performance Considerations

**Positive:** Config singleton pattern ensures config file is read only once, avoiding repeated file I/O. Path resolution is O(1) after initial load.

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.2.5-dev-workspace-config-source-of-truth.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent documentation. Story owner can proceed.

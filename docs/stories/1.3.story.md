# Story 1.3: Create poem-app Package Structure

## Status

Done

## Story

**As a** developer,
**I want** the poem-app package structured as an Astro project,
**so that** the runtime server has proper scaffolding.

## Acceptance Criteria

1. `packages/poem-app/` initialized as Astro project (latest version)
2. TypeScript configured for Astro
3. Directory structure includes: `src/pages/api/`, `src/services/`, `src/config/`
4. Placeholder API endpoint: `src/pages/api/health.ts` returns status
5. Basic Astro config with configurable port
6. Package.json with start/build/dev scripts
7. Tailwind CSS configured (minimal, for future use)

## Tasks / Subtasks

- [x] Task 1: Verify existing Astro scaffolding from Story 1.1 (AC: 1, 2, 6)
  - [x] Confirm Astro 5.x is in dependencies
  - [x] Confirm TypeScript is configured (tsconfig.json exists)
  - [x] Confirm package.json has dev/build/preview scripts
  - [x] Run `npm run dev` to verify Astro starts

- [x] Task 2: Create required directory structure (AC: 3)
  - [x] Create `src/pages/api/` directory
  - [x] Create `src/services/` directory
  - [x] Create `src/config/` directory
  - [x] Create `tests/` directory (placeholder for future test files)

- [x] Task 3: Create health check API endpoint (AC: 4)
  - [x] Create `src/pages/api/health.ts`
  - [x] Implement GET endpoint returning JSON status
  - [x] Include response fields: status, timestamp, version
  - [x] Test endpoint with curl or browser

- [x] Task 4: Update Astro config for environment variable support (AC: 5)
  - [x] Add PORT environment variable support to astro.config.mjs
  - [x] Fallback to default 4321 if not set
  - [x] Verify config works with custom PORT

- [x] Task 5: Install and configure Tailwind CSS (AC: 7)
  - [x] Install @astrojs/tailwind integration
  - [x] Create tailwind.config.mjs with minimal config
  - [x] Update astro.config.mjs to include Tailwind integration
  - [x] Verify Tailwind compiles without errors

- [x] Task 6: Create placeholder config service (AC: 3)
  - [x] Create `src/config/index.ts`
  - [x] Export configuration loader that reads from environment
  - [x] Include port, host, and version settings

- [x] Task 7: Verify complete structure and lint
  - [x] Run ESLint to check for issues
  - [x] Verify all directories exist
  - [x] Verify Astro dev server starts successfully
  - [x] Test health endpoint returns expected response

## Dev Notes

### Previous Story Insights

[Source: Story 1.2 Completion Notes]

Story 1.1 and 1.2 established the monorepo foundation:
- Node 22.x, TypeScript 5.9.x, ESLint 9.x environment
- `packages/poem-app/` directory already created with basic Astro scaffolding
- `package.json` exists with @poem-os/app name, Astro 5.x, Handlebars 4.7.x, Vitest 4.x
- `astro.config.mjs` exists with server mode and port 4321
- `tsconfig.json` exists for TypeScript configuration
- `src/env.d.ts` exists for Astro type definitions

**Key files already created:**
- `packages/poem-app/package.json` - has all required scripts
- `packages/poem-app/tsconfig.json` - TypeScript configured
- `packages/poem-app/astro.config.mjs` - basic config in place
- `packages/poem-app/src/env.d.ts` - Astro types

### Astro Server Component

[Source: architecture/components.md#astro-server]

The Astro Server is responsible for:
- HTTP server with REST APIs for template rendering, schema operations, and provider integration
- File-based routing (`src/pages/api/*.ts`)
- Fast startup (< 3 seconds per NFR2)

Technology Stack: Astro 5.x, TypeScript, Node.js

### Project Structure

[Source: architecture/unified-project-structure.md]

Required poem-app structure:
```
packages/poem-app/
├── src/
│   ├── pages/
│   │   └── api/
│   │       ├── health.ts         ← Create in this story
│   │       ├── prompt/           ← Future (Epic 2)
│   │       ├── schema/           ← Future (Epic 2)
│   │       └── ...
│   │
│   ├── services/                 ← Create empty in this story
│   │   ├── handlebars/           ← Future (Epic 2)
│   │   ├── mock-generator/       ← Future (Epic 7)
│   │   └── schema/               ← Future (Epic 2)
│   │
│   ├── config/                   ← Create in this story
│   │   └── index.ts
│   │
│   └── env.d.ts                  ← Already exists
│
├── tests/                        ← Future stories
├── astro.config.mjs              ← Update for Tailwind
├── tailwind.config.mjs           ← Create in this story
├── tsconfig.json                 ← Already exists
└── package.json                  ← Already exists
```

### Tech Stack Details

[Source: architecture/tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| Astro | 5.x | API endpoints, file-based routing |
| TypeScript | 5.9.x | Type-safe server code |
| Node.js | 22.x LTS | Server runtime |
| Tailwind CSS | 4.x | Future visualization pages |
| Vitest | 4.x | Testing |

### Coding Standards

[Source: architecture/coding-standards.md]

**API Endpoint Standards:**
```typescript
// ✅ DO: Use consistent error response format
export async function GET({ request }: APIContext) {
  try {
    // ... process
    return new Response(JSON.stringify({ success: true, data }));
  } catch (error) {
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      { status: 400 }
    );
  }
}
```

**Naming Conventions:**
| Element | Convention | Example |
|---------|------------|---------|
| API routes | kebab-case directories | `/api/prompt/render.ts` |
| Services | PascalCase classes | `ConfigService` |
| Config files | kebab-case | `astro.config.mjs` |

### Health Endpoint Specification

[Source: architecture/components.md, PRD Epic 2 Story 2.1]

The health check endpoint should return:
```json
{
  "status": "ok",
  "timestamp": "2025-12-23T12:00:00Z",
  "version": "0.1.0"
}
```

**Implementation example with Content-Type header:**
```typescript
// src/pages/api/health.ts
import type { APIContext } from 'astro';

export async function GET({ request }: APIContext) {
  return new Response(
    JSON.stringify({
      status: 'ok',
      timestamp: new Date().toISOString(),
      version: '0.1.0',
    }),
    {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
      },
    }
  );
}
```

### Tailwind CSS Configuration

[Source: architecture/tech-stack.md]

Tailwind 4.x uses CSS-first configuration. Minimal setup for future use:
- Install `@astrojs/tailwind` integration
- Create `tailwind.config.mjs` (can be minimal/empty for now)
- Add integration to `astro.config.mjs`

### Config Service Pattern

[Source: architecture/coding-standards.md, unified-project-structure.md]

The config service should:
- Read from environment variables
- Provide typed configuration object
- Use default values when env vars not set

```typescript
// src/config/index.ts
export const config = {
  server: {
    port: parseInt(process.env.PORT || '4321', 10),
    host: process.env.HOST || 'localhost',
  },
  version: process.env.npm_package_version || '0.1.0',
};
```

### Testing

[Source: architecture/testing-strategy.md]

**Test file location:** `packages/poem-app/tests/`

**Testing approach for this story:** Manual verification

This story creates scaffolding (directories, config, basic endpoint). Automated tests for the health endpoint are optional for this story but will be required in Epic 2.

**Manual verification required:**
- Astro dev server starts without errors
- Health endpoint responds with expected JSON
- Tailwind integration doesn't cause build errors
- Config service exports correct values

**Future test location (when tests added):**
- `tests/api/health.test.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-23 | 0.2 | Added Content-Type header example, tests/ directory placeholder | Sarah (PO Agent) |
| 2025-12-23 | 1.0 | Implementation complete, ready for QA review | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no issues encountered during implementation.

### Completion Notes List

- All 7 tasks completed successfully
- Astro 5.16.6 installed and running (startup in ~80ms)
- Health endpoint returns JSON with status, timestamp, version
- Tailwind CSS integration configured with @astrojs/tailwind
- ESLint passes with 0 errors (1 warning for intentional unused param)
- Environment variable support added for PORT and HOST
- Config service exports typed configuration object
- Updated root eslint.config.js to add `process` global for config files

### File List

**Created:**
- `packages/poem-app/src/pages/api/health.ts` - Health check endpoint
- `packages/poem-app/src/config/index.ts` - Configuration service
- `packages/poem-app/tailwind.config.mjs` - Tailwind configuration
- `packages/poem-app/src/pages/api/` - API directory
- `packages/poem-app/src/services/` - Services directory
- `packages/poem-app/src/config/` - Config directory
- `packages/poem-app/tests/` - Tests directory placeholder

**Modified:**
- `packages/poem-app/astro.config.mjs` - Added Tailwind integration and env var support
- `packages/poem-app/package.json` - Added @astrojs/tailwind and tailwindcss dependencies
- `eslint.config.js` - Added process global for config files

---

## QA Results

### Review Date: 2025-12-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, minimal scaffolding implementation that follows project conventions. Code is well-structured and appropriately simple for a foundational story.

**Strengths:**
- Health endpoint follows Astro API patterns with proper Content-Type header
- Config service is typed and exports both value and type
- Tailwind integration is minimal as specified
- Environment variable support is consistent between astro.config.mjs and config service
- Good use of JSDoc comments

**Minor Observations:**
- health.ts uses hardcoded version "0.1.0" instead of importing from config - acceptable for health endpoint simplicity
- `_context` prefix on unused parameter is a clean solution for ESLint warning

### Refactoring Performed

None required - implementation is clean and follows standards.

### Compliance Check

- Coding Standards: ✓ Follows API endpoint patterns, naming conventions correct
- Project Structure: ✓ All directories in correct locations per unified-project-structure.md
- Testing Strategy: ✓ Manual verification appropriate for scaffolding story
- All ACs Met: ✓ All 7 acceptance criteria verified

### Requirements Traceability

| AC | Requirement | Implementation | Status |
|----|-------------|----------------|--------|
| 1 | Astro project (latest) | Astro 5.16.6 installed | ✓ |
| 2 | TypeScript configured | tsconfig.json extends astro/strict | ✓ |
| 3 | Directory structure | pages/api, services, config, tests created | ✓ |
| 4 | Health endpoint | GET /api/health returns JSON | ✓ |
| 5 | Configurable port | PORT env var with 4321 default | ✓ |
| 6 | Package.json scripts | dev, build, preview scripts present | ✓ |
| 7 | Tailwind CSS | @astrojs/tailwind integration configured | ✓ |

### Improvements Checklist

No improvements required - all items addressed by developer.

- [x] All directories created correctly
- [x] Health endpoint returns expected JSON format
- [x] Environment variable support implemented
- [x] Tailwind integration configured
- [x] ESLint configuration updated for process global
- [x] Manual verification completed

### Security Review

No security concerns - this is infrastructure scaffolding with no authentication, user input, or data storage.

### Performance Considerations

Server startup time of ~80ms is excellent (well under NFR2 requirement of < 3 seconds).

### Files Modified During Review

None - no refactoring needed.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.3-create-poem-app-package-structure.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, code quality excellent, no issues found.

# Story 2.6 - Acceptance Test Guide

## Quick Summary

**Story**: Create Schema Extraction API Endpoint
**Status**: Review
**Test Focus**: Validate POST /api/schema/extract extracts schemas from Handlebars templates

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review" or "Complete"
- [ ] Server is running (`npm run dev` in packages/poem-app)
- [ ] Dependencies installed (`npm install`)

**Environment Setup:**

- Node.js: 22.x LTS
- Port: 4321 (default Astro port)
- Working directory: `packages/poem-app`

**Start the server:**

```bash
cd packages/poem-app && npm run dev
```

Wait for: `Local http://localhost:4321/`

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - browser, visual inspection.

### Test 1: AC1 - API endpoint accessible in browser

**What to test**: POST endpoint exists and responds to requests

**Steps**:

1. Open browser to `http://localhost:4321/api/schema/extract`
2. Observe the response (GET will show method not allowed or similar)
3. Use browser dev tools Network tab to verify endpoint exists

**Expected Result**:
‚úÖ Endpoint responds (not 404)

- Browser shows some response from the endpoint
- Confirms route is registered

**Evidence**:

- Screenshot of browser showing response
- Network tab showing non-404 status

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC3,7 - Visual inspection of JSON schema format

**What to test**: Response schema structure is readable and well-formatted

**Steps**:

1. Use browser extension (like JSON Viewer) or Postman
2. POST to `http://localhost:4321/api/schema/extract` with body:
   ```json
   {
     "template": "Hello {{name}}, you have {{count}} items",
     "isRawTemplate": true
   }
   ```
3. Observe the response structure

**Expected Result**:
‚úÖ Response is well-structured JSON:

- `success: true`
- `schema.fields` is an array
- Each field has `name`, `type`, `required` properties
- `requiredHelpers` is an array
- `unregisteredHelpers` is an array

**Evidence**:

- Screenshot of formatted JSON response
- Verify field names match template placeholders

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Simple raw template extraction

**What to test**: API accepts raw template and extracts schema

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "Hello {{name}}", "isRawTemplate": true}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [
      {
        "name": "name",
        "type": "string",
        "required": true
      }
    ]
  },
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ Response is valid JSON
- ‚úÖ `success` is `true`
- ‚úÖ `schema.fields` contains one field named "name"
- ‚úÖ Field type is "string"

**Status**: ‚úÖ Passed

**Notes**: Response matches expected output exactly

---

### Test B: AC4 - Nested object extraction

**What to test**: Nested paths create object schema

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "{{user.firstName}} {{user.lastName}}", "isRawTemplate": true}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [
      {
        "name": "user",
        "type": "object",
        "required": true,
        "properties": [
          {
            "name": "firstName",
            "type": "string",
            "required": true
          },
          {
            "name": "lastName",
            "type": "string",
            "required": true
          }
        ]
      }
    ]
  },
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ `user` field has type "object"
- ‚úÖ `properties` contains `firstName` and `lastName`
- ‚úÖ Both properties have type "string"

**Status**: ‚úÖ Passed

**Notes**: Nested properties correctly extracted

---

### Test C: AC5 - Array extraction (#each block)

**What to test**: #each blocks create array type

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "{{#each items}}{{this.name}}{{/each}}", "isRawTemplate": true}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [
      {
        "name": "items",
        "type": "array",
        "required": true
      }
    ]
  },
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ `items` field has type "array"
- ‚úÖ Only one field extracted (not "this.name")

**Status**: ‚úÖ Passed

**Notes**: Array type correctly inferred from #each block

---

### Test D: AC2 - Boolean from #if block

**What to test**: #if conditions create boolean type

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "{{#if active}}Active{{/if}}", "isRawTemplate": true}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [
      {
        "name": "active",
        "type": "boolean",
        "required": true
      }
    ]
  },
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ `active` field has type "boolean"

**Status**: ‚úÖ Passed

**Notes**: Boolean type correctly inferred from #if block

---

### Test E: AC6 - Helper detection

**What to test**: Helpers are identified and field arguments extracted

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "{{truncate title 50}}", "isRawTemplate": true}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [
      {
        "name": "title",
        "type": "string",
        "required": true
      }
    ]
  },
  "requiredHelpers": ["truncate"],
  "unregisteredHelpers": ["truncate"]
}
```

**Validation**:

- ‚úÖ `requiredHelpers` contains "truncate"
- ‚úÖ `title` is extracted as a field
- ‚úÖ `unregisteredHelpers` contains "truncate" (since it's not registered)

**Status**: ‚úÖ Passed

**Notes**: Helper correctly detected, title extracted as field, unregisteredHelpers contains "truncate"

---

### Test F: AC1 - File-based template extraction

**What to test**: API loads template from file path

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "test/hello.hbs", "isRawTemplate": false}' | jq .
```

**Expected Output**:

```json
{
  "success": true,
  "schema": {
    "fields": [...]
  },
  "requiredHelpers": [...],
  "unregisteredHelpers": [...],
  "templatePath": ".../prompts/test/hello.hbs"
}
```

**Validation**:

- ‚úÖ `success` is `true`
- ‚úÖ `templatePath` is included in response
- ‚úÖ `schema.fields` extracted from file content

**Status**: ‚úÖ Passed

**Notes**: File-based extraction works correctly with test/hello.hbs template

---

### Test G: Error - Missing template file (404)

**What to test**: Returns 404 for non-existent template

**Command**:

```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{"template": "non-existent.hbs", "isRawTemplate": false}'
```

**Expected Output**:

```
{"success":false,"error":"Template not found: non-existent.hbs","details":{"path":"..."}}
HTTP Status: 404
```

**Validation**:

- ‚úÖ HTTP status is 404
- ‚úÖ `success` is `false`
- ‚úÖ `error` mentions "not found"

**Status**: ‚úÖ Passed

**Notes**: Returns 404 with appropriate error message and path details

---

### Test H: Error - Invalid JSON body (400)

**What to test**: Returns 400 for invalid JSON

**Command**:

```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d 'not valid json'
```

**Expected Output**:

```
{"success":false,"error":"Invalid JSON body"}
HTTP Status: 400
```

**Validation**:

- ‚úÖ HTTP status is 400
- ‚úÖ `success` is `false`
- ‚úÖ Error message indicates invalid JSON

**Status**: ‚úÖ Passed

**Notes**: Returns 400 with "Invalid JSON body" error message

---

### Test I: Error - Missing template field (400)

**What to test**: Returns 400 when template field missing

**Command**:

```bash
curl -s -w "\nHTTP Status: %{http_code}\n" -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected Output**:

```
{"success":false,"error":"Template is required",...}
HTTP Status: 400
```

**Validation**:

- ‚úÖ HTTP status is 400
- ‚úÖ Error indicates template is required

**Status**: ‚úÖ Passed

**Notes**: Returns 400 with validation error for missing template field

---

## ‚è≥ Not Testable Yet

None - all acceptance criteria are testable with current implementation.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: AC1 - API endpoint accessible in browser
- [ ] Test 2: AC3,7 - Visual inspection of JSON schema format

**Terminal Tests:**

- [x] Test A: AC1 - Simple raw template extraction
- [x] Test B: AC4 - Nested object extraction
- [x] Test C: AC5 - Array extraction (#each block)
- [x] Test D: AC2 - Boolean from #if block
- [x] Test E: AC6 - Helper detection
- [x] Test F: AC1 - File-based template extraction
- [x] Test G: Error - Missing template file (404)
- [x] Test H: Error - Invalid JSON body (400)
- [x] Test I: Error - Missing template field (400)

**Overall Status**: üîÑ In Progress (Terminal Tests Complete, Human Tests Pending)

---

## Troubleshooting

### Issue: Server not running

**Symptom**: `curl: (7) Failed to connect to localhost port 4321`
**Solution**: Start server with `cd packages/poem-app && npm run dev`

### Issue: jq not installed

**Symptom**: `jq: command not found`
**Solution**: Install jq (`brew install jq` on macOS) or remove `| jq .` from commands

### Issue: Port already in use

**Symptom**: `Port 4321 is in use`
**Solution**: Kill existing process or use different port with `PORT=4322 npm run dev`

---

## Test Results Summary

**Date Tested**: 2025-12-30
**Tester**: Taylor (SAT Agent) - Terminal Tests

**Results**:

- Human Tests: 0 / 2 passed (pending manual execution)
- Terminal Tests: 9 / 9 passed
- Total: 9 / 11 passed

**Issues Found**:

None - all terminal tests passing

**Sign-off**: ‚¨ú Pending Human Tests

---

_Generated by Taylor (SAT Guide Creator) from Story 2.6_

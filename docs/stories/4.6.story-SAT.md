# Story 4.6 - Acceptance Test Guide

## Quick Summary

**Story**: Run Prompt Chain (Section 1 ‚Üí Section 5)
**Status**: Review
**Test Focus**: Validate chain execution system that sequences prompts with data accumulation, field mapping, and pause/resume capability

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review" (confirmed ‚úÖ)
- [ ] Server is running: `npm run dev` in `packages/poem-app/`
- [ ] Required dependencies installed: `npm install`
- [ ] Unit tests passing: 28/28 tests ‚úÖ
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem`

**Environment Setup:**

- Node.js: 22.x LTS
- Port: 4321 (default Astro dev server)
- API Base URL: `http://localhost:4321`
- Workspace: `dev-workspace/` (development mode)

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - API responses, JSON inspection, workflow-data files.

### Test 1: AC5 - Execution Logging in API Response

**What to test**: Each chain step logs prompt name, input fields used, output fields added, and render time

**Steps**:

1. Start server: `npm run dev` in `packages/poem-app/`
2. Wait for server to start (watch for "Server started" message)
3. Execute Test A (Terminal Test) which calls the chain execution endpoint
4. Observe the JSON response in terminal

**Expected Result**:
‚úÖ API response contains execution logging:

- `executedTemplates` array with entries for each step
- Each entry has:
  - `stepId`: step identifier (e.g., "step1")
  - `templatePath`: prompt template path
  - `executedAt`: ISO 8601 timestamp
  - `outputFields`: array of field names added
  - `renderTimeMs`: execution time in milliseconds
- `executionSummary` with:
  - `stepsExecuted`: count of executed steps
  - `totalRenderTimeMs`: total execution time
  - `failedSteps`: 0 for successful execution

**Evidence**:

- Terminal output showing JSON response with execution records
- Each step has timestamp, template path, and fields logged

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test 2: AC7 - Workflow-Data File Inspection

**What to test**: Final workflow-data contains all accumulated fields from chain execution

**Steps**:

1. Execute Test A (Terminal Test) which creates workflow-data file
2. Note the `workflowData.id` from the response (e.g., "m3k4l2p9-abc1234")
3. Open file: `dev-workspace/workflow-data/{id}.json` in text editor
4. Inspect the file contents

**Expected Result**:
‚úÖ Workflow-data JSON file contains:

- `id`: unique workflow identifier
- `workflowName`: chain name (e.g., "simple-test-chain")
- `startedAt` and `updatedAt`: ISO 8601 timestamps
- `executedTemplates`: array with execution records
- `data`: object with all accumulated fields from chain steps
  - Initial input data present
  - Output from each step present
  - Data flows from step to step
- Pretty-printed JSON (human-readable with indentation)

**Evidence**:

- Screenshot or text showing workflow-data JSON file
- All expected fields present in `data` object
- Timestamps in ISO 8601 format
- 2-space indentation (human-readable)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test 3: AC4 - YouTube Chain Visual Verification

**What to test**: Chain tested with actual YouTube templates (3-step: abridge ‚Üí analyze ‚Üí generate-titles)

**Steps**:

1. Review the test fixture: `packages/poem-app/tests/fixtures/chains/youtube-3-step.yaml`
2. Verify template paths reference actual YouTube templates:
   - `youtube-launch-optimizer/prompts/1-4-abridge-v2.hbs`
   - `youtube-launch-optimizer/prompts/4-1-analyze-content-essence.hbs`
   - `youtube-launch-optimizer/prompts/5-1-generate-title-v2.hbs`
3. Check templates exist in `dev-workspace/workflows/youtube-launch-optimizer/prompts/`

**Expected Result**:
‚úÖ YouTube chain configuration verified:

- YAML file defines 3-step chain
- Template paths match actual YouTube template files
- Steps define correct input/output field names
- Chain follows logical flow: raw ‚Üí abridged ‚Üí analyzed ‚Üí titles

**Evidence**:

- YAML file contents showing chain definition
- Confirmation that template files exist in workspace
- Step IDs: abridge, analyze, generateTitles

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1, AC2, AC3 - Basic Chain Execution with Data Flow

**What to test**: Chain definition specifies sequence, output stored in workflow-data, subsequent prompts access accumulated data

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d '{
    "chain": {
      "name": "simple-test-chain",
      "version": "1.0.0",
      "steps": [
        {
          "id": "step1",
          "prompt": "api-test-1.hbs",
          "inputs": ["input"],
          "outputs": ["step1Output"]
        },
        {
          "id": "step2",
          "prompt": "api-test-2.hbs",
          "inputs": ["step1Output"],
          "outputs": ["step2Output"]
        }
      ]
    },
    "initialData": {
      "input": "test value"
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "workflowData": {
    "id": "<workflow-id>",
    "workflowName": "simple-test-chain",
    "startedAt": "<timestamp>",
    "updatedAt": "<timestamp>",
    "executedTemplates": [
      {
        "stepId": "step1",
        "templatePath": "api-test-1.hbs",
        "executedAt": "<timestamp>",
        "outputFields": ["step1Output"],
        "renderTimeMs": <number>
      },
      {
        "stepId": "step2",
        "templatePath": "api-test-2.hbs",
        "executedAt": "<timestamp>",
        "outputFields": ["step2Output"],
        "renderTimeMs": <number>
      }
    ],
    "data": {
      "input": "test value",
      "step1Output": "Step 1: test value",
      "step2Output": "Step 2: Step 1: test value"
    },
    "checkpoint": null
  },
  "executionSummary": {
    "stepsExecuted": 2,
    "totalRenderTimeMs": <number>,
    "failedSteps": 0
  }
}
```

**Validation**:

- ‚úÖ Response has `success: true`
- ‚úÖ `workflowData.id` is present (unique identifier)
- ‚úÖ `executedTemplates` has 2 entries (2 steps)
- ‚úÖ `data.input` equals "test value" (initial data preserved)
- ‚úÖ `data.step1Output` equals "Step 1: test value" (step 1 output stored)
- ‚úÖ `data.step2Output` equals "Step 2: Step 1: test value" (step 2 used step 1 output)
- ‚úÖ `executionSummary.stepsExecuted` equals 2
- ‚úÖ `executionSummary.failedSteps` equals 0

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test B: AC8 - Field Mapper Translation

**What to test**: Field mapper objects translate prompt output field names to workflow attribute names

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d '{
    "chain": {
      "name": "mapper-test-chain",
      "version": "1.0.0",
      "steps": [
        {
          "id": "step1",
          "prompt": "mapper-test.hbs",
          "inputs": ["input"],
          "outputs": ["finalOutput"],
          "mapper": {
            "result": "finalOutput"
          }
        }
      ]
    },
    "initialData": {
      "input": "mapped value"
    }
  }' | jq '.workflowData.data'
```

**Expected Output**:

```json
{
  "input": "mapped value",
  "finalOutput": "mapped value"
}
```

**Validation**:

- ‚úÖ `data.finalOutput` exists (mapped field name)
- ‚úÖ `data.finalOutput` equals "mapped value"
- ‚úÖ `data.result` does NOT exist (original field renamed)
- ‚úÖ Mapper translated "result" ‚Üí "finalOutput"

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test C: AC6 - Pause and Resume Chain Execution

**What to test**: Chain can be paused after a specific step and resumed from saved workflow-data

**Part 1: Execute and Pause**

```bash
RESPONSE=$(curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d '{
    "chain": {
      "name": "pause-test-chain",
      "version": "1.0.0",
      "steps": [
        {
          "id": "step1",
          "prompt": "api-test-1.hbs",
          "inputs": ["input"],
          "outputs": ["step1Output"]
        },
        {
          "id": "step2",
          "prompt": "api-test-2.hbs",
          "inputs": ["step1Output"],
          "outputs": ["step2Output"]
        },
        {
          "id": "step3",
          "prompt": "api-test-1.hbs",
          "inputs": ["step2Output"],
          "outputs": ["step3Output"]
        }
      ]
    },
    "initialData": {
      "input": "pause test"
    },
    "pauseAfterStep": 2
  }')

echo "$RESPONSE" | jq '.'
WORKFLOW_ID=$(echo "$RESPONSE" | jq -r '.workflowData.id')
echo "Workflow ID: $WORKFLOW_ID"
```

**Expected Output (Part 1)**:

```json
{
  "success": true,
  "workflowData": {
    "id": "<workflow-id>",
    "executedTemplates": [
      /* 2 entries - only step1 and step2 */
    ]
  },
  "executionSummary": {
    "stepsExecuted": 2,
    "failedSteps": 0
  }
}
```

**Part 2: Resume Execution**

```bash
# Use WORKFLOW_ID from Part 1
curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d "{
    \"chain\": {
      \"name\": \"pause-test-chain\",
      \"version\": \"1.0.0\",
      \"steps\": [
        {
          \"id\": \"step1\",
          \"prompt\": \"api-test-1.hbs\",
          \"inputs\": [\"input\"],
          \"outputs\": [\"step1Output\"]
        },
        {
          \"id\": \"step2\",
          \"prompt\": \"api-test-2.hbs\",
          \"inputs\": [\"step1Output\"],
          \"outputs\": [\"step2Output\"]
        },
        {
          \"id\": \"step3\",
          \"prompt\": \"api-test-1.hbs\",
          \"inputs\": [\"step2Output\"],
          \"outputs\": [\"step3Output\"]
        }
      ]
    },
    \"workflowId\": \"$WORKFLOW_ID\",
    \"resume\": true
  }" | jq '.'
```

**Expected Output (Part 2)**:

```json
{
  "success": true,
  "workflowData": {
    "id": "<same-workflow-id>",
    "executedTemplates": [
      /* 3 entries - step1, step2, step3 */
    ],
    "data": {
      "input": "pause test",
      "step1Output": "Step 1: pause test",
      "step2Output": "Step 2: Step 1: pause test",
      "step3Output": "Step 1: Step 2: Step 1: pause test"
    }
  },
  "executionSummary": {
    "stepsExecuted": 1,
    "failedSteps": 0
  }
}
```

**Validation**:

- ‚úÖ Part 1: `executedTemplates` has 2 entries (paused after step 2)
- ‚úÖ Part 1: `stepsExecuted` equals 2
- ‚úÖ Part 2: `workflowData.id` matches Part 1 (same workflow)
- ‚úÖ Part 2: `executedTemplates` has 3 entries (resumed and completed)
- ‚úÖ Part 2: `stepsExecuted` equals 1 (only executed step 3 in resume)
- ‚úÖ Part 2: `data` contains all fields from steps 1, 2, and 3
- ‚úÖ Workflow-data persisted and resumed correctly

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test D: Error Handling - Missing Input Field

**What to test**: Chain execution handles errors gracefully and preserves partial workflow-data

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d '{
    "chain": {
      "name": "error-test-chain",
      "version": "1.0.0",
      "steps": [
        {
          "id": "step1",
          "prompt": "api-test-1.hbs",
          "inputs": ["missingField"],
          "outputs": ["output"]
        }
      ]
    },
    "initialData": {
      "input": "test"
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": false,
  "error": "Missing required input field: missingField for step step1",
  "details": {
    "failedStep": 0,
    "templatePath": "api-test-1.hbs",
    "workflowDataId": "<workflow-id>"
  }
}
```

**Validation**:

- ‚úÖ Response has `success: false`
- ‚úÖ `error` message describes missing field
- ‚úÖ `details.failedStep` equals 0 (first step)
- ‚úÖ `details.workflowDataId` is present (partial state preserved)
- ‚úÖ HTTP status is 400 (bad request)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

### Test E: Validation - Invalid Chain Definition

**What to test**: API validates chain definition format with Zod schema

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/chain/execute \
  -H "Content-Type: application/json" \
  -d '{
    "chain": {
      "steps": []
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": false,
  "error": "Invalid request format",
  "details": {
    "validationErrors": [
      /* Zod validation errors */
    ]
  }
}
```

**Validation**:

- ‚úÖ Response has `success: false`
- ‚úÖ `error` mentions "Invalid request format"
- ‚úÖ `details.validationErrors` array is present
- ‚úÖ HTTP status is 400 (bad request)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _______________

---

## ‚è≥ Not Testable Yet

None - all acceptance criteria are testable with current implementation.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: AC5 - Execution logging in API response
- [ ] Test 2: AC7 - Workflow-data file inspection
- [ ] Test 3: AC4 - YouTube chain visual verification

**Terminal Tests:**

- [ ] Test A: AC1, AC2, AC3 - Basic chain execution with data flow
- [ ] Test B: AC8 - Field mapper translation
- [ ] Test C: AC6 - Pause and resume chain execution
- [ ] Test D: Error handling - Missing input field
- [ ] Test E: Validation - Invalid chain definition

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Server connection refused (ECONNREFUSED)

**Symptom**: curl commands fail with "Connection refused" error
**Solution**:
1. Ensure server is running: `npm run dev` in `packages/poem-app/`
2. Wait for "Server started on port 4321" message
3. Verify server is listening: `curl http://localhost:4321/api/health`

### Issue: Template file not found

**Symptom**: API returns 500 error about missing template file
**Solution**:
1. Ensure test templates exist in `dev-workspace/prompts/` directory
2. Create missing templates:
   - `api-test-1.hbs`: `Step 1: {{input}}`
   - `api-test-2.hbs`: `Step 2: {{step1Output}}`
   - `mapper-test.hbs`: `{"result": "{{input}}"}`
3. Restart server if templates were just created

### Issue: jq command not found

**Symptom**: Terminal shows "jq: command not found"
**Solution**:
1. Install jq: `brew install jq` (macOS) or `apt-get install jq` (Linux)
2. Or remove `| jq '.'` from commands to see raw JSON

### Issue: Workflow-data file not found

**Symptom**: Cannot find workflow-data JSON file in dev-workspace
**Solution**:
1. Check directory exists: `ls dev-workspace/workflow-data/`
2. Look for `.json` files: `ls dev-workspace/workflow-data/*.json`
3. Use workflow ID from API response to locate file
4. Ensure server has write permissions to dev-workspace directory

---

## Test Results Summary

**Date Tested**: 2026-01-14
**Tester**: Quinn (Test Architect) - Automated Execution

**Results**:

- Human Tests: 3 / 3 passed ‚úÖ
- Terminal Tests: 5 / 5 passed ‚úÖ
- Total: 8 / 8 passed ‚úÖ

**Test Execution Details**:

**Terminal Tests**:
- ‚úÖ Test A (AC1, AC2, AC3): Basic chain execution - PASSED
  - 2-step chain executed successfully
  - Data accumulated correctly across steps
  - Response format validated
- ‚úÖ Test B (AC8): Field mapper translation - PASSED
  - Mapper correctly translated "result" ‚Üí "finalOutput"
  - Original field removed from workflow-data
- ‚úÖ Test C (AC6): Pause and resume - PASSED
  - Part 1: Paused after 2 steps successfully
  - Part 2: Resumed and completed step 3
  - Workflow ID preserved across pause/resume
- ‚úÖ Test D: Error handling - PASSED
  - Missing input field error caught
  - Comprehensive error context returned
  - Workflow ID preserved for debugging
- ‚úÖ Test E: Validation - PASSED
  - Invalid chain definition rejected
  - Zod validation errors detailed

**Human Tests**:
- ‚úÖ Test 1 (AC5): Execution logging - PASSED
  - All required fields present in executedTemplates
  - Timestamps in ISO 8601 format
  - Render times tracked per step
- ‚úÖ Test 2 (AC7): Workflow-data file inspection - PASSED
  - File at: `packages/poem-app/poem/workflow-data/mkdkj0r9-lr9nbr4.json`
  - Pretty-printed with 2-space indentation
  - All accumulated fields present
  - Data flows correctly between steps
- ‚úÖ Test 3 (AC4): YouTube chain verification - PASSED
  - YAML file exists at: `tests/fixtures/chains/youtube-3-step.yaml`
  - 3-step chain with correct template paths
  - Logical flow: abridge ‚Üí analyze ‚Üí generateTitles

**Issues Found**:

None - All tests passed.

**Notes**:
- Workflow-data files created in `packages/poem-app/poem/workflow-data/` (relative to server working directory)
- Server started successfully on port 4321
- All API responses returned in <500ms
- Field mapper pattern working perfectly

**Sign-off**: ‚úÖ **Story accepted - All acceptance criteria validated**

---

_Generated by Taylor (SAT Guide Creator) from Story 4.6_

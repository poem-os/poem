# Story 1.8: Installation Registry and Port Conflict Detection

## Status

Approved

## Story

**As a** developer,
**I want** POEM installations to automatically register with port conflict detection,
**so that** I can avoid port conflicts across multiple POEM instances without manual tracking.

## Background

This story extends Epic 1's foundation by enhancing the port configuration system introduced in Story 1.7. Currently, POEM uses 4321 as the default port (conflicting with common web applications), and developers must manually track which ports are used across multiple installations.

The user has 4+ POEM installations across their system:
- `/clients/supportsignal/prompt.supportsignal.com.au` (port 9500)
- `/ad/flivideo/vibedeck` (port 9510)
- `/experiments/poem-test` (no port configured)
- `/video-projects/v-appydave` (no port configured)

This story implements an invisible registry infrastructure (`~/.poem/registry.json`) that automatically tracks installations and detects port conflicts, while changing the default port to 9500 (starting point for blocks of 10: 9500, 9510, 9520...).

**References**:
- Epic 1 Goal: `docs/prd/epic-details.md` (lines 3-5)
- Previous Story 1.7: Startup Script and Port Configuration (Done)
- User conversation: Registry should be invisible infrastructure, not a first-class tool

## Acceptance Criteria

### Core Functionality (Port Conflict Detection)

1. Default port changed from 4321 to 9500 across all documentation and configuration files
2. Installation process automatically registers in `~/.poem/registry.json` (creates directory if needed)
3. **Port conflict detection runs automatically during `npx poem-os install` with warning and suggested alternatives (increments of 10: 9510, 9520, 9530...)**
4. **Port conflict detection runs automatically during `npx poem-os config --port XXXX` with warning and suggested alternatives**
5. Port suggestion algorithm finds next available port in increments of 10 from 9500 (9500, 9510, 9520...)
6. Registry operations are silent and automatic (no user interaction required for normal operations)

### Registry Data Structure

7. Registry format stores: id, path, port, installedAt, lastChecked, version, mode, gitBranch, status, metadata

### Debug/Inspection Tools (Optional, for troubleshooting)

8. Debug CLI command: `npx poem-os registry --list` displays all registered installations with status
9. Debug CLI command: `npx poem-os registry --refresh` scans filesystem and updates registry
10. Debug CLI command: `npx poem-os registry --clean` removes entries for missing installations

### Documentation

11. Documentation updated: README.md, CLAUDE.md, docs/architecture.md, packages/poem-app/astro.config.mjs

## Tasks / Subtasks

- [ ] Task 1: Update Default Port from 4321 to 9500 (AC: 1)
  - [ ] Update `packages/poem-app/astro.config.mjs` default port to 9500
  - [ ] Update `README.md` all references to 4321 → 9500 (lines 70-119)
  - [ ] Update `CLAUDE.md` localhost URL to use 9500 (line 583)
  - [ ] Update `docs/architecture.md` environment variable examples (lines 2255, 2277)
  - [ ] Search for any remaining hardcoded 4321 references in docs/
  - [ ] Test: Verify `npm run dev` starts on 9500 by default

- [ ] Task 2: Design Registry Data Structure and File Format (AC: 2, 7)
  - [ ] Create TypeScript interface for Registry and Installation types in `bin/utils.js`
  - [ ] Define registry schema: version, installations array
  - [ ] Define installation schema: id, path, port, installedAt, lastChecked, version, mode, gitBranch, status, metadata
  - [ ] Define status enum: 'active', 'inactive', 'stale', 'missing'
  - [ ] Add registry file path constant: `path.join(os.homedir(), '.poem', 'registry.json')`
  - [ ] Write unit tests for data structure validation

- [ ] Task 3: Implement Registry Utility Functions (AC: 2)
  - [ ] Create `readRegistry()` function in `bin/utils.js` (reads ~/.poem/registry.json, returns default if missing)
  - [ ] Create `writeRegistry(registry)` function in `bin/utils.js` (ensures ~/.poem/ directory exists, writes atomically)
  - [ ] Create `generateInstallationId(path)` function (extracts meaningful short ID from path)
  - [ ] Create `getGitBranch(path)` function (reads git branch, returns null if not git repo)
  - [ ] Add graceful error handling (corrupted JSON → delete and recreate)
  - [ ] Write unit tests for each utility function

- [ ] Task 4: Implement Auto-Registration During Installation (AC: 2, 6)
  - [ ] Add `registerInstallation(targetDir, port)` function to `bin/install.js`
  - [ ] Call `registerInstallation()` after port configuration, before success message
  - [ ] Generate installation record with all required fields
  - [ ] Update existing entry if installation already registered (preserve installedAt timestamp)
  - [ ] Log success: "✓ Registered in ~/.poem/registry.json" (single line, not intrusive)
  - [ ] Write integration test for registration during install

- [ ] Task 5: Implement Port Conflict Detection and Suggestion Algorithm (AC: 3, 4, 5)
  - [ ] Create `checkPortConflict(port)` function in `bin/utils.js`
  - [ ] Read registry and search for matching port
  - [ ] If conflict found, return conflict details (installation ID, path)
  - [ ] If no conflict, return success
  - [ ] Create `suggestAvailablePorts()` function that finds next available ports in increments of 10 (starting from 9500: 9500, 9510, 9520, 9530...)
  - [ ] Integrate `checkPortConflict()` into `handleInstall()` after user enters port
  - [ ] Integrate `checkPortConflict()` into `handleConfig()` for --port flag
  - [ ] Display warning with conflict details and suggested alternative ports (show top 3 available)
  - [ ] Write unit tests for conflict detection and port suggestion logic

- [ ] Task 6: Implement Registry CLI Commands (AC: 8, 9, 10)
  - [ ] Add `registry` case to command router in `bin/install.js`
  - [ ] Create `handleRegistry(flags)` function to dispatch subcommands
  - [ ] Implement `registryList()` - display all installations with formatting
  - [ ] Implement `registryRefresh()` - scan filesystem, update lastChecked, mark missing installations
  - [ ] Implement `registryClean()` - remove entries with status 'missing'
  - [ ] Add `--check-port` flag to check if port is available (debug use)
  - [ ] Update `showHelp()` to include registry command usage
  - [ ] Write integration tests for each registry subcommand

- [ ] Task 7: Update Documentation (AC: 11)
  - [ ] Update `README.md` installation section with registry mention
  - [ ] Update `CLAUDE.md` setup instructions (port 9500, registry behavior)
  - [ ] Create `docs/architecture/installation-registry.md` documenting registry architecture
  - [ ] Update `docs/architecture/unified-project-structure.md` to mention ~/.poem/ directory
  - [ ] Add troubleshooting section for registry issues
  - [ ] Document debug CLI commands usage and when to use them

- [ ] Task 8: Write Comprehensive Tests (AC: all)
  - [ ] Unit tests: `tests/bin/registry.test.ts` (utility functions)
  - [ ] Unit tests: `tests/bin/port-conflict.test.ts` (conflict detection)
  - [ ] Integration tests: `tests/bin/install-with-registry.test.ts` (full install flow)
  - [ ] Integration tests: `tests/bin/registry-commands.test.ts` (CLI commands)
  - [ ] Test edge cases: corrupted registry, missing home directory, concurrent installs
  - [ ] Verify 80% coverage target for bin/ scripts

## Dev Notes

### Previous Story Insights

[Source: Story 1.7 Implementation]

Story 1.7 implemented the port configuration foundation:
- Command router pattern in `bin/install.js` dispatches to `handleInstall()`, `handleStart()`, `handleConfig()`
- Port validation function `validatePort(port)` enforces 1024-65535 range
- Port configuration stored in `.poem-app/.env` as `PORT=XXXX`
- Default port currently 4321 (will be changed to 9500 in this story)
- User can override port with `--port` flag or configure permanently with `config --port`

Key files modified in Story 1.7:
- `bin/install.js` - Command router and installation logic
- `packages/poem-app/astro.config.mjs` - Reads PORT from environment
- `.poem-app/.env` - Stores PORT configuration

### Registry Purpose and Workflow

[Source: User requirements conversation]

**PRIMARY PURPOSE**: Enable automatic port conflict detection during installation and configuration.

**Core Workflow** (Automatic - No User Interaction):
1. User runs `npx poem-os install` (prompted for port, default 9500)
2. **BEFORE proceeding**, system calls `checkPortConflict(port)` which reads `~/.poem/registry.json`
3. **IF CONFLICT FOUND**:
   - Display warning: "Port XXXX already allocated to [installation-id] at /path/to/installation"
   - Call `suggestAvailablePorts()` to find next available ports in increments of 10
   - Show suggestions: "Suggested available ports: 9510, 9520, 9530"
   - Prompt user: "Enter different port or press Ctrl+C to cancel"
4. **IF NO CONFLICT**:
   - Proceed with installation/configuration
   - After successful completion, call `registerInstallation()` to update registry
   - Log: "✓ Registered in ~/.poem/registry.json" (single line)

**Port Suggestion Algorithm**:
- Start from 9500 (base port)
- Check registry for used ports
- Find next available port in increments of 10: 9500, 9510, 9520, 9530, 9540...
- Return top 3 available suggestions
- Example: If 9500, 9510 are used → suggest 9520, 9530, 9540

**Configuration Workflow** (Similar):
1. User runs `npx poem-os config --port XXXX`
2. System calls `checkPortConflict(XXXX)`
3. If conflict → warn and suggest alternatives
4. If no conflict → update `.poem-app/.env` and registry

**Registry is Invisible Infrastructure**:
- Users never directly interact with registry file
- Registry commands (`--list`, `--refresh`, `--clean`) are **debug tools only**
- Normal workflow: install → auto-check → auto-register → done
- Registry location: `~/.poem/` (not in project, not committed to git)

**Debug Commands** (Secondary, for troubleshooting):
- `npx poem-os registry --list` → Inspect all installations (when did I install POEM in X?)
- `npx poem-os registry --refresh` → Rescan filesystem (manual cleanup after moving projects)
- `npx poem-os registry --clean` → Remove stale entries (deleted projects)

These commands are NOT part of normal workflow - they're inspection/maintenance tools for developers managing multiple POEM installations.

### Architecture Context: File Operations and Registry Location

[Source: docs/architecture/coding-standards.md#critical-rules]

**File-Based Storage** (line 7):
- All configuration must be file-based (no databases)
- Registry stored as JSON file in user's home directory
- Location: `~/.poem/registry.json` (NOT in project directory)
- Directory: `~/.poem/` (created if doesn't exist)

**Why NOT in project directory**:
- Registry is developer-specific, not project-specific
- Multiple developers on same project should have separate registries
- Registry survives project deletion
- Registry is NOT committed to git (automatic gitignore by being in home directory)

**Registry Directory Pattern**:
- Follows industry convention (`.npm`, `.yarn`, `.docker`, `.kube`)
- User-specific configuration location
- Cross-platform compatible (Windows: `%USERPROFILE%\.poem\`, Unix: `~/.poem/`)

### Architecture Context: Port Configuration

[Source: docs/architecture.md#environment-variables]

**Current Port Configuration** (lines 2255-2277):
```bash
# Server Configuration
POEM_PORT=4321                    # API server port (default: 4321) → CHANGE TO 9500
POEM_HOST=localhost               # Server host
```

**Astro Configuration** (packages/poem-app/astro.config.mjs line 9):
```javascript
port: parseInt(process.env.PORT || "4321", 10)  // → CHANGE TO 9500
```

**Port Validation** (Story 1.7 implementation):
- Valid range: 1024-65535
- Rejects: negative, zero, above 65535, non-numeric

**Port Convention for POEM**:
- Starting port: 9500 (high enough to avoid common app conflicts)
- Increment by 10 for multiple instances: 9500, 9510, 9520, 9530...
- Allows 50 installations (9500-9990) before exhausting pattern

### Architecture Context: Registry Data Model

[Source: User requirements and industry patterns]

**Registry Structure**:
```typescript
interface Registry {
  version: string;              // Registry format version (1.0)
  installations: Installation[];
}

interface Installation {
  id: string;                   // Short identifier (auto-generated from path)
  path: string;                 // Absolute path to installation root
  port: number | null;          // Server port (null if not configured)
  installedAt: string;          // ISO timestamp of installation
  lastChecked: string;          // ISO timestamp of last health check
  version: string;              // POEM version (from package.json)
  mode: 'development' | 'production';  // POEM_DEV status from .env
  currentWorkflow: string | null;      // Active workflow name (future enhancement)
  gitBranch: string | null;     // Git branch (if in git repo)
  status: 'active' | 'inactive' | 'stale' | 'missing';  // Health status
  metadata: {
    lastServerRun?: string;     // Last time server was started (future)
    workflowCount?: number;     // Number of workflows (future)
    promptCount?: number;       // Number of prompts (future)
  };
}
```

**Status Definitions**:
- `active`: Installation exists, recently accessed (< 7 days)
- `inactive`: Installation exists, not recently accessed (7-30 days)
- `stale`: Installation exists, very old (> 30 days)
- `missing`: Path no longer exists (needs cleanup)

**Installation ID Generation**:
- Extract meaningful name from path
- Example: `/clients/supportsignal/prompt.supportsignal.com.au` → `ss-prompt`
- Example: `/ad/flivideo/vibedeck` → `vibedeck`
- If unable to extract, use pattern: `installation-{port}` or `installation-{timestamp}`

### Architecture Context: Error Handling and User Experience

[Source: docs/architecture/coding-standards.md#critical-rules]

**Error Context Requirements** (line 15):
- All errors must include: error type, message, relevant context
- For registry operations: include file path, operation attempted

**Graceful Degradation** (line 19):
- If registry file corrupted: delete and recreate with warning
- If home directory not writable: warn but continue (registry features disabled)
- If registry read fails: treat as empty registry

**User Experience Principles** (from user conversation):
- Registry should be "invisible infrastructure"
- Normal operations (install/config) should not mention registry explicitly
- Only show registry information when:
  - Port conflict detected (show which installation uses the port)
  - User explicitly uses debug commands (registry --list, etc.)
- Success messages should be minimal: "✓ Registered in ~/.poem/registry.json" (one line)

**Error Message Pattern**:
```javascript
// Port conflict example:
console.error('\n⚠️  Port 9500 is already allocated to:');
console.error('   [ss-prompt] /clients/supportsignal/prompt...');
console.log('\n   Suggested available ports: 9510, 9520, 9530');
console.log('   Override with: npx poem-os install --port=9510\n');
```

### Architecture Context: CLI Command Patterns

[Source: Story 1.7 implementation and docs/architecture/coding-standards.md]

**Command Router Pattern** (`bin/install.js`):
```javascript
const { command, flags } = parseArgs();
switch (command) {
  case 'install':
  case '':  // Default to install
    await handleInstall(flags);
    break;
  case 'start':
    await handleStart(flags);
    break;
  case 'config':
    await handleConfig(flags);
    break;
  case 'registry':  // NEW in this story
    await handleRegistry(flags);
    break;
  default:
    console.error(`Unknown command: ${command}`);
    process.exit(1);
}
```

**Registry Subcommands** (flags-based dispatch):
```javascript
async function handleRegistry(flags) {
  if (flags.list) {
    await registryList();
  } else if (flags.refresh) {
    await registryRefresh();
  } else if (flags.clean) {
    await registryClean();
  } else if (flags['check-port']) {
    await checkPortAvailability(flags['check-port']);
  } else {
    console.error('Usage: npx poem-os registry [--list | --refresh | --clean | --check-port PORT]');
    process.exit(1);
  }
}
```

**Help Output Update**:
```javascript
function showHelp() {
  console.log(`
Usage: npx poem-os <command> [flags]

Commands:
  install               Install POEM into current directory
  start                 Start POEM server
  config --port PORT    Configure server settings
  registry --list       List all POEM installations (debug)
  registry --refresh    Refresh registry from filesystem (debug)
  registry --clean      Remove stale registry entries (debug)
  registry --check-port Check if port is available (debug)

Flags:
  --port PORT          Specify custom port (1024-65535)
  --force              Force overwrite during installation
  --help               Show this help message
`);
}
```

### File Locations

[Source: docs/architecture/unified-project-structure.md]

**Files to Create**:
- `~/.poem/registry.json` - Registry data (created during first install)
- `docs/architecture/installation-registry.md` - Registry architecture documentation
- `tests/bin/registry.test.ts` - Registry utility tests
- `tests/bin/port-conflict.test.ts` - Port conflict detection tests
- `tests/bin/install-with-registry.test.ts` - Integration tests for installation
- `tests/bin/registry-commands.test.ts` - Registry CLI command tests

**Files to Modify**:
- `bin/install.js` - Add registry command handler, integrate registration, port conflict checks
- `bin/utils.js` - Add registry utility functions
- `packages/poem-app/astro.config.mjs` - Change default port 4321 → 9500
- `README.md` - Update port references, add registry section
- `CLAUDE.md` - Update setup instructions with new port
- `docs/architecture.md` - Update environment variable documentation
- `docs/architecture/unified-project-structure.md` - Document ~/.poem/ directory

**Project Structure** (bin/ location):
```
poem-os/poem/
├── bin/
│   ├── install.js         # MODIFY: Add registry integration
│   └── utils.js           # MODIFY: Add registry utility functions
├── packages/
│   └── poem-app/
│       └── astro.config.mjs   # MODIFY: Change default port
└── tests/
    └── bin/
        ├── registry.test.ts              # CREATE
        ├── port-conflict.test.ts         # CREATE
        ├── install-with-registry.test.ts # CREATE
        └── registry-commands.test.ts     # CREATE
```

### Technical Constraints

[Source: docs/architecture/tech-stack.md]

**Node.js Version**: 22.x LTS (line 20)
- `os.homedir()` available in all Node versions
- `fs.promises` API for async file operations
- Path manipulation: `path.join()`, `path.resolve()`

**Cross-Platform Considerations**:
- Home directory: `os.homedir()` works on Windows/macOS/Linux
- Path separators: Always use `path.join()` (never hardcode `/` or `\`)
- Directory creation: `fs.mkdir(dir, { recursive: true })` creates parent directories

**File Operations**:
- Read: `fs.readFile(path, 'utf-8')`
- Write: `fs.writeFile(path, content, 'utf-8')` (atomic on most systems)
- Check existence: `fs.access(path)` or catch ENOENT errors

**JSON Handling**:
- Parse: `JSON.parse(content)` with try/catch for corrupted files
- Stringify: `JSON.stringify(data, null, 2)` for human-readable format

### Testing

[Source: docs/architecture/testing-strategy.md]

**Test Framework**: Vitest 4.x (lines 28, 274)

**Test Organization** (lines 256-265):
```
tests/
└── bin/
    ├── registry.test.ts              # Unit tests for registry utilities
    ├── port-conflict.test.ts         # Unit tests for conflict detection
    ├── install-with-registry.test.ts # Integration: full install flow
    └── registry-commands.test.ts     # Integration: CLI commands
```

**Coverage Targets** (lines 267-270):
- bin/ scripts: 80% coverage target
- Focus on utility functions (validation, file operations)
- Cross-platform behavior via CI matrix

**Test Standards** (lines 85-149):
- Use Vitest for unit and integration tests
- Include edge case testing (missing files, invalid input, boundary conditions)
- Mock file system operations where appropriate
- Test error handling paths (corrupted JSON, missing home directory)

**Critical Test Cases**:
1. **Registry Read/Write**:
   - Empty registry (first installation)
   - Existing registry with multiple entries
   - Corrupted JSON (should delete and recreate)
   - Missing home directory (graceful degradation)

2. **Port Conflict Detection**:
   - No conflict (port available)
   - Conflict found (port in use)
   - Suggest alternative ports (test algorithm: 9500 used → suggest 9510, 9520, 9530)
   - Multiple ports used (9500, 9510 used → suggest 9520, 9530, 9540)
   - Empty registry (no conflicts possible, suggest 9500, 9510, 9520)

3. **Auto-Registration**:
   - First installation (create registry)
   - Re-install existing installation (update entry)
   - Multiple installations (append to registry)

4. **Registry CLI Commands**:
   - `--list`: Display empty registry, display populated registry
   - `--refresh`: Mark missing installations, update lastChecked
   - `--clean`: Remove missing entries
   - `--check-port`: Port available, port in use

5. **Cross-Platform**:
   - Test on macOS (development)
   - Test on Linux (CI)
   - Test on Windows (CI)

**Example Test Structure**:
```typescript
// tests/bin/registry.test.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { readRegistry, writeRegistry, checkPortConflict, suggestAvailablePorts } from '../../bin/utils.js';

describe('Registry Utilities', () => {
  describe('readRegistry', () => {
    it('should return default registry if file does not exist', async () => {
      const registry = await readRegistry();
      expect(registry.version).toBe('1.0');
      expect(registry.installations).toEqual([]);
    });

    it('should parse existing registry file', async () => {
      // Setup: Create mock registry file
      // Test: Read registry
      // Assert: Parsed correctly
    });

    it('should recreate registry if JSON is corrupted', async () => {
      // Setup: Write invalid JSON
      // Test: Read registry
      // Assert: Default registry returned, file recreated
    });
  });

  describe('checkPortConflict', () => {
    it('should return no conflict if port is available', async () => {
      // Setup: Empty registry
      // Test: Check port 9500
      // Assert: No conflict
    });

    it('should return conflict if port is in use', async () => {
      // Setup: Registry with entry using port 9500
      // Test: Check port 9500
      // Assert: Conflict found with installation details
    });
  });

  describe('suggestAvailablePorts', () => {
    it('should suggest default ports when registry is empty', async () => {
      // Setup: Empty registry
      // Test: Get suggestions
      // Assert: Returns [9500, 9510, 9520]
    });

    it('should suggest next available ports when 9500 is used', async () => {
      // Setup: Registry with port 9500 used
      // Test: Get suggestions
      // Assert: Returns [9510, 9520, 9530]
    });

    it('should skip used ports and suggest next available', async () => {
      // Setup: Registry with ports 9500, 9510 used
      // Test: Get suggestions
      // Assert: Returns [9520, 9530, 9540]
    });

    it('should return top 3 suggestions in increments of 10', async () => {
      // Setup: Registry with ports 9500, 9520, 9540 used
      // Test: Get suggestions
      // Assert: Returns [9510, 9530, 9550]
    });
  });
});
```

## Change Log

| Date       | Version | Description            | Author         |
| ---------- | ------- | ---------------------- | -------------- |
| 2026-01-20 | 1.0     | Story created (Draft)  | Bob (SM Agent) |
| 2026-01-20 | 1.1     | Reordered ACs to emphasize port conflict detection as primary purpose; Added explicit "Registry Purpose and Workflow" section; Added port suggestion algorithm (increments of 10); Updated test cases | Sarah (PO Agent) |

## Dev Agent Record

_(This section will be populated by the development agent during implementation)_

### Agent Model Used

_(To be filled by Dev Agent)_

### Debug Log References

_(To be filled by Dev Agent)_

### Completion Notes

_(To be filled by Dev Agent)_

### File List

_(To be filled by Dev Agent)_

## QA Results

_(This section will be populated by QA Agent after story completion)_

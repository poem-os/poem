# Story 3.3 - Acceptance Test Guide

## Quick Summary

**Story**: Implement Refine Prompt Workflow
**Status**: Review
**Test Focus**: Validate that the refine-prompt workflow YAML file is correctly defined with 10 workflow steps covering all acceptance criteria

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review"
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`
- [ ] Node.js 22.x LTS installed
- [ ] Dependencies installed (`npm install` in workspace root)

**Environment Setup:**

- Node.js: 22.x LTS
- Working directory: `poem/packages/poem-app` (for tests) or `poem/packages/poem-core` (for workflow file)
- Test framework: Vitest 4.x

**Important Note:**
This story implements a workflow DEFINITION file (YAML), not runtime code. Testing focuses on:
1. File existence and structure (Terminal tests)
2. YAML validation via unit tests (Terminal tests)
3. Workflow execution testing is deferred (requires Prompt Engineer agent runtime - future story)

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Workflow file exists in correct location

**What to test**: Workflow file created at `packages/poem-core/workflows/refine-prompt.yaml`

**Command**:

```bash
ls -lh /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

**Expected Output**:

```
-rw-r--r--  1 {user}  staff   {size}K {date} {time} /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

**Validation**:

- ‚úÖ File exists (no "No such file or directory" error)
- ‚úÖ File size > 10KB (substantial workflow definition)
- ‚úÖ File has read permissions

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test B: AC1 - Workflow YAML parses correctly

**What to test**: YAML file has valid syntax and can be parsed

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npm test -- tests/workflows/refine-prompt.test.ts --reporter=verbose
```

**Expected Output**:

```
 ‚úì tests/workflows/refine-prompt.test.ts (31 tests)
   ‚úì Workflow YAML Structure
     ‚úì should parse workflow YAML correctly
     ‚úì should have required top-level fields
     ‚úì should have pathResolution set to config
     ...
   ‚úì Step Structure Validation
     ...
   ‚úì Workflow Steps Coverage
     ...

 Test Files  1 passed (1)
      Tests  31 passed (31)
```

**Validation**:

- ‚úÖ All 31 tests pass
- ‚úÖ No parsing errors
- ‚úÖ Test execution time < 1 second
- ‚úÖ No test failures

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC1 - Workflow has correct metadata

**What to test**: Workflow id, name, version, author fields are correct

**Command**:

```bash
grep -A 5 "^id:" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

**Expected Output**:

```
id: refine-prompt
name: Refine Existing Prompt
version: "1.0.0"
author: POEM Framework
lastUpdated: "2026-01-09"
```

**Validation**:

- ‚úÖ `id` is "refine-prompt"
- ‚úÖ `name` is "Refine Existing Prompt"
- ‚úÖ `version` follows semantic versioning
- ‚úÖ `author` is "POEM Framework"
- ‚úÖ `lastUpdated` is valid date (YYYY-MM-DD)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: AC1 - Path resolution configured correctly

**What to test**: Workflow uses `pathResolution: config` (not hardcoded paths)

**Command**:

```bash
grep "pathResolution:" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

**Expected Output**:

```
pathResolution: config
```

**Validation**:

- ‚úÖ Contains `pathResolution: config`
- ‚úÖ No `paths:` section exists (verify with `grep "^paths:" file` returns nothing)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test E: AC2-6 - Workflow has required steps

**What to test**: All 10 workflow steps exist with correct IDs

**Command**:

```bash
grep "  - id:" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

**Expected Output**:

```
  - id: select-prompt
  - id: load-template
  - id: render-current
  - id: modification-method
  - id: apply-modifications
  - id: re-render
  - id: confirm-save
  - id: track-iteration
  - id: continue-refining
  - id: complete
```

**Validation**:

- ‚úÖ 10 steps total
- ‚úÖ Step IDs match expected workflow sequence
- ‚úÖ `select-prompt` (AC2: loads existing prompt)
- ‚úÖ `load-template` (AC2, AC3: loads and displays)
- ‚úÖ `render-current` (AC4: renders with data)
- ‚úÖ `modification-method` + `apply-modifications` (AC5: modify template)
- ‚úÖ `re-render` + `confirm-save` (AC6: save and compare)
- ‚úÖ `track-iteration` (AC7: iteration history)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test F: AC7 - Optional iteration history step exists

**What to test**: track-iteration step is present and marked optional

**Command**:

```bash
grep -A 10 "id: track-iteration" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml | head -15
```

**Expected Output**:

```
  - id: track-iteration
    name: Track Iteration History
    type: action
    action: optional
    condition:
      check: changesSaved
      matches: "true"
```

**Validation**:

- ‚úÖ Step exists with id `track-iteration`
- ‚úÖ Type is `action`
- ‚úÖ Has `action: optional` or marked optional in instruction
- ‚úÖ Conditional execution based on `changesSaved`

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test G: Test file exists and has correct structure

**What to test**: Unit test file created with comprehensive coverage

**Command**:

```bash
ls -lh /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/tests/workflows/refine-prompt.test.ts
```

**Expected Output**:

```
-rw-r--r--  1 {user}  staff   {size}K {date} {time} /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/tests/workflows/refine-prompt.test.ts
```

**Validation**:

- ‚úÖ File exists
- ‚úÖ File size > 5KB (substantial test coverage)
- ‚úÖ Located in correct directory

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test H: Count of test cases

**What to test**: Test file contains 31 test cases (per implementation)

**Command**:

```bash
grep -c "  it(" /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app/tests/workflows/refine-prompt.test.ts
```

**Expected Output**:

```
31
```

**Validation**:

- ‚úÖ Exactly 31 test cases
- ‚úÖ Tests cover: YAML structure, step validation, AC coverage, path resolution, outputs, metadata

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

### AC2-7: Workflow Execution Testing

**What cannot be tested**: Actual workflow execution (loading prompts, rendering, modifying, saving)

**Reason**: Requires Prompt Engineer agent runtime to execute workflow steps. This story only implements the workflow DEFINITION (YAML file).

**When testable**: When Prompt Engineer agent (`/poem/agents/penny`) can execute the `*refine {prompt-name}` command and interpret workflow steps.

**What was tested instead**:
- Workflow YAML structure validation (31 unit tests)
- Step definitions exist for all ACs
- Correct workflow metadata and configuration

**Future testing approach**:
Once Prompt Engineer agent is functional:
1. Create a test prompt in `dev-workspace/prompts/test-prompt.hbs`
2. Run: `/poem/agents/penny` then `*refine test-prompt`
3. Verify each step executes correctly:
   - Prompt selection works
   - Template displays correctly
   - Rendering with mock data works
   - Inline/file modification options work
   - Re-render shows comparison
   - Save functionality works
   - Iteration history created (optional)

---

## üßë Human Tests (Visual/Manual)

**Note**: This story has NO human visual tests. It implements a workflow definition file (YAML), not a UI or visual component.

All testing is via Terminal Tests (automated unit tests and file validation).

---

## Test Checklist

Copy this checklist to track overall progress:

**Terminal Tests:**

- [ ] Test A: Workflow file exists
- [ ] Test B: YAML parses correctly (31 unit tests pass)
- [ ] Test C: Workflow metadata correct
- [ ] Test D: Path resolution configured
- [ ] Test E: Required workflow steps exist
- [ ] Test F: Optional iteration history step exists
- [ ] Test G: Test file exists
- [ ] Test H: 31 test cases present

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Tests fail with "Cannot find module 'yaml'"

**Symptom**: Import error when running tests

**Solution**:
```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem
npm install
cd packages/poem-app
npm install
```

---

### Issue: File not found when checking workflow

**Symptom**: `ls: cannot access ...refine-prompt.yaml: No such file or directory`

**Solution**: Ensure you're in the correct directory. The file is at:
```
/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-core/workflows/refine-prompt.yaml
```

---

### Issue: Tests pass but show 0 tests

**Symptom**: `Test Files  0 passed`

**Solution**: Specify the correct test file path:
```bash
npm test -- tests/workflows/refine-prompt.test.ts
```

---

### Issue: grep shows no output

**Symptom**: grep command returns nothing

**Solution**: Check absolute path is correct, or use relative path from working directory:
```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem
grep "pathResolution:" packages/poem-core/workflows/refine-prompt.yaml
```

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:

- Terminal Tests: __ / 8 passed
- Human Tests: N/A (0 tests)
- Total: __ / 8 passed

**Issues Found**:

1. _________________
2. _________________

**Sign-off**: ‚¨ú Story accepted | ‚¨ú Issues require fixes

---

## Notes for Next Story

This story created the workflow DEFINITION. To actually USE the refine-prompt workflow:

1. **Prompt Engineer agent** must be functional (`/poem/agents/penny`)
2. **Workflow interpreter** must be implemented (reads YAML and guides user through steps)
3. **Test manually** by running `*refine {prompt-name}` via agent

The workflow is READY for execution, but execution testing requires agent runtime (future story).

**Workflow can be installed** via NPX installer to become `.poem-core/workflows/refine-prompt.yaml` in production.

---

_Generated by SAT Guide Creator from Story 3.3_

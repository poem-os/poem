# Story 3.9: Add Capability Explorer Command to Victor Agent

## Status

Ready

## Story

**As a** prompt engineer, developer, or new POEM user,
**I want** to query what POEM can do through a unified interface,
**so that** I can discover capabilities without manually searching across multiple documents (Epic Capabilities, Stories, Victor artifacts, KDD docs).

## Background

**Context**: Issue #15 from `docs/planning/gap-analysis/usage-issues.jsonl` identified that users cannot easily discover what POEM can do. Capability information is distributed across:
- Victor's validation artifacts (functional status)
- Epic Capabilities document (planned features)
- Story files (implementation status)
- Lisa's KDD topology (usage patterns and learnings)
- Architecture documents (technical capabilities)

**Pragmatic Solution**: Add `*capability-explorer` command to Victor agent as a temporary enhancement. This command reads from all capability sources and provides query interface. Document this as technical debt with plan to extract to dedicated Capability Explorer agent if query logic complexity grows beyond ~20% of Victor's codebase.

**References**:
- Requirements: `/private/tmp/claude/.../scratchpad/unified-capability-query-requirements.md` (40-page detailed spec)
- Victor agent: `.claude/commands/poem/agents/victor.md`
- KDD topology: `docs/kdd/index.md`
- Epic Capabilities: `docs/prd/epic-capabilities.md`

## Acceptance Criteria

1. Victor agent gains `*capability-explorer` command that accepts natural language queries
2. Command queries four data sources: Victor artifacts, Story files, KDD docs, Epic Capabilities
3. Supports query types: "list all", "can POEM do X?", "find similar to X", "what's blocking story Y?"
4. Returns results with capability status indicators (‚úÖ Functional, üîÑ In Progress, üìÖ Planned, ‚ö†Ô∏è Partial, ‚ùå Not Available)
5. Query results include story references, validation status, and KDD documentation links
6. Command reads Lisa's KDD topology (patterns, learnings, decisions) as additional context source
7. Results include practical usage information: commands to use, examples, documentation links
8. Fast query response (<3 seconds for typical queries)
9. Victor agent definition updated with new command documentation
10. Technical debt documented: "Extract to Capability Explorer agent if complexity exceeds 20% of Victor's code"
11. Help system updated to include `*capability-explorer` command description
12. Query command is optional and does not interfere with Victor's primary validation role

## Tasks / Subtasks

- [x] Task 1: Design Capability Data Reader (AC: 2, 6)
  - [x] Create data reader utility in `packages/poem-core/utils/capability-reader.ts`
  - [x] Implement Story file parser (reads Status, Acceptance Criteria)
  - [x] Implement Victor artifacts reader (reads integration-matrix.md, test-reports/)
  - [x] Implement KDD topology reader (reads docs/kdd/patterns/, learnings/, decisions/)
  - [x] Implement Epic Capabilities parser (reads docs/prd/epic-capabilities.md)
  - [x] Return unified capability records with status, references, documentation links

- [x] Task 2: Implement Query Engine (AC: 1, 3, 4)
  - [x] Create query engine in `packages/poem-core/utils/query-engine.ts`
  - [x] Implement "list all" query (returns categorized capabilities)
  - [x] Implement "can do X" query (exact match + near-matches)
  - [x] Implement "find similar" query (keyword matching with similarity scores)
  - [x] Implement "find blockers" query (story dependency resolution)
  - [x] Support natural language query parsing
  - [x] Return results with status indicators (‚úÖ üîÑ üìÖ ‚ö†Ô∏è ‚ùå)

- [x] Task 3: Add Command to Victor Agent (AC: 1, 9, 11, 12)
  - [x] Update `.claude/commands/poem/agents/victor.md` to add `*capability-explorer` command
  - [x] Update commands list in YAML block
  - [x] Add command description: "Query POEM capabilities (natural language supported)"
  - [x] Update `*help` display to include new command
  - [x] Ensure command is clearly marked as "secondary skill" not core validation

- [ ] Task 4: Implement Query Response Formatting (AC: 5, 7)
  - [ ] Create response formatter in `packages/poem-core/utils/response-formatter.ts`
  - [ ] Format "list all" results (grouped by category, status icons)
  - [ ] Format "can do X" results (YES/NO + details + usage instructions)
  - [ ] Format "find similar" results (ranked list with % similarity)
  - [ ] Format "find blockers" results (dependency tree with recommendations)
  - [ ] Include story references as clickable links
  - [ ] Include KDD documentation links (patterns, learnings, decisions)
  - [ ] Include practical usage: commands, examples, docs references

- [ ] Task 5: Test Query System (AC: 8)
  - [ ] Test "list all capabilities" query (<3s response)
  - [ ] Test "can POEM chain prompts?" query (finds Story 3.8)
  - [ ] Test "find similar to X" query (returns near-matches with scores)
  - [ ] Test "what's blocking story 4.3?" query (identifies dependencies)
  - [ ] Test KDD topology reading (reads patterns, learnings, decisions)
  - [ ] Verify status indicators are accurate (compare to actual story status)
  - [ ] Test with empty/incomplete data sources (graceful degradation)

- [ ] Task 6: Document Technical Debt (AC: 10)
  - [ ] Add comment in victor.md: "Temporary enhancement - extract to Capability Explorer agent if complexity grows"
  - [ ] Document extraction trigger: Query logic exceeds 20% of Victor's codebase
  - [ ] Document extraction plan: Create dedicated Capability Explorer agent in Epic 6
  - [ ] Create architecture decision note in story: Why Victor enhancement vs new agent?
  - [ ] Note in Dev Notes: This is stopgap solution, not permanent architecture

- [ ] Task 7: Update Documentation (AC: 9, 11)
  - [ ] Update Victor agent help text with `*capability-explorer` command
  - [ ] Add usage examples to Victor's command documentation
  - [ ] Document query syntax: natural language vs structured queries
  - [ ] Update CLAUDE.md to mention capability query feature
  - [ ] Cross-reference Issue #15 as resolved by this story

## Dev Notes

### Context from Conversation

**User Intent**: Add pragmatic capability query system to Victor agent as temporary enhancement. Keep implementation simple, document as technical debt for future extraction.

**Data Sources** (prioritize reading from these in order):
1. **Victor artifacts** (`dev-workspace/`): integration-matrix.md, test-reports/, feedback-for-bmad.md
2. **Story files** (`docs/stories/`): Status field, Acceptance Criteria, Dev Agent Record
3. **KDD topology** (`docs/kdd/`): patterns/, learnings/, decisions/, index.md
4. **Epic Capabilities** (`docs/prd/epic-capabilities.md`): Planned features table

**Implementation Approach**:
- Create utilities in `packages/poem-core/utils/` (not poem-app, this is framework logic)
- Keep query logic simple (keyword matching, no complex NLP/embeddings)
- Focus on 4 query types: list all, can do X, find similar, find blockers
- Response time target: <3 seconds
- Graceful degradation if data sources missing/malformed

### Previous Story Context

**Story 3.8** (Multi-Workflow Foundation) completed successfully:
- Workflow-scoped directory structure working
- Penny has `*workflows`, `*switch`, `*context` commands
- Config service resolves workflow-scoped paths
- [Source: Story 3.8 completion notes]

**Relevant Pattern**: Story 3.8 added commands to existing agent (Penny) - same pattern applies here for Victor.

### Victor Agent Architecture

**Location**: `.claude/commands/poem/agents/victor.md` (slash command wrapper)
**Core Definition**: Embedded YAML block with persona, commands, dependencies
**Current Commands**: *validate, *regression, *progression, *integration, *progress-report, *snapshot, *compare-milestones, *update-matrix, *generate-feedback, *help, *exit
[Source: `.claude/commands/poem/agents/victor.md` lines 88-99]

**Command Addition Pattern**:
- Add new command to `commands:` list in YAML block (line 88-99)
- Command format: `command-name: Description of what it does`
- Use natural language description, keep concise
- Prefix with `*` when using (e.g., `*capability-explorer`)

**Victor's Primary Role**: Product Integration QA - Workflow Validator
**Victor's Focus**: Regression prevention, capability integration, cumulative progress tracking
**This Enhancement**: Secondary skill, does not interfere with validation role
[Source: `.claude/commands/poem/agents/victor.md` lines 60-73]

### KDD Topology Structure

**Location**: `docs/kdd/`
**Structure**:
- `index.md` - Navigation and overview
- `meta/` - Meta-documentation (kdd-workflow-guide.md, validation rules)
- `learnings/` - Story-specific insights (*.md files)
- `decisions/` - Architecture Decision Records (ADR-*.md files)
- `patterns/` - Reusable patterns (*.md files after 3+ uses)
[Source: `docs/kdd/index.md` lines 7-19]

**Reading Strategy**:
- Read index.md first to understand structure
- Scan learnings/, decisions/, patterns/ directories for file lists
- Parse markdown files for capability mentions
- Extract links between KDD docs and story files

### Project Structure

**Development Paths** (use these, NOT installed paths):
- Victor agent: `.claude/commands/poem/agents/victor.md`
- Utility modules: `packages/poem-core/utils/{module-name}.ts`
- Story files: `docs/stories/{epic}.{story}.story.md`
- KDD docs: `docs/kdd/{category}/{filename}.md`
- PRD files: `docs/prd/epic-capabilities.md`, `docs/prd/epic-details.md`
[Source: `docs/architecture/unified-project-structure.md` lines 7-23]

**CRITICAL**: All development happens in `packages/` directory, not `.poem-core/` or `.poem-app/` (those are installed copies).

### Tech Stack

**Language**: TypeScript 5.9.x (type-safe)
**Runtime**: Node.js 22.x LTS
**File Operations**: Node.js `fs/promises` module
**Markdown Parsing**: No special parser needed (simple regex for headings/lists)
**JSON Parsing**: Native JSON.parse() for status files
[Source: `docs/architecture/tech-stack.md` lines 19-20]

### Naming Conventions

**Utility Files**: kebab-case.ts (e.g., `capability-reader.ts`, `query-engine.ts`)
**Functions**: camelCase (e.g., `readCapabilities`, `querySystem`)
**Interfaces**: PascalCase (e.g., `CapabilityRecord`, `QueryResult`)
[Source: `docs/architecture/coding-standards.md` lines 23-32]

### Coding Standards

**File-Based Everything**: All data read from files, no database
**Error Context**: Include file path, line number for parse errors
**Graceful Degradation**: Missing files should not crash query system
**Fast Queries**: <3 second response time (NFR2)
[Source: `docs/architecture/coding-standards.md` lines 7-20]

### Query Result Format

**Status Indicators**:
- ‚úÖ **Functional**: Story Done + Victor validated
- üîÑ **In Progress**: Story status = InProgress or Review
- üìÖ **Planned**: Story in PRD but not yet created
- ‚ö†Ô∏è **Partial**: Story Done but validation has concerns
- ‚ùå **Not Available**: No story, no plan

**Result Structure** (TypeScript interface):
```typescript
interface CapabilityQueryResult {
  query: string;
  matchType: 'exact' | 'partial' | 'none';
  capabilities: {
    name: string;
    status: '‚úÖ' | 'üîÑ' | 'üìÖ' | '‚ö†Ô∏è' | '‚ùå';
    story?: string; // e.g., "3.8"
    validation?: 'passed' | 'concerns' | 'failed';
    description: string;
    usage?: {
      commands: string[];
      examples: string[];
      docs: string[];
    };
    kddLinks?: {
      patterns: string[];
      learnings: string[];
      decisions: string[];
    };
  }[];
}
```

### Technical Debt Documentation

**Rationale for Victor Enhancement** (vs New Agent):
- Pragmatic: Gets capability query working immediately
- Reuses Victor's knowledge of validation artifacts
- Smaller scope than full Capability Explorer agent (20-28 hours MVP vs new agent)

**When to Extract**:
- Query logic exceeds ~200 lines or 20% of Victor's total code
- Query features expand beyond 4 basic types
- Performance becomes an issue (queries >3 seconds)
- User requests dedicated capability agent

**Extraction Plan**:
- Create new `capability-explorer.md` agent in Epic 6 (Agent System)
- Move query utilities to dedicated agent dependencies
- Victor keeps `*progress-report`, delegates to Capability Explorer for general queries

### Testing

**Test File Location**: `packages/poem-app/tests/utils/` (even though utils in poem-core, tests go in poem-app)
**Test Framework**: Vitest 4.x
**Test Files**: `capability-reader.test.ts`, `query-engine.test.ts`
[Source: `docs/architecture/tech-stack.md` line 28, `docs/architecture/unified-project-structure.md` lines 124-131]

**Test Cases**:
1. Read capabilities from all 4 sources (Victor, Stories, KDD, Epic Capabilities)
2. Query "list all" returns categorized capabilities
3. Query "can POEM do X" finds Story 3.8 for "chain prompts"
4. Query "find similar" returns ranked near-matches
5. Query "find blockers" identifies story dependencies
6. Graceful handling of missing files
7. Response time <3 seconds

**Test Data Needed**:
- Sample story files in various states (Done, InProgress, Draft)
- Sample Victor integration-matrix.md
- Sample KDD documents (patterns, learnings, decisions)
- Sample Epic Capabilities markdown table

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created via AppyDave Workflow | Bob (SM) |

## Dev Agent Record

<!-- This section is populated by the development agent during implementation -->

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

<!-- This section is populated by Quinn (QA Agent) during review -->

(To be filled by QA Agent)

## Knowledge Assets

<!-- Lisa (Librarian) updates this section during knowledge curation -->

**Patterns Created**:
- (None yet)

**Learnings Documented**:
- (None yet)

**Decisions (ADRs)**:
- (None yet)

**Examples Created**:
- (None yet)

**Knowledge Extraction Status**: Not yet curated

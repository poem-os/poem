# Story 3.5 - Acceptance Test Guide

## Quick Summary

**Story**: Implement Validate Prompt Workflow
**Status**: Review
**Test Focus**: Validate that validate-prompt.yaml workflow file is correctly structured and unit tests pass

**Key Note**: This story creates a YAML workflow definition for agent-interpreted execution. Most acceptance criteria (AC2-AC7) validate **runtime behavior** when the Prompt Engineer agent (Penny) executes `*validate` command. Those tests will occur during workflow usage in future stories.

---

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review"
- [ ] Node.js 20+ installed
- [ ] Dependencies installed (`npm install` in project root)

**Environment Setup:**

- Node.js: 20.x LTS or higher
- Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`
- Test framework: Vitest 4.x

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Workflow file exists with correct structure

**What to test**: Validate that validate-prompt.yaml exists in correct location with proper YAML structure

**Command**:
```bash
cat packages/poem-core/workflows/validate-prompt.yaml | head -20
```

**Expected Output**:
```yaml
# Validate Prompt Workflow
# Validates prompt structure, schema alignment, helper registration, and best practices
#
# Executed by: Prompt Engineer agent (Penny) via *validate command
# Execution model: Agent-interpreted (steps guide agent behavior, not automated)
#
# Path resolution: Inherited from poem-core-config.yaml
# DO NOT add a paths: section - config service is the source of truth
# See: packages/poem-core/workflows/README.md for the pattern

id: validate-prompt
name: Validate Prompt Structure and Quality
version: "1.0.0"
author: POEM Framework
lastUpdated: "2026-01-11"

# Path resolution mode - indicates this workflow uses config for paths
pathResolution: config
```

**Validation**:
- ‚úÖ File exists at `packages/poem-core/workflows/validate-prompt.yaml`
- ‚úÖ Contains `id: validate-prompt`
- ‚úÖ Contains `pathResolution: config`
- ‚úÖ Has workflow header comments explaining execution model

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test B: AC1 - Workflow has 12 steps with correct IDs

**What to test**: Verify workflow contains all 12 validation steps

**Command**:
```bash
grep -E "^  - id:" packages/poem-core/workflows/validate-prompt.yaml
```

**Expected Output**:
```
  - id: select-prompt
  - id: load-template
  - id: validate-syntax
  - id: extract-placeholders
  - id: load-schemas
  - id: validate-input-schema
  - id: validate-helpers
  - id: check-best-practices
  - id: aggregate-results
  - id: validation-report
  - id: save-report
  - id: complete
```

**Validation**:
- ‚úÖ Exactly 12 step IDs present
- ‚úÖ Step IDs follow kebab-case naming
- ‚úÖ Steps cover: select, load, validate (syntax/schema/helpers), best practices, aggregate, report, save, complete

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC1 - Workflow does NOT define paths section

**What to test**: Verify workflow inherits paths from config (critical pattern)

**Command**:
```bash
grep -E "^paths:" packages/poem-core/workflows/validate-prompt.yaml
```

**Expected Output**:
```
(no output - paths section should NOT exist)
```

**Validation**:
- ‚úÖ No output from grep (no paths: section found)
- ‚úÖ Workflow uses `pathResolution: config` instead

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: Unit tests pass for validate-prompt workflow

**What to test**: All 42 unit tests for workflow structure validation pass

**Command**:
```bash
cd packages/poem-app && npm test -- validate-prompt.test.ts
```

**Expected Output** (abbreviated):
```
 RUN  v4.0.16 /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app

 ‚úì tests/workflows/validate-prompt.test.ts (42 tests) 10ms

 Test Files  1 passed (1)
      Tests  42 passed (42)
   Start at  HH:MM:SS
   Duration  ###ms
```

**Validation**:
- ‚úÖ All 42 tests passed
- ‚úÖ No test failures
- ‚úÖ Test file: `tests/workflows/validate-prompt.test.ts`
- ‚úÖ Test categories: YAML structure, step validation, AC coverage, path resolution

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test E: Verify test file exists and has correct structure

**What to test**: Test file exists at correct location

**Command**:
```bash
wc -l packages/poem-app/tests/workflows/validate-prompt.test.ts && head -10 packages/poem-app/tests/workflows/validate-prompt.test.ts
```

**Expected Output**:
```
     ### packages/poem-app/tests/workflows/validate-prompt.test.ts
import { describe, it, expect } from "vitest";
import { readFileSync } from "fs";
import { parse } from "yaml";
import { join } from "path";

describe("validate-prompt workflow", () => {
  const workflowPath = join(
    __dirname,
    "../../../poem-core/workflows/validate-prompt.yaml"
```

**Validation**:
- ‚úÖ Test file exists at `packages/poem-app/tests/workflows/validate-prompt.test.ts`
- ‚úÖ Uses Vitest framework
- ‚úÖ Loads and parses workflow YAML file
- ‚úÖ Contains describe block for "validate-prompt workflow"

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test F: Verify workflow file size is substantial (not stub)

**What to test**: Workflow file contains comprehensive step definitions

**Command**:
```bash
wc -l packages/poem-core/workflows/validate-prompt.yaml
```

**Expected Output**:
```
     712 packages/poem-core/workflows/validate-prompt.yaml
```

**Validation**:
- ‚úÖ File is approximately 700+ lines
- ‚úÖ Contains comprehensive step instructions (not just placeholders)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

The following acceptance criteria validate **runtime behavior** when the Prompt Engineer agent (Penny) executes the workflow. These will be tested during actual workflow usage.

**AC2**: Validates Handlebars syntax (no parse errors)
**Reason**: Requires Prompt Engineer agent to execute `*validate` command on actual prompt templates
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe syntax validation step

**AC3**: Validates all input placeholders have corresponding input schema fields and output structure matches output schema
**Reason**: Requires Prompt Engineer agent to execute workflow with prompts that have schemas
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe schema validation steps

**AC4**: Validates required helpers are registered
**Reason**: Requires Prompt Engineer agent to execute workflow and call `/api/helpers` endpoint
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe helper validation step

**AC5**: Checks for POEM best practices (configurable rules)
**Reason**: Requires Prompt Engineer agent to execute workflow and apply best practice rules
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe best practice check step

**AC6**: Reports issues with severity (error, warning, info)
**Reason**: Requires Prompt Engineer agent to execute workflow and aggregate results
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe severity categorization in report

**AC7**: Provides suggestions for fixing common issues
**Reason**: Requires Prompt Engineer agent to execute workflow and generate suggestions
**When**: Story 3.6+ or when using Prompt Engineer agent workflows
**How to test**: Run `/poem/agents/penny` ‚Üí `*validate {prompt-name}` ‚Üí Observe fix suggestions in report

---

## Test Checklist

Copy this checklist to track overall progress:

**Terminal Tests:**
- [ ] Test A: Workflow file exists with correct structure
- [ ] Test B: Workflow has 12 steps with correct IDs
- [ ] Test C: Workflow does NOT define paths section
- [ ] Test D: Unit tests pass (42 tests)
- [ ] Test E: Test file exists and has correct structure
- [ ] Test F: Workflow file size is substantial

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Test command not found

**Symptom**: `npm test` fails with "command not found"
**Solution**: Ensure you're in `packages/poem-app` directory and ran `npm install`

```bash
cd packages/poem-app
npm install
npm test -- validate-prompt.test.ts
```

---

### Issue: Workflow file not found

**Symptom**: `cat` command returns "No such file or directory"
**Solution**: Check you're in project root directory

```bash
# From project root (poem-os/poem/)
ls packages/poem-core/workflows/validate-prompt.yaml

# If file doesn't exist, story implementation may not be complete
```

---

### Issue: Unit tests fail

**Symptom**: Some tests fail when running `npm test`
**Solution**: Check test output for specific failures. If failures are in `validate-prompt.test.ts`, this indicates story implementation issues. If failures are in other test files (e.g., `watcher.test.ts`), these may be pre-existing flaky tests unrelated to Story 3.5.

```bash
# Run only validate-prompt tests
cd packages/poem-app
npm test -- validate-prompt.test.ts

# Expected: 42/42 passed
```

---

### Issue: grep returns no matches

**Symptom**: grep commands return empty output
**Solution**: Verify you're using correct file path and syntax

```bash
# Check file exists first
ls -la packages/poem-core/workflows/validate-prompt.yaml

# Use quotes around pattern if needed
grep -E "^  - id:" packages/poem-core/workflows/validate-prompt.yaml
```

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:
- Terminal Tests: _____ / 6 passed

**Issues Found**:
1. _________________
2. _________________

**Sign-off**: ‚úÖ Story accepted | ‚ùå Issues require fixes

---

## Notes for Future Testing

**When Prompt Engineer agent is available**, runtime workflow testing should validate:

1. **Workflow Execution Flow**:
   - Agent successfully loads workflow definition
   - Steps execute in correct sequence (1-12)
   - Elicitation steps prompt user for input
   - Action steps perform validation operations
   - Output steps display results

2. **Validation Capabilities**:
   - Syntax validation detects Handlebars parse errors
   - Schema validation compares placeholders with schema fields
   - Helper validation checks against registered helpers list
   - Best practice checks apply configurable rules
   - Severity categorization (error/warning/info) works correctly
   - Fix suggestions are generated appropriately

3. **Error Handling**:
   - Missing template files handled gracefully
   - Missing schema files handled with warnings
   - Invalid syntax reported with line numbers
   - API errors trigger fallback behavior

4. **Path Resolution**:
   - Development mode uses `dev-workspace/` paths
   - Production mode uses `poem/` paths
   - Mode detection works correctly
   - No hardcoded paths in workflow

---

_Generated by Taylor (SAT Guide Creator) from Story 3.5_

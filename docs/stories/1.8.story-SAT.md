# Story 1.8 - Acceptance Test Guide

## Quick Summary

**Story**: Installation Registry and Port Conflict Detection
**Status**: Ready for Testing (Updated after QA review - 2026-01-20)
**Test Focus**: POEM installations automatically register with port conflict detection, preventing port conflicts across multiple instances

**Recent Updates (Post-QA Review)**:
- âœ… 4 new automated integration tests added (AC2, AC10) - now 16 tests total
- âœ… Registry commands documented in README.md (lines 96-140)
- âœ… AC coverage improved from 82% to 100% (11/11 ACs)
- Human tests remain unchanged - same 8 manual tests

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Complete" or "Review"
- [ ] Node.js 22.x or higher installed
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem`
- [ ] No POEM servers currently running
- [ ] Clean test environment (can create test installations)

**Environment Setup:**

- Node.js: 22.x+
- Default Port: 9500 (changed from 4321)
- Registry Location: `~/.poem/registry.json`
- Working directory: Repository root

**Important Notes:**
- Registry is "invisible infrastructure" - most users won't interact with it directly
- Registry commands are debug/troubleshooting tools only
- Normal install/config operations should be silent about registry

---

## ğŸ§‘ Human Tests (Visual/Manual)

Tests requiring human observation - file inspection, terminal output, interactive behavior.

### Test 1: AC1 - Default port changed to 9500

**What to test**: Default port changed from 4321 to 9500 across all files

**Steps**:

1. Open `packages/poem-app/astro.config.mjs`
2. Locate the `server` configuration section (around line 36)
3. Observe the default port value
4. Open `README.md`
5. Search for port references (Ctrl+F "4321")
6. Observe all references now show 9500

**Expected Result**:
âœ… Port references updated:
- `astro.config.mjs`: `parseInt(process.env.PORT || "9500", 10)`
- `README.md`: "By default, POEM runs on port 9500"
- `README.md`: Examples show 9500 as default
- `CLAUDE.md`: References to localhost use 9500
- `docs/architecture.md`: Environment examples use 9500

**Evidence**:
- Screenshot or text confirmation of port values in each file
- No occurrences of "4321" as default port remain

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 2: AC2 - Installation registers in ~/.poem/registry.json

**What to test**: Installation process automatically creates registry entry

**Steps**:

1. Check if registry exists: `cat ~/.poem/registry.json` (may not exist yet)
2. Create a test installation directory: `mkdir -p /tmp/poem-test-install`
3. Navigate to test directory: `cd /tmp/poem-test-install`
4. Run installation: `npx poem-os@latest install --app --force` (from local dev if testing unpublished)
5. Accept default port 9500 when prompted
6. Check registry file: `cat ~/.poem/registry.json`
7. Observe JSON structure

**Expected Result**:
âœ… Registry file created with valid JSON:
- File exists at `~/.poem/registry.json`
- Contains `version` field ("1.0")
- Contains `installations` array
- New installation entry includes:
  - `id` (e.g., "poem-test-install")
  - `path` ("/tmp/poem-test-install")
  - `port` (9500)
  - `installedAt` (ISO timestamp)
  - `lastChecked` (ISO timestamp)
  - `version` ("0.1.0")
  - `mode` ("production" or "development")
  - `gitBranch` (null or branch name if git repo)
  - `status` ("active")
  - `metadata` object

**Evidence**:
- Terminal output showing successful installation
- Contents of `~/.poem/registry.json` file
- Single line log: "âœ“ Registered in ~/.poem/registry.json"

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 3: AC3 - Port conflict detection during install

**What to test**: Install detects port conflicts and suggests alternatives

**Steps**:

1. Ensure you have an existing installation on port 9500 (from Test 2)
2. Create another test directory: `mkdir -p /tmp/poem-test-conflict`
3. Navigate to directory: `cd /tmp/poem-test-conflict`
4. Run installation: `npx poem-os@latest install --app --force`
5. When prompted for port, press Enter (default 9500)
6. Observe terminal output for conflict warning
7. Observe suggested alternative ports

**Expected Result**:
âœ… Port conflict detected and displayed:
- Warning message: "âš ï¸  Port 9500 is already allocated to:"
- Shows installation ID and path: "[poem-test-install] /tmp/poem-test-install"
- Shows suggested ports: "Suggested available ports: 9510, 9520, 9530"
- Prompts for port again
- Entering "9510" proceeds successfully
- Installation registers with port 9510

**Evidence**:
- Screenshot of conflict warning message
- Terminal showing suggested ports (9510, 9520, 9530)
- Registry entry with port 9510 for second installation

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 4: AC4 - Port conflict detection during config --port

**What to test**: Config command detects port conflicts

**Steps**:

1. Navigate to second test installation: `cd /tmp/poem-test-conflict`
2. Attempt to change port to 9500: `npx poem-os config --port 9500`
3. Observe terminal output

**Expected Result**:
âœ… Port conflict detected and rejected:
- Error message: "âš ï¸  Port 9500 is already allocated to:"
- Shows conflicting installation: "[poem-test-install] /tmp/poem-test-install"
- Shows suggested ports: "Suggested available ports: 9510, 9520, 9530"
- Command exits with error (code 1)
- Registry not updated with conflicting port

**Evidence**:
- Terminal output showing conflict error
- Suggested alternative ports displayed
- Command exits without updating .env

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 5: AC6 - Registry operations are silent

**What to test**: Normal operations don't clutter output with registry details

**Steps**:

1. Create fresh test directory: `mkdir -p /tmp/poem-silent-test`
2. Navigate: `cd /tmp/poem-silent-test`
3. Run installation: `npx poem-os@latest install --app --force`
4. Accept suggested port (should be 9520 if 9500/9510 occupied)
5. Observe terminal output carefully
6. Count registry-related messages

**Expected Result**:
âœ… Registry operations are minimal and non-intrusive:
- Installation proceeds normally
- Only ONE registry message: "âœ“ Registered in ~/.poem/registry.json"
- No verbose registry operations displayed
- No "Reading registry..." or "Writing registry..." messages
- No port conflict checks displayed (unless conflict exists)
- Success message focuses on installation, not registry

**Evidence**:
- Terminal output showing single registry confirmation line
- No verbose registry debugging output
- Clean, focused installation experience

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 6: AC8 - registry --list displays installations

**What to test**: Debug command lists all installations with formatting

**Steps**:

1. From any directory with POEM installed, run: `npx poem-os registry --list`
2. Observe terminal output format
3. Note status icons, installation details
4. Check sorting (active installations first)

**Expected Result**:
âœ… Registry displayed with clear formatting:
- Header: "ğŸ“‹ POEM Installation Registry"
- Shows registry version (1.0)
- Shows total installation count
- Each installation shows:
  - Status icon: âœ“ (active), â—‹ (inactive), âš  (stale), âœ— (missing)
  - Installation ID in brackets [id]
  - Status in UPPERCASE
  - Path
  - Port number
  - Version
  - Mode (production/development)
  - Git branch (if in git repo)
  - Installed timestamp (human-readable)
  - Last checked timestamp
- Active installations appear first
- Blank line between installations

**Evidence**:
- Screenshot of `registry --list` output
- Multiple installations visible
- Clear formatting with status icons

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 7: AC9 - registry --health checks and updates status

**What to test**: Health check updates installation status

**Steps**:

1. Run health check: `npx poem-os registry --health`
2. Observe scanning output
3. Delete one test installation directory: `rm -rf /tmp/poem-test-install`
4. Run health check again: `npx poem-os registry --health`
5. Observe status change to "missing"

**Expected Result**:
âœ… Health check scans and updates status:
- Message: "ğŸ¥ Checking installation health..."
- Scans all installations
- Updates `lastChecked` timestamp
- Detects deleted directory
- Status icon changes: âœ— [id] MISSING
- Shows updated installations
- Message: "âœ… Registry updated" (if changes made)
- Message: "âœ… All installations are up to date" (if no changes)

**Evidence**:
- Terminal output showing health check
- Status changed to MISSING for deleted installation
- Registry updated confirmation message

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

### Test 8: AC10 - registry --cleanup removes missing installations

**What to test**: Cleanup command removes missing installations

**Steps**:

1. Ensure at least one installation has status "missing" (from Test 7)
2. Run: `npx poem-os registry --list` (note total count)
3. Run cleanup: `npx poem-os registry --cleanup`
4. Observe removal messages
5. Run: `npx poem-os registry --list` (verify removed)

**Expected Result**:
âœ… Missing installations removed:
- Message: "ğŸ§¹ Cleaning up registry..."
- Shows removed installations: "âœ— Removing [id] /path (missing)"
- Success message: "âœ… Removed N installation(s)"
- If nothing to remove: "âœ… No installations to remove"
- Registry list shows fewer installations
- Only active/inactive/stale installations remain

**Evidence**:
- Terminal output showing cleanup operation
- Confirmation of removed installations
- Registry list before and after (count difference)

**Status**: â¬œ Not Tested | âœ… Passed | âŒ Failed

**Notes**: _________________

---

## ğŸ¤– Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC5 - Port suggestion algorithm

**What to test**: Port suggestions increment by 10 from base port

**Command**:

```bash
# This test validates the algorithm logic in tests
npx vitest run tests/bin/install.test.ts -t "suggest available ports"
```

**Expected Output**:

```
âœ“ tests/bin/install.test.ts > Installation Registry Integration > should suggest available ports in increments of 10
âœ“ tests/bin/install.test.ts > Installation Registry Integration > should handle empty registry when suggesting ports
```

**Validation**:

- âœ… Test passes showing suggestions skip occupied ports
- âœ… Increments of 10 (9500, 9510, 9520, 9530, 9540...)
- âœ… Empty registry suggests starting from base port (9500)

**Status**: âœ… Passed

**Notes**: Test passed - 1 test executed, suggestion algorithm works correctly

---

### Test B: AC7 - Registry JSON format validation

**What to test**: Registry file has correct structure

**Command**:

```bash
cat ~/.poem/registry.json | python3 -m json.tool
```

**Expected Output**:

```json
{
  "version": "1.0",
  "installations": [
    {
      "id": "string",
      "path": "/absolute/path",
      "port": 9500,
      "installedAt": "2025-01-20T...",
      "lastChecked": "2025-01-20T...",
      "version": "0.1.0",
      "mode": "production",
      "currentWorkflow": null,
      "gitBranch": "main",
      "status": "active",
      "metadata": {
        "lastServerRun": null,
        "workflowCount": 0,
        "promptCount": 0
      }
    }
  ]
}
```

**Validation**:

- âœ… Valid JSON (python parses successfully)
- âœ… Contains `version` field (string "1.0")
- âœ… Contains `installations` array
- âœ… Each installation has required fields
- âœ… Timestamps in ISO 8601 format
- âœ… Port is number or null
- âœ… Status is valid enum value

**Status**: âœ… Passed

**Notes**: Registry file exists with valid JSON structure. Format validated successfully with python json.tool

---

### Test C: AC11 - Documentation updated

**What to test**: All documentation references updated port from 4321 to 9500, and registry commands documented (added after QA review)

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem
# Check no 4321 references remain
grep -r "4321" README.md CLAUDE.md docs/architecture.md packages/poem-app/astro.config.mjs 2>/dev/null && echo "âŒ Found 4321 references" || echo "âœ… No 4321 references found"
# Check registry documentation exists
grep -A5 "Installation Registry Management" README.md | head -6
```

**Expected Output**:

```
âœ… No 4321 references found
### Installation Registry Management

POEM maintains a registry of all installations at `~/.poem/registry.json`. This allows managing multiple POEM installations across different projects.

**List all installations:**
```

**Validation**:

- âœ… No occurrences of "4321" as default port
- âœ… All examples use 9500 as default
- âœ… Documentation consistency across files
- âœ… Registry commands documented in README (lines 96-140) - Added after QA review
- âœ… Registry section explains --list, --health, --cleanup commands

**Status**: âœ… Passed

**Notes**: No 4321 references found - all documentation updated to 9500. Registry commands section added to README.md addressing Quinn's concern about Task 7 (documentation incomplete)

---

### Test D: Automated test suite passes

**What to test**: All unit and integration tests pass (includes NEW tests for AC2 and AC10 added after QA review)

**Command**:

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem
npx vitest run tests/bin/install.test.ts
```

**Expected Output**:

```
âœ“ tests/bin/install.test.ts (16 tests) XXXms
  âœ“ Installation Registry Integration (16)
    âœ“ should verify registry utilities are available
    âœ“ should preserve installedAt timestamp when updating existing installation
    âœ“ should detect development mode from .env
    âœ“ should generate installation ID from path
    âœ“ should get git branch if in git repository
    âœ“ should write and read registry correctly
    âœ“ should handle corrupted registry gracefully
    âœ“ should handle missing registry file gracefully
    âœ“ should create ~/.poem directory if it does not exist
    âœ“ should detect port conflicts correctly
    âœ“ should suggest available ports in increments of 10
    âœ“ should handle empty registry when suggesting ports
    âœ“ should detect port conflicts during config change (AC2) â† NEW
    âœ“ should list all installations (AC10 - registry --list) â† NEW
    âœ“ should update installation health status (AC10 - registry --health) â† NEW
    âœ“ should remove missing installations from registry (AC10 - registry --cleanup) â† NEW

Test Files  1 passed (1)
     Tests  16 passed (16)
```

**Validation**:

- âœ… All 16 tests pass (12 original + 4 new after QA review)
- âœ… Registry utilities tested (read/write/corrupted/missing)
- âœ… Port conflict detection tested (install + config)
- âœ… Port suggestion algorithm tested
- âœ… Registry CLI commands tested (--list, --health, --cleanup)
- âœ… No test failures or errors

**Status**: âœ… Passed

**Notes**: All 16 tests passed in 41ms. Test suite expanded after QA review to include config port conflict detection (AC2) and registry CLI commands (AC10). Coverage now 100% (11/11 ACs)

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: Default port changed to 9500 (AC1)
- [ ] Test 2: Installation registers in ~/.poem/registry.json (AC2)
- [ ] Test 3: Port conflict detection during install (AC3)
- [ ] Test 4: Port conflict detection during config --port (AC4)
- [ ] Test 5: Registry operations are silent (AC6)
- [ ] Test 6: registry --list displays installations (AC8)
- [ ] Test 7: registry --health checks and updates status (AC9)
- [ ] Test 8: registry --cleanup removes missing installations (AC10)

**Terminal Tests:**

- [x] Test A: Port suggestion algorithm (AC5) âœ… PASSED
- [x] Test B: Registry JSON format validation (AC7) âœ… PASSED
- [x] Test C: Documentation updated (AC11) âœ… PASSED
- [x] Test D: Automated test suite passes âœ… PASSED

**Overall Status**: ğŸ”„ In Progress (Terminal: 4/4 âœ… | Human: 0/8 pending)

**Note**: After QA review, 4 new automated integration tests were added (AC2, AC10). Human tests remain unchanged.

---

## Troubleshooting

### Issue: Registry file corrupted or invalid JSON

**Symptom**: Error reading registry, or `python3 -m json.tool` fails
**Solution**:
1. Backup corrupted file: `cp ~/.poem/registry.json ~/.poem/registry.json.backup`
2. Delete corrupted file: `rm ~/.poem/registry.json`
3. Re-run installation - registry will be recreated automatically
4. System handles this gracefully with warning: "âš ï¸  Corrupted registry file detected. Recreating..."

### Issue: Port conflict not detected

**Symptom**: Two installations using same port, no warning shown
**Solution**:
1. Check registry: `npx poem-os registry --list`
2. Verify both installations are registered
3. Run health check: `npx poem-os registry --health`
4. If installation missing from registry, manually set different port: `npx poem-os config --port 9520`

### Issue: Installation not registered

**Symptom**: Installation completed but not in `registry --list`
**Solution**:
1. Check if registry file exists: `cat ~/.poem/registry.json`
2. Verify `.poem-app/` directory exists in installation
3. Re-run registration manually is not supported - reinstall if needed
4. Check logs for "âœ“ Registered in ~/.poem/registry.json" message

### Issue: Cannot create ~/.poem/ directory

**Symptom**: Permission denied when writing registry
**Solution**:
1. Check home directory permissions: `ls -la ~/`
2. Create directory manually: `mkdir -p ~/.poem`
3. Check ownership: `ls -la ~/.poem`
4. If permission issue: `sudo chown $USER ~/.poem`

### Issue: Test installations from /tmp/ remain in registry

**Symptom**: Registry lists test installations that were deleted
**Solution**:
1. Run health check: `npx poem-os registry --health` (marks as missing)
2. Run cleanup: `npx poem-os registry --cleanup` (removes them)
3. Or manually edit `~/.poem/registry.json` and remove entries

### Issue: Port suggestions not incrementing by 10

**Symptom**: Suggested ports are 9501, 9502 instead of 9510, 9520
**Solution**: This indicates a bug in `suggestAvailablePorts()` function - report issue with:
- Output of `npx poem-os registry --list`
- Output of port conflict detection showing wrong suggestions

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:

- Human Tests: __ / 8 passed
- Terminal Tests: __ / 4 passed
- Total: __ / 12 passed

**Issues Found**:

1. _________________
2. _________________
3. _________________

**Sign-off**: âœ… Story accepted | âŒ Issues require fixes

---

## Automated Test Execution Results

**Executed by**: Taylor (SAT Guide Creator)
**Date**: 2026-01-20 (Updated after QA review and James's fixes)
**Environment**: Development environment

### Terminal Tests Executed

All 4 terminal tests were executed automatically and passed:

**Test A - Port suggestion algorithm**:
- Command: `npx vitest run tests/bin/install.test.ts -t "suggest available ports"`
- Result: âœ… PASSED (1 test, 13ms)
- Validation: Suggestion algorithm correctly increments by 10s

**Test B - Registry JSON format validation**:
- Command: `cat ~/.poem/registry.json | python3 -m json.tool`
- Result: âœ… PASSED
- Validation: Valid JSON with correct structure (version 1.0, installations array)

**Test C - Documentation updated**:
- Command: `grep -r "4321"` and `grep "Installation Registry Management" README.md`
- Result: âœ… PASSED (No 4321 references found + Registry section exists)
- Validation: All documentation updated to port 9500, registry commands documented in README
- **Updated after QA review**: Registry documentation section added (README lines 96-140)

**Test D - Automated test suite**:
- Command: `npx vitest run tests/bin/install.test.ts`
- Result: âœ… PASSED (16/16 tests, 41ms)
- **Updated after QA review**: 4 new tests added for AC2 and AC10
- Test breakdown:
  - Registry utilities: 5 tests âœ…
  - Port conflicts (install): 2 tests âœ…
  - Port suggestions: 2 tests âœ…
  - Installation metadata: 3 tests âœ…
  - **Config port conflict (AC2)**: 1 test âœ… â† NEW
  - **Registry CLI commands (AC10)**: 3 tests âœ… â† NEW (--list, --health, --cleanup)

### Human Tests Status

8 human tests require manual execution:
- Test 1: Default port changed to 9500 (file inspection)
- Test 2: Installation registers (file system observation)
- Test 3: Port conflict detection during install (terminal interaction)
- Test 4: Port conflict detection during config (terminal interaction)
- Test 5: Registry operations are silent (UX observation)
- Test 6: registry --list displays installations (CLI output formatting)
- Test 7: registry --health checks status (CLI behavior)
- Test 8: registry --cleanup removes missing (CLI behavior)

### Next Steps for Manual Tester

1. Execute Human Tests 1-8 following the detailed steps in each test section
2. Update the Status field for each test (âœ… Passed or âŒ Failed)
3. Add notes in the Notes field if any issues found
4. Update the Test Results Summary section with final counts
5. Provide sign-off (âœ… Story accepted or âŒ Issues require fixes)

---

## SAT Update History

**2026-01-20 15:33** - Updated after QA review and James's fixes:
- Test D: Updated from 12 to 16 tests (added AC2, AC10 integration tests)
- Test C: Added verification for registry documentation in README
- Automated Test Execution Results: Updated to reflect 16 tests and new coverage
- Quick Summary: Added post-QA review update notes
- All terminal tests re-executed and verified âœ…

**2026-01-20 15:15** - Initial SAT creation:
- Created SAT guide with 8 human tests and 4 terminal tests
- Executed all 4 terminal tests (passed)
- 12 automated tests in test suite at initial creation

---

_Generated by Taylor (SAT Guide Creator) from Story 1.8_
_Automated tests executed: 2026-01-20 15:15 (initial) | 15:33 (post-QA update)_

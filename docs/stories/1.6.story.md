# Story 1.6: NPM Package Publishing

## Status

Review

## Story

**As a** developer,
**I want** to publish POEM to NPM as a public package,
**so that** users can install it globally via `npx poem-os install`.

## Background

This story completes Epic 1: Foundation & Monorepo Setup. Stories 1.1-1.5 built the complete POEM infrastructure including the monorepo structure, installer script, and Claude Code integration. The installer (`bin/install.js`) works perfectly when tested locally, and has been successfully used to install POEM into `prompt.supportsignal.com.au`.

However, the package cannot be published to NPM because `package.json` has `"private": true`, blocking public distribution. This story removes that blocker and enables the Epic 1 goal: "Users should be able to install POEM into their projects" via `npx poem-os install`.

**References**:
- Epic 1 Goal: `docs/prd/epic-details.md` (lines 2-4)
- Previous Story 1.5: Claude Code integration complete (Done status)
- Installer Script: `bin/install.js` (fully functional)

## Acceptance Criteria

1. Remove `"private": true` from root `package.json`
2. Add `"bin"` field mapping `"poem-os"` command to `"bin/install.js"`
3. Add `"repository"`, `"bugs"`, and `"homepage"` URLs to package.json
4. Define `"files"` array in package.json to control published content
5. Test package installation locally using `npm link` followed by `npx poem-os install`
6. Create `PUBLISHING.md` documenting the manual publishing process
7. Add GitHub Actions workflow for automated NPM publishing (optional, future enhancement)

## Tasks / Subtasks

- [x] Task 1: Update Root package.json for NPM Publishing (AC: 1, 2, 3, 4)
  - [x] Remove `"private": true` field
  - [x] Add `"bin"` field: `{ "poem-os": "./bin/install.js" }`
  - [x] Add repository URL (GitHub repo for poem-os)
  - [x] Add bugs URL (GitHub issues)
  - [x] Add homepage URL (GitHub repo or docs site)
  - [x] Define `"files"` array to include: `["bin/", "packages/", "README.md", "LICENSE"]`
  - [x] Verify `"version": "0.1.0"` is appropriate for initial release

- [x] Task 2: Test Local Installation with npm link (AC: 5)
  - [x] Run `npm link` in poem-os root directory
  - [x] Create test directory outside poem-os
  - [x] Run `npx poem-os install` in test directory
  - [x] Verify `.poem-core/` directory created
  - [x] Verify `.poem-app/` directory created
  - [x] Verify `poem/` workspace created with subdirectories
  - [x] Verify `.claude/commands/poem/` created
  - [x] Test `--core` and `--app` flags
  - [x] Run `npm unlink` to clean up

- [x] Task 3: Document Publishing Process (AC: 6)
  - [x] Create `PUBLISHING.md` in root directory
  - [x] Document manual publishing steps:
    - Version bump strategy (semantic versioning)
    - Pre-publish checklist (tests, linting, build)
    - Publishing command: `npm publish`
    - Post-publish verification
  - [x] Document initial NPM account setup
  - [x] Document testing with `npm pack` before publishing
  - [x] Include rollback instructions if needed

- [x] Task 4: Update README with Installation Instructions (AC: 5)
  - [x] Add "Installation" section to root README.md
  - [x] Document `npx poem-os install` command
  - [x] Document installation options (`--core`, `--app`, `--force`)
  - [x] Link to full documentation in PUBLISHING.md

- [x] Task 5: Verify Installer Compatibility (AC: 5)
  - [x] Review `bin/install.js` shebang: `#!/usr/bin/env node`
  - [x] Verify file permissions are executable (chmod +x)
  - [x] Test on macOS/Linux environments
  - [x] Verify Node.js version check works (requires 22.x+)

- [x] Task 6: Create GitHub Actions Workflow (Optional) (AC: 7)
  - [x] Create `.github/workflows/publish.yaml`
  - [x] Trigger on: manual dispatch or Git tag push (v*)
  - [x] Workflow steps:
    - Checkout code
    - Setup Node.js 22.x
    - Install dependencies
    - Run tests
    - Build packages
    - Publish to NPM with NPM_TOKEN secret
  - [x] Document workflow usage in PUBLISHING.md
  - [x] Note: Defer to Epic 3 CI/CD phase if preferred

## Dev Notes

### Previous Story Insights

[Source: Story 1.5 Dev Agent Record]

**Key Learnings from Story 1.5**:
- Installer script at `bin/install.js` is fully functional
- Successfully tested installation into `prompt.supportsignal.com.au`
- Installer creates `.poem-core/`, `.poem-app/`, `poem/`, and `.claude/commands/poem/` directories
- Installer supports `--core`, `--app`, `--force`, and `--verbose` flags
- Installation completes in under 3 minutes (NFR1 satisfied)
- Current version: `0.1.0` (defined in both bin/install.js and package.json)

### Architecture Context: Tech Stack

[Source: docs/architecture/tech-stack.md]

**Build & Distribution**:
- Package Manager: `npm` v10.x - Native workspaces, no extra tooling
- Distribution: `npx` - Zero-install execution
- Node.js Requirement: 22.x LTS (Active until October 2027)

**NPM Publishing Requirements**:
- Must remove `"private": true` to enable publishing
- Must define `"bin"` field for executable commands
- Should define `"files"` array to control published content (exclude dev files, tests, etc.)
- Repository, bugs, homepage URLs improve discoverability

### Architecture Context: Project Structure

[Source: docs/architecture/unified-project-structure.md]

**Development Repository Structure** (lines 7-139):
```
poem-os/poem/
‚îú‚îÄ‚îÄ .github/workflows/           # CI/CD workflows (phased)
‚îÇ   ‚îî‚îÄ‚îÄ publish.yaml             # Phase 4: NPM publish
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ poem-core/               # ‚Üí Becomes .poem-core/
‚îÇ   ‚îî‚îÄ‚îÄ poem-app/                # ‚Üí Becomes .poem-app/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ install.js               # NPX installer script
‚îú‚îÄ‚îÄ docs/                        # Project documentation
‚îú‚îÄ‚îÄ data/                        # Example data (for development only)
‚îú‚îÄ‚îÄ .claude/commands/            # Slash commands
‚îú‚îÄ‚îÄ package.json                 # Root package.json (workspaces)
‚îî‚îÄ‚îÄ README.md
```

**Files to Include in NPM Package**:
- `bin/` - Installer script
- `packages/` - Both poem-core and poem-app
- `README.md` - Installation instructions
- `LICENSE` - MIT license
- `package.json` - Metadata and dependencies

**Files to Exclude from NPM Package**:
- `docs/` - Development documentation (not needed for users)
- `data/` - Example data (development only)
- `.github/` - CI/CD configs
- `.claude/` - Already copied during installation
- `node_modules/` - Never published
- Development configs: `.eslintrc.js`, `.prettierrc`, `tsconfig.json`

### Current Package.json State

[Source: package.json]

**Current Configuration**:
```json
{
  "name": "poem-os",
  "version": "0.1.0",
  "private": true,              // ‚ùå BLOCKS PUBLISHING
  "type": "module",
  "description": "POEM - Prompt Orchestration and Engineering Method",
  "workspaces": ["packages/*"],
  "engines": { "node": ">=22.0.0" },
  "keywords": ["prompt-engineering", "ai", "llm", "handlebars", "mock-data"],
  "author": "AppyDave",
  "license": "MIT"
}
```

**Missing Fields**:
- `"bin"` - Required for `npx poem-os` to work
- `"repository"` - GitHub URL for source code
- `"bugs"` - GitHub issues URL
- `"homepage"` - Project website or GitHub repo
- `"files"` - Controls what gets published (defaults to everything if omitted)

### NPM Publishing Best Practices

**Files Array Pattern**:
```json
"files": [
  "bin/",
  "packages/",
  "README.md",
  "LICENSE"
]
```
This explicitly includes only distribution files, excluding `docs/`, `data/`, `.github/`, development configs, and test files.

**Bin Field Pattern**:
```json
"bin": {
  "poem-os": "./bin/install.js"
}
```
Maps `npx poem-os` to the installer script. File must have shebang: `#!/usr/bin/env node`

**Repository Field Pattern**:
```json
"repository": {
  "type": "git",
  "url": "https://github.com/appydave/poem-os.git"
}
```

**Testing Before Publishing**:
1. `npm pack` - Creates tarball (.tgz) locally
2. `npm link` - Symlinks package globally for testing
3. `npx poem-os install` in test directory
4. `npm unlink` - Removes symlink after testing

**Publishing Command**:
```bash
npm publish
```
Requires NPM account authentication. Use `npm login` first.

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Manual Testing via npm link** (lines 59-83):
- This story requires manual testing (no automated tests for NPM publishing)
- Test local installation before publishing to NPM
- Verify all installation modes: full, `--core`, `--app`
- Test in clean directory outside poem-os repository
- Verify directory structure matches expected output

**Test Checklist**:
1. `npm link` in poem-os root
2. Create test directory: `mkdir ~/test-poem-install && cd ~/test-poem-install`
3. Run `npx poem-os install`
4. Verify `.poem-core/`, `.poem-app/`, `poem/`, `.claude/` created
5. Check for any errors or warnings
6. Test `--core` flag: only `.poem-core/` and `.claude/` created
7. Test `--app` flag: only `.poem-app/` created
8. Run `npm unlink` to clean up

### Version Strategy

**Initial Release**: `0.1.0`
- Semantic Versioning: MAJOR.MINOR.PATCH
- `0.x.x` indicates pre-stable release
- Increment MINOR for new features (Epic completion)
- Increment PATCH for bug fixes
- Bump to `1.0.0` when production-ready (after Epic 5+)

### Security Considerations

**Secret Detection**: `.secretlintrc.json` configured (per project structure)
- Run secretlint before publishing to avoid leaking credentials
- Review `files` array to ensure no sensitive files included

### CI/CD Context

[Source: docs/architecture/unified-project-structure.md ¬ß .github/workflows/]

**GitHub Actions for NPM Publishing** (Optional):
- File: `.github/workflows/publish.yaml`
- Trigger: Git tag push matching `v*` pattern (e.g., `v0.1.0`)
- Workflow: Checkout ‚Üí Setup Node ‚Üí Install ‚Üí Test ‚Üí Build ‚Üí Publish
- Requires: `NPM_TOKEN` secret in GitHub repository settings

**Phased Approach**:
- Phase 1-3: Manual publishing (this story)
- Phase 4: Automated publishing via GitHub Actions (Epic 3 or later)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Initial story draft created | Bob (SM) |
| 2026-01-13 | 1.1 | Story implementation complete | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log entries required - implementation proceeded smoothly.

### Completion Notes

- Successfully updated package.json for NPM publishing (removed private field, added bin/files/repository/bugs/homepage)
- All local installation tests passed (full install, --core, --app flags)
- Created comprehensive PUBLISHING.md with manual publishing workflow, version strategy, and rollback instructions
- Updated README.md with installation instructions and NPM package links
- Verified installer compatibility (shebang, permissions, Node.js version check)
- Created GitHub Actions workflow template for future automation (deferred to Epic 3)
- All acceptance criteria satisfied

### File List

**Modified Files**:
- `package.json` - Removed "private": true, added bin/files/repository/bugs/homepage fields
- `README.md` - Added Installation section, updated Links section
- `docs/stories/1.6.story.md` - Updated task checkboxes, Dev Agent Record, Change Log

**Created Files**:
- `PUBLISHING.md` - Complete publishing documentation
- `.github/workflows/publish.yaml` - GitHub Actions workflow template

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT ‚úÖ**

This story implements pure configuration and documentation changes with no code logic. The implementation is clean, follows NPM best practices, and includes comprehensive documentation. All 7 acceptance criteria are fully satisfied and validated through automated and manual testing.

**Implementation Highlights:**
- package.json: Professional structure, correct NPM metadata
- PUBLISHING.md: 316-line comprehensive guide covering entire publishing lifecycle
- README.md: Clear installation instructions with all modes documented
- GitHub Actions: Well-structured template ready for Epic 3 activation
- SAT Guide: Excellent separation of automated (8 tests) vs human (5 tests) validation

### Refactoring Performed

No refactoring required - this is a configuration/documentation story with no code to refactor.

### Compliance Check

- ‚úÖ **Coding Standards**: N/A (no code changes)
- ‚úÖ **Project Structure**: All files in correct locations (root, .github/workflows/)
- ‚úÖ **Testing Strategy**: Appropriate manual testing approach via SAT for configuration changes
- ‚úÖ **All ACs Met**: 7/7 acceptance criteria fully implemented and verified

### Requirements Traceability

**AC ‚Üí Validation Mapping:**

1. **AC1: Remove "private": true** ‚Üí ‚úÖ VERIFIED
   - Given package.json has "private": true
   - When "private" field is removed
   - Then package can be published to NPM
   - Evidence: SAT Test A passed, grep found no "private" field

2. **AC2: Add "bin" field** ‚Üí ‚úÖ VERIFIED
   - Given NPM package needs executable command
   - When "bin" field maps "poem-os" to "./bin/install.js"
   - Then users can run `npx poem-os install`
   - Evidence: SAT Test B passed, bin field correctly configured

3. **AC3: Add repository/bugs/homepage URLs** ‚Üí ‚úÖ VERIFIED
   - Given package needs discoverability on NPM
   - When GitHub URLs are added to package.json
   - Then users can find source code and report issues
   - Evidence: SAT Test C passed, all URLs present and correct

4. **AC4: Define "files" array** ‚Üí ‚úÖ VERIFIED
   - Given package should only publish distribution files
   - When "files" array includes bin/, packages/, README.md, LICENSE
   - Then dev files (docs/, data/, .github/) are excluded
   - Evidence: SAT Test D passed, files array correctly scopes content

5. **AC5: Test local installation** ‚Üí ‚úÖ VERIFIED
   - Given installer must work before NPM publishing
   - When npm link is used to test locally
   - Then all installation modes work (full, --core, --app)
   - Evidence: Dev Agent Record confirms all tests passed, SAT Tests E-F verify installer compatibility

6. **AC6: Create PUBLISHING.md** ‚Üí ‚úÖ VERIFIED
   - Given team needs publishing workflow documentation
   - When PUBLISHING.md is created with comprehensive guide
   - Then manual publishing process is documented
   - Evidence: SAT Test G passed, 316 lines covering version strategy, pre-publish checklist, rollback instructions

7. **AC7: GitHub Actions workflow** ‚Üí ‚úÖ VERIFIED
   - Given future automation will improve publishing workflow
   - When workflow template is created (marked inactive)
   - Then Epic 3 can activate automated publishing
   - Evidence: SAT Test H passed, workflow exists with clear documentation

### Test Architecture Assessment

**Test Strategy: APPROPRIATE ‚úÖ**

This story correctly uses manual testing via SAT guide rather than unit tests:
- Configuration changes don't require unit tests
- npm link testing validates real-world installation scenarios
- SAT automation (8 terminal tests) provides rapid verification
- Human tests (5 visual checks) appropriately defer to manual review

**SAT Quality: EXCELLENT**
- Clear separation: ü§ñ Terminal (automated) vs üßë Human (manual)
- All automated tests executed and passed (8/8)
- Human tests well-documented with step-by-step instructions
- Troubleshooting section helps debug common issues

### Security Review

**Status: PASS ‚úÖ**

- ‚úÖ No sensitive data in package.json
- ‚úÖ "files" array prevents leaking .env, credentials, dev configs
- ‚úÖ No authentication/authorization code changes
- ‚úÖ GitHub Actions workflow uses secrets correctly (NPM_TOKEN)
- ‚úÖ PUBLISHING.md documents 2FA requirement for NPM account

### Performance Considerations

**Status: PASS (N/A) ‚úÖ**

Configuration-only changes with no performance implications.

### Non-Functional Requirements (NFRs)

**Security**: ‚úÖ PASS - Files array prevents sensitive data leak, no code vulnerabilities
**Performance**: ‚úÖ PASS - N/A for configuration changes
**Reliability**: ‚úÖ PASS - npm link testing validates installer works in all modes
**Maintainability**: ‚úÖ PASS - Excellent documentation enables future team members to publish

### Files Modified During Review

No files modified during QA review - implementation is complete and correct as-is.

### Gate Status

**Gate: PASS** ‚úÖ ‚Üí `docs/qa/gates/1.6-npm-package-publishing.yml`

**Quality Score**: 100/100

**Evidence:**
- 7/7 acceptance criteria met
- 8/8 automated SAT tests passed
- 0 critical/high/medium/low issues found
- All NFRs satisfied
- Comprehensive documentation

**Risk Assessment**: LOW
- Configuration changes only, no code logic
- Comprehensive testing via npm link
- Clear rollback strategy documented

### Recommended Status

‚úÖ **Ready for Done**

**Rationale:**
- All acceptance criteria fully implemented
- All automated tests passing
- Comprehensive documentation completed
- No issues requiring remediation
- Human SAT tests are optional final validation (not blockers)

**Suggested Next Steps:**
1. ‚úÖ Mark story status as "Done"
2. ‚è≠Ô∏è Execute 5 human SAT tests for completeness (optional)
3. ‚è≠Ô∏è Proceed to Epic 1 completion/retrospective
4. ‚è≠Ô∏è Defer actual NPM publishing until team is ready for v0.1.0 release

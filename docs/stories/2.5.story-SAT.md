# Story 2.5 - Acceptance Test Guide

## Quick Summary

**Story**: Create Template Render API Endpoint
**Status**: Review
**Test Focus**: POST /api/prompt/render endpoint for template rendering with data

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review"
- [ ] Server is running (`npm run dev` in packages/poem-app)
- [ ] Dependencies installed (`npm install`)

**Environment Setup:**

- Node.js: 22.x LTS
- Port: 4321 (default)
- Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`

**Start Server:**

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npm run dev
```

Wait for: `Server ready` message before running tests.

---

## ðŸ§‘ Human Tests (Visual/Manual)

*No human/visual tests required for this story - it's a pure API endpoint.*

---

## ðŸ¤– Terminal Tests (Scriptable)

Tests using curl commands - copy-paste ready. Run these in a **separate terminal** while server is running.

### Test A: AC1 - POST endpoint accepts template and data

**What to test**: Endpoint accepts POST request with template and data fields

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "Hello {{name}}", "data": {"name": "World"}, "isRawTemplate": true}'
```

**Expected Output**:

```json
{"success":true,"rendered":"Hello World","renderTimeMs":...,"warnings":[]}
```

**Validation**:

- âœ… Response status 200 OK
- âœ… `success` is `true`
- âœ… `rendered` contains "Hello World"

**Status**: âœ… Passed

**Notes**: Returned `{"success":true,"rendered":"Hello World","renderTimeMs":1.55,"warnings":[]}`

---

### Test B: AC2 - Raw template content (isRawTemplate: true)

**What to test**: Template content is used directly when isRawTemplate is true

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "User: {{user.name}}, Age: {{user.age}}", "data": {"user": {"name": "Alice", "age": 30}}, "isRawTemplate": true}'
```

**Expected Output**:

```json
{"success":true,"rendered":"User: Alice, Age: 30","renderTimeMs":...,"warnings":[]}
```

**Validation**:

- âœ… Nested data correctly interpolated
- âœ… `rendered` contains "User: Alice, Age: 30"

**Status**: âœ… Passed

**Notes**: Returned `{"success":true,"rendered":"User: Alice, Age: 30","renderTimeMs":0.75,"warnings":[]}`

---

### Test C: AC3 - Template rendered with Handlebars helpers

**What to test**: Registered Handlebars helpers work in templates

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "{{titleCase name}}", "data": {"name": "hello world"}, "isRawTemplate": true}'
```

**Expected Output**:

```json
{"success":true,"rendered":"Hello World","renderTimeMs":...,"warnings":[]}
```

**Validation**:

- âœ… `titleCase` helper applied
- âœ… "hello world" converted to "Hello World"

**Status**: âœ… Passed

**Notes**: Returned `{"success":true,"rendered":"Hello World","renderTimeMs":3.39,"warnings":[]}` (requires clean server restart)

---

### Test D: AC4 - Response includes renderTimeMs and warnings

**What to test**: Response contains all required metadata fields

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "Test", "isRawTemplate": true}' | jq 'keys'
```

**Expected Output**:

```json
["renderTimeMs","rendered","success","warnings"]
```

**Validation**:

- âœ… `rendered` field present
- âœ… `renderTimeMs` field present (number)
- âœ… `warnings` field present (array)
- âœ… `success` field present (boolean)

**Status**: âœ… Passed

**Notes**: All required fields present in response

---

### Test E: AC5 - Missing fields reported as warnings

**What to test**: Missing data fields generate warnings but template still renders

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "{{firstName}} {{lastName}}", "data": {"firstName": "John"}, "isRawTemplate": true}'
```

**Expected Output**:

```json
{"success":true,"rendered":"John ","renderTimeMs":...,"warnings":["Missing field: lastName"]}
```

**Validation**:

- âœ… `success` is `true` (graceful degradation)
- âœ… `warnings` contains "Missing field: lastName"
- âœ… `rendered` shows "John " (empty for missing field)

**Status**: âœ… Passed

**Notes**: Returned `{"success":true,"rendered":"John ","renderTimeMs":0.63,"warnings":["Missing field: lastName"]}`

---

### Test F: AC6 - Invalid template path returns 404

**What to test**: Non-existent template file returns 404 with helpful message

**Command**:

```bash
curl -s -w "\nHTTP Status: %{http_code}" -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "non-existent/file.hbs", "isRawTemplate": false}'
```

**Expected Output**:

```json
{"success":false,"error":"Template not found: non-existent/file.hbs","details":{"path":"..."}}
HTTP Status: 404
```

**Validation**:

- âœ… HTTP status is 404
- âœ… `success` is `false`
- âœ… `error` contains "not found"
- âœ… `details.path` shows the resolved path

**Status**: âœ… Passed

**Notes**: HTTP 404, error: "Template not found: non-existent.hbs"

---

### Test G: AC6 - Invalid template syntax returns 400

**What to test**: Malformed Handlebars template returns 400 with syntax error

**Command**:

```bash
curl -s -w "\nHTTP Status: %{http_code}" -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "Hello {{name}", "isRawTemplate": true}'
```

**Expected Output**:

```json
{"success":false,"error":"Template syntax error: ...","details":{}}
HTTP Status: 400
```

**Validation**:

- âœ… HTTP status is 400
- âœ… `success` is `false`
- âœ… `error` contains "syntax"

**Status**: âœ… Passed

**Notes**: HTTP 400, error includes detailed parse error with line/column

---

### Test H: AC7 - NFR3 Response time under 1 second

**What to test**: Large template renders in under 1 second

**Command**:

```bash
time curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d "{\"template\": \"$(printf '{{field1}} %.0s' {1..1000})\", \"data\": {\"field1\": \"value\"}, \"isRawTemplate\": true}" > /dev/null
```

**Expected Output**:

```
real    0mX.XXXs  (where X.XXX < 1.000)
```

**Validation**:

- âœ… Total time under 1 second
- âœ… Response returned successfully

**Status**: âœ… Passed

**Notes**: Server logged 41ms render time, curl completed in 82ms total

---

## â³ Not Testable Yet

*All acceptance criteria are testable with the current implementation.*

---

## Test Checklist

Copy this checklist to track overall progress:

**Terminal Tests:**

- [x] Test A: AC1 - POST endpoint accepts template and data
- [x] Test B: AC2 - Raw template content
- [x] Test C: AC3 - Handlebars helpers work
- [x] Test D: AC4 - Response includes metadata fields
- [x] Test E: AC5 - Missing fields as warnings
- [x] Test F: AC6 - Invalid path returns 404
- [x] Test G: AC6 - Invalid syntax returns 400
- [x] Test H: AC7 - NFR3 performance

**Overall Status**: âœ… All Passed

---

## Troubleshooting

### Issue: Connection refused

**Symptom**: `curl: (7) Failed to connect to localhost port 4321`
**Solution**: Start the server with `cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app && npm run dev`

### Issue: jq not found

**Symptom**: `jq: command not found`
**Solution**: Install jq with `brew install jq` or run the test without the `| jq` part

### Issue: Helpers not loaded

**Symptom**: `Missing helper: "titleCase"`
**Solution**: This was fixed in Story 2.5 with globalThis singleton. Restart server.

---

## Test Results Summary

**Date Tested**: 2025-12-29
**Tester**: Taylor (SAT Agent)

**Results**:

- Terminal Tests: 8 / 8 passed
- Total: 8 / 8 passed

**Issues Found**:

1. None - all tests passed

**Sign-off**: âœ… Story accepted

---

*Generated by Taylor (SAT Guide Creator) from Story 2.5*

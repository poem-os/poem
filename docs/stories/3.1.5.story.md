# Story 3.1.5: Implement Path Resolution Configuration

## Status

Done

## Story

**As a** developer (both POEM framework developer and user),
**I want** POEM to automatically resolve file paths based on execution context (development vs production),
**so that** agents, workflows, and API endpoints work correctly in both the monorepo during development AND in user projects after installation.

## Acceptance Criteria

1. API endpoints resolve workspace paths (prompts, schemas, mock-data) via configuration, not hardcoded paths
2. Configuration service loads `poem-core-config.yaml` (POEM's workspace config) on server startup
3. Development mode detected when `POEM_DEV=true` environment variable is set
4. In development mode, paths resolve relative to monorepo root (`poem-os/poem/`)
5. In production mode, paths resolve relative to project root (where `.poem-app/` is installed)
6. Slash commands can load agent data files from correct location based on mode
7. All existing tests pass with the new path resolution logic
8. Development setup documented with clear instructions
9. Config service gracefully handles missing config file with fallback defaults

## Tasks / Subtasks

- [x] Task 1: Create POEM Configuration Service (AC: 2, 3, 4, 5, 9)
  - [x] Create `packages/poem-app/src/services/config/poem-config.ts`
  - [x] Define `PoemConfig` interface with workspace paths
  - [x] Implement `loadPoemConfig()` that reads from `poem-core-config.yaml`
  - [x] Add `POEM_DEV` environment variable detection
  - [x] Implement `getProjectRoot()` that returns correct root based on mode
  - [x] Implement `resolvePath(type: 'prompts' | 'schemas' | 'mockData' | 'config')` helper
  - [x] Export singleton instance for use across API endpoints
  - [x] **Config Not Found Handling**: If config file missing:
    - [x] Log warning: "poem-core-config.yaml not found, using defaults"
    - [x] Use fallback defaults based on detected mode (see Config Discovery Chain below)
    - [x] Do NOT throw error - allow server to start

- [x] Task 2: Create POEM Core Config file (AC: 2)
  - [x] Create `packages/poem-core/poem-core-config.yaml` (workspace-specific config)
  - [x] Define workspace paths: prompts, schemas, mockData, workflowData, config
  - [x] Add development mode path overrides
  - [x] Keep separate from `.bmad-core/core-config.yaml` (BMAD config for agents/stories)

- [x] Task 3: Refactor API Path Resolution (AC: 1, 4, 5)
  - [x] Update `packages/poem-app/src/pages/api/prompt/render.ts`
    - [x] Replace hardcoded `resolveTemplatePath()` with config service
    - [x] Use `poemConfig.resolvePath('prompts', templatePath)`
  - [x] Update `packages/poem-app/src/pages/api/schema/extract.ts`
    - [x] Replace hardcoded path resolution with config service

- [x] Task 4: Update Slash Command Path Resolution - Hybrid Approach (AC: 6)
  - [x] Update `.claude/commands/poem/agents/penny.md`
  - [x] Replace current `IDE-FILE-RESOLUTION` with hybrid detection + fallback:
    ```yaml
    IDE-FILE-RESOLUTION:
      - STEP 1: Detect environment by checking which directory exists at project root:
        - If `packages/poem-core/` exists → DEVELOPMENT mode
        - If only `.poem-core/` exists → PRODUCTION mode
      - STEP 2: Load dependencies from detected path:
        - DEVELOPMENT: packages/poem-core/{type}/{name}
        - PRODUCTION: .poem-core/{type}/{name}
      - FALLBACK: If file not found at primary path, try alternate path before failing
      - Example (dev): poem-principles.md → packages/poem-core/data/poem-principles.md
      - Example (prod): poem-principles.md → .poem-core/data/poem-principles.md
    ```
  - [x] Test agent activation in development - verify data files load from `packages/poem-core/data/`
  - [x] Document this pattern for future POEM slash commands

- [x] Task 5: Create Development Setup Documentation (AC: 8)
  - [x] Create `scripts/dev-setup.sh` that:
    - [x] Sets `POEM_DEV=true` in `.env` file
    - [x] Validates Node.js version
    - [x] Runs npm install in required packages
  - [x] Update `CLAUDE.md` with development setup instructions
  - [x] Document the two modes and how to switch between them
  - [x] Document the hybrid path resolution approach for slash commands

- [x] Task 6: Write Tests for Config Service (AC: 7, 9)
  - [x] Create `packages/poem-app/tests/services/poem-config.test.ts`
  - [x] Test: `loadPoemConfig()` returns valid config object
  - [x] Test: `getProjectRoot()` returns monorepo root in dev mode
  - [x] Test: `getProjectRoot()` returns project root in prod mode (mocked)
  - [x] Test: `resolvePath('prompts', 'test.hbs')` resolves correctly in both modes
  - [x] Test: Config not found returns defaults with warning (no error thrown)
  - [x] Test: Fallback defaults match expected dev/prod paths

- [x] Task 7: Update Existing Tests (AC: 7)
  - [x] Update `packages/poem-app/tests/api/prompt-render.test.ts` to use config service
  - [x] Update `packages/poem-app/tests/api/schema-extract.test.ts` to use config service
  - [x] Ensure all tests pass with `POEM_DEV=true`

- [x] Task 8: Verify End-to-End (AC: 1-9)
  - [x] Start Astro server with `POEM_DEV=true`
  - [x] Test `/api/prompt/render` with template from `prompts/test/hello.hbs`
  - [x] Test `/poem/agents/penny` loads data files correctly
  - [x] Verify all existing functionality works
  - [x] Test config-not-found scenario (rename config, verify fallback works)

- [x] Task 9: Post-Implementation - Update Story 3.1 Cross-Reference
  - [x] Add note to Story 3.1's Dev Notes referencing path resolution pattern from 3.1.5
  - [x] Document that future agents should follow the hybrid `IDE-FILE-RESOLUTION` pattern

- [x] Task 10: Establish Slash Command Source-of-Truth (AC: 6, 8) - POST-QA ADDENDUM
  - **Context:** SAT Human Test 2 (Installation Mode) revealed agent greeted as "Petra" instead of "Penny". Root cause: `.claude/commands/poem/` was edited as separate file from `packages/poem-core/commands/` (installer source).
  - [x] Establish `packages/poem-core/commands/` as single source for slash commands
  - [x] Add `.claude/commands/poem/` to `.gitignore` (generated, not committed)
  - [x] Update `scripts/dev-setup.sh` to sync commands from source
  - [x] Create `scripts/sync-commands.sh` for quick sync (with `--watch` mode)
  - [x] Document in KDD: `docs/kdd/learnings/slash-command-source-duplication.md`

## Dev Notes

### Background Context

Story 3.1 (Prompt Engineer Agent) was completed but revealed a critical gap: POEM has no mechanism for resolving file paths in both development and production contexts.

**The Problem:**
- Slash commands expect `.poem-core/{type}/{name}` (installed location)
- API endpoints hardcode `../..` navigation (monorepo-only)
- Config file (`packages/poem-core/core-config.yaml`) exists but isn't used for path resolution
- When testing the agent via `/poem/agents/penny`, it failed to load:
  - `.poem-core/core-config.yaml` (doesn't exist at this path in dev)
  - `.poem-core/data/poem-principles.md` (doesn't exist at this path in dev)

**Two Usage Modes:**

| Mode | Detection | Project Root | Framework Location | User Workspace |
|------|-----------|--------------|-------------------|----------------|
| **Development** | `POEM_DEV=true` | `poem-os/poem/` | `packages/poem-core/` | `prompts/`, `schemas/` at root |
| **Production** | `POEM_DEV` unset | User's project | `.poem-core/` | `poem/prompts/`, `poem/schemas/` |

### Config Discovery Chain

The config service looks for `poem-core-config.yaml` in this order:

**Step 1: Determine Mode**
```
if POEM_DEV=true → Development Mode
else → Production Mode
```

**Step 2: Locate Config File**

| Mode | Config Location |
|------|-----------------|
| Development | `{projectRoot}/packages/poem-core/poem-core-config.yaml` |
| Production | `{projectRoot}/.poem-core/poem-core-config.yaml` |

**Step 3: If Config Not Found - Use Fallback Defaults**

```typescript
// Development fallback
const devDefaults = {
  prompts: 'prompts',           // {root}/prompts/
  schemas: 'schemas',           // {root}/schemas/
  mockData: 'mock-data',        // {root}/mock-data/
  config: 'config',             // {root}/config/
  workflowData: 'workflow-data' // {root}/workflow-data/
};

// Production fallback
const prodDefaults = {
  prompts: 'poem/prompts',           // {root}/poem/prompts/
  schemas: 'poem/schemas',           // {root}/poem/schemas/
  mockData: 'poem/mock-data',        // {root}/poem/mock-data/
  config: 'poem/config',             // {root}/poem/config/
  workflowData: 'poem/workflow-data' // {root}/poem/workflow-data/
};
```

### Slash Command Hybrid Path Resolution

For Claude Code slash commands, we use a **hybrid detection + fallback** approach instead of symlinks:

**Why not symlinks?**
- Windows compatibility issues
- Git doesn't track symlinks well
- New team members forget setup steps
- CI/CD environments need special handling

**Hybrid Approach:**
1. **Detect** which directory exists (`packages/poem-core/` vs `.poem-core/`)
2. **Load** from the detected path
3. **Fallback** to alternate path if file not found

This works on all platforms, requires no setup, and handles edge cases gracefully.

### BMAD Pattern Reference

BMAD v4 solves this with:
1. Configuration-driven resolution via `core-config.yaml`
2. No hardcoded paths in agent files
3. Installer copies source → installed location
4. `IDE-FILE-RESOLUTION` rules in slash commands

### Current Hardcoded Code (to replace)

```typescript
// packages/poem-app/src/pages/api/prompt/render.ts:58-64
function resolveTemplatePath(templatePath: string): string {
  const monorepoRoot = path.resolve(process.cwd(), '..', '..');
  const poemPromptsPath = path.join(monorepoRoot, 'prompts', templatePath);
  return poemPromptsPath;
}
```

### Target Config Service Interface

```typescript
// packages/poem-app/src/services/config/poem-config.ts
interface PoemConfig {
  isDevelopment: boolean;
  projectRoot: string;
  workspace: {
    prompts: string;
    schemas: string;
    mockData: string;
    config: string;
    workflowData: string;
  };
}

function loadPoemConfig(): PoemConfig;
function getProjectRoot(): string;
function resolvePath(type: 'prompts' | 'schemas' | 'mockData' | 'config', relativePath: string): string;

// Fallback behavior when config not found:
// - Log warning (not error)
// - Return defaults based on POEM_DEV detection
// - Server continues to function
```

### Source Tree (Relevant Files)

```
packages/poem-app/
├── src/
│   ├── pages/api/
│   │   ├── prompt/render.ts          # MODIFY: Use config service
│   │   └── schema/extract.ts         # MODIFY: Use config service
│   └── services/
│       └── config/
│           └── poem-config.ts        # CREATE: Config loading service
├── tests/
│   ├── api/
│   │   ├── prompt-render.test.ts     # MODIFY: Update path resolution
│   │   └── schema-extract.test.ts    # MODIFY: Update path resolution
│   └── services/
│       └── poem-config.test.ts       # CREATE: Config service tests

packages/poem-core/
└── poem-core-config.yaml             # CREATE: POEM workspace config

.claude/commands/poem/agents/
└── prompt-engineer.md                # MODIFY: Update IDE-FILE-RESOLUTION

scripts/
└── dev-setup.sh                      # CREATE: Development setup script
```

### Impact on Story 3.1

Story 3.1 created these files that this story must support:

| File | Location | This Story's Action |
|------|----------|---------------------|
| Agent definition | `packages/poem-core/agents/prompt-engineer.md` | Hybrid resolution finds it |
| Data file | `packages/poem-core/data/poem-principles.md` | Hybrid resolution finds it |
| Data file | `packages/poem-core/data/prompt-best-practices.md` | Hybrid resolution finds it |
| Slash command | `.claude/commands/poem/agents/penny.md` | Update IDE-FILE-RESOLUTION |

**No changes to 3.1 artifacts required** - the hybrid approach handles them automatically.

### Testing

**Test Location:** `packages/poem-app/tests/services/poem-config.test.ts`

**Testing Framework:** Vitest (per architecture)

**Key Test Scenarios:**
1. Config loads successfully from yaml file
2. Development mode detected via `POEM_DEV=true`
3. Production mode when `POEM_DEV` unset
4. Path resolution returns correct absolute paths per mode
5. Existing render/extract tests pass with new service
6. Config not found: returns defaults, logs warning, no error
7. Fallback defaults match expected dev/prod structure

**Environment Setup for Tests:**
```typescript
// Set dev mode for local testing
process.env.POEM_DEV = 'true';
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-31 | 1.0 | Initial draft - Path resolution configuration | Bob (SM) |
| 2025-12-31 | 1.1 | Added hybrid detection approach, config fallback, discovery chain docs | Sarah (PO) |
| 2025-12-31 | 2.0 | Implementation complete, all tasks done, status Ready for Review | James (Dev Agent) |
| 2025-12-31 | 2.1 | QA Review: PASS - All ACs met, comprehensive tests, ready for Done | Quinn (QA Agent) |
| 2025-12-31 | 2.2 | Task 10 Addendum: SAT Human Test 2 revealed Penny/Petra divergence; fixed slash command source-of-truth architecture | Bob (SM) + James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - configuration service implementation with straightforward debugging.

### Completion Notes List

- Created comprehensive POEM config service with async loading and singleton pattern
- Implemented hybrid detection approach for slash commands (no symlinks)
- Config service supports graceful fallback when config file missing (warning, not error)
- Added `js-yaml` dependency for YAML parsing
- Integration tests updated to explicitly set `POEM_DEV=true` in spawned server env
- Created `.env` file for local development with `POEM_DEV=true`
- All 22 config service tests pass
- All 234 non-flaky tests pass (watcher tests remain flaky per maintenance backlog)
- End-to-end verification successful: both raw and file-based templates work
- Cross-reference added to Story 3.1 Change Log

**Task 10 Addendum (Post-SAT):**
- SAT Human Test 2 (Installation Mode) revealed agent greeted as "Petra" instead of "Penny"
- Root cause: `.claude/commands/poem/` was edited as separate file from installer source (`packages/poem-core/commands/`)
- Fix: Established `packages/poem-core/commands/` as single source of truth
- Added `scripts/sync-commands.sh` with `--watch` mode for auto-sync during development
- Updated `dev-setup.sh` to sync commands as part of setup
- Added `.claude/commands/poem/` to `.gitignore` (generated, not committed)
- Documented learning in `docs/kdd/learnings/slash-command-source-duplication.md`

### File List

**Created:**
- `packages/poem-app/src/services/config/poem-config.ts` - POEM config service with path resolution
- `packages/poem-core/poem-core-config.yaml` - POEM workspace configuration
- `packages/poem-app/tests/services/poem-config.test.ts` - 22 unit tests for config service
- `scripts/dev-setup.sh` - Development environment setup script
- `scripts/sync-commands.sh` - Slash command sync script with watch mode (Task 10)
- `packages/poem-app/.env` - Development environment variables
- `docs/kdd/learnings/slash-command-source-duplication.md` - KDD learning doc (Task 10)

**Modified:**
- `packages/poem-app/src/pages/api/prompt/render.ts` - Use config service for path resolution
- `packages/poem-app/src/pages/api/schema/extract.ts` - Use config service for path resolution
- `packages/poem-core/commands/agents/prompt-engineer.md` - Source of truth for slash command (Task 10)
- `packages/poem-app/tests/api/prompt-render.test.ts` - Added POEM_DEV=true to env
- `packages/poem-app/tests/api/schema-extract.test.ts` - Added POEM_DEV=true to env
- `CLAUDE.md` - Added POEM Development Setup section
- `docs/stories/3.1.story.md` - Added cross-reference to Story 3.1.5
- `.gitignore` - Added `.claude/commands/poem/` as generated directory (Task 10)

## QA Results

### Review Date: 2025-12-31

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Risk Level**: LOW
- No auth/payment/security files touched
- Tests added (22 new unit tests)
- Moderate diff size
- No previous gate failures
- 9 ACs but well-defined scope (configuration service)

### Code Quality Assessment

**Overall**: Excellent implementation quality.

The POEM Configuration Service is well-architected:

1. **Clean Architecture**
   - Clear separation of concerns with dedicated config service
   - Singleton pattern with proper reset capability for testing
   - Async and sync variants for different use cases

2. **TypeScript Excellence**
   - Explicit interfaces for `PoemConfig`, `WorkspacePaths`
   - Type-safe `WorkspacePathType` for path resolution
   - No `any` types in API boundaries

3. **Robust Error Handling**
   - Graceful degradation when config file missing (warning, not error)
   - Fallback defaults for both dev and prod modes
   - YAML parse errors handled without crashing

4. **API Integration**
   - Clean integration with `render.ts` and `extract.ts`
   - Consistent use of `resolvePathAsync()` pattern
   - Config loaded early in request lifecycle

### Refactoring Performed

None required - implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Follows TypeScript, naming, and API patterns
- Project Structure: ✓ Files in correct locations per architecture
- Testing Strategy: ✓ 22 unit tests + integration test updates
- All ACs Met: ✓ All 9 acceptance criteria fully satisfied

### Acceptance Criteria Traceability

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | API endpoints use config, not hardcoded paths | ✓ PASS | `render.ts:10`, `extract.ts:11` import config service |
| 2 | Config service loads poem-core-config.yaml | ✓ PASS | `poem-config.ts:104-131` |
| 3 | POEM_DEV=true detection | ✓ PASS | `poem-config.ts:68-70`, tests verify |
| 4 | Dev mode paths to monorepo root | ✓ PASS | `poem-config.ts:78-86`, tests verify |
| 5 | Prod mode paths to project root | ✓ PASS | Fallback defaults in `PROD_DEFAULTS` |
| 6 | Slash commands use hybrid resolution | ✓ PASS | `prompt-engineer.md` updated with hybrid pattern |
| 7 | All existing tests pass | ✓ PASS | 234/234 non-flaky tests pass |
| 8 | Development setup documented | ✓ PASS | `scripts/dev-setup.sh`, `CLAUDE.md` updated |
| 9 | Graceful fallback on missing config | ✓ PASS | Tests verify warning logged, defaults used |

### Test Architecture Assessment

**Coverage**: Excellent
- 22 unit tests for config service
- All core functions tested: `loadPoemConfig`, `resolvePath`, `isDevelopmentMode`
- Edge cases covered: missing config, various POEM_DEV values, cached vs uncached
- Integration tests updated with explicit POEM_DEV=true

**Test Quality**: Good
- Proper setup/teardown with `resetConfig()`
- Console.warn mocked appropriately
- Both dev and prod modes tested

### Improvements Checklist

All items complete - no outstanding issues:

- [x] Config service follows singleton pattern with reset
- [x] Fallback defaults for both modes
- [x] Warning logged when config missing (not error)
- [x] API endpoints integrated with config service
- [x] Integration tests set POEM_DEV=true explicitly
- [x] Dev setup script created
- [x] Documentation updated
- [ ] Optional: Add Zod validation for config file content (future enhancement)
- [ ] Optional: Implement `logging` and `features` config sections (currently unused)

### Security Review

N/A - Configuration service with no security-sensitive operations. Paths are resolved within workspace boundaries per coding standards.

### Performance Considerations

- Config is cached after first load (singleton pattern)
- No performance concerns identified
- YAML parsing happens once at startup

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.1.5-path-resolution-config.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, clean implementation following established patterns.

### Story Completion

**Reviewed**: 2025-12-31T09:20:00Z
**Final Status Recommendation**: Done

# Story 3.1.5 - Acceptance Test Guide

## Quick Summary

**Story**: Implement Path Resolution Configuration
**Status**: Ready for Review
**Test Focus**: Verify that Story 3.1's path resolution failure is fixed - the Prompt Engineer agent now loads data files correctly in development mode.

## Origin: Story 3.1 Failure

**This story exists because Story 3.1's first human test failed.**

When testing `/poem/agents/prompt-engineer` after Story 3.1 completion:

```
‚è∫ Read(.poem-core/core-config.yaml)
  ‚éø  Error reading file

‚è∫ Read(.poem-core/data/poem-principles.md)
  ‚éø  Error reading file

‚è∫ Search(pattern: "**/.poem-core/**")
  ‚éø  Found 0 files
```

**Root Cause**: Slash commands expected `.poem-core/` (production path) but development files are at `packages/poem-core/`.

**Fix Applied**: Hybrid path resolution that detects environment and loads from correct location.

---

## Prerequisites

**Before testing, ensure:**

- [x] Story 3.1.5 status is "Ready for Review"
- [x] All implementation files created per Dev Agent Record
- [x] POEM_DEV=true is set in `.env` file
- [ ] Claude Code CLI available for Human Tests

**Files to verify exist:**

- `packages/poem-app/src/services/config/poem-config.ts`
- `packages/poem-core/poem-core-config.yaml`
- `packages/poem-app/.env` (with POEM_DEV=true)
- `scripts/dev-setup.sh`

**Working directory**: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`

---

## ü§ñ Terminal Tests

### Test A: AC2 - Config service exists and exports correctly

**What to test**: Config service file exists with expected exports

**Command**:

```bash
grep -E "^export (function|interface|type|const)" packages/poem-app/src/services/config/poem-config.ts
```

**Expected Output**:

```
export interface WorkspacePaths {
export interface PoemConfig {
export type WorkspacePathType = keyof WorkspacePaths;
export function isDevelopmentMode(): boolean {
export function getProjectRoot(): string {
export async function loadPoemConfig(): Promise<PoemConfig> {
export async function getPoemConfig(): Promise<PoemConfig> {
export function getPoemConfigSync(): PoemConfig {
export function resolvePath(type: WorkspacePathType, relativePath: string = ''): string {
export async function resolvePathAsync(type: WorkspacePathType, relativePath: string = ''): Promise<string> {
export function resetConfig(): void {
```

**Validation**:

- [ ] WorkspacePaths interface exported
- [ ] PoemConfig interface exported
- [ ] isDevelopmentMode function exported
- [ ] loadPoemConfig function exported
- [ ] resolvePath function exported

**Status**: ‚úÖ Passed

**Notes**: All expected exports found: WorkspacePaths, PoemConfig, WorkspacePathType, isDevelopmentMode, getProjectRoot, getPoemConfigSync, resolvePath, resetConfig

---

### Test B: AC2 - Config file exists with workspace paths

**What to test**: poem-core-config.yaml exists with workspace configuration

**Command**:

```bash
cat packages/poem-core/poem-core-config.yaml | grep -A5 "workspace:"
```

**Expected Output**:

```yaml
workspace:
  # Handlebars prompt templates (.hbs files)
  prompts: prompts
  # JSON schema definitions for prompts
  schemas: schemas
  # Generated mock data for testing
```

**Validation**:

- [x] Config file exists
- [x] workspace section defined
- [x] prompts path configured
- [x] schemas path configured

**Status**: ‚úÖ Passed

**Notes**: Config file exists with workspace paths: prompts, schemas, mockData defined

---

### Test C: AC3 - Development mode detection

**What to test**: POEM_DEV environment variable detection works

**Command**:

```bash
cd packages/poem-app && POEM_DEV=true npx vitest run -t "should return true when POEM_DEV=true" 2>&1 | tail -5
```

**Expected Output**:

```
 ‚úì tests/services/poem-config.test.ts > POEM Configuration Service > isDevelopmentMode() > should return true when POEM_DEV=true
```

**Validation**:

- [x] Test passes
- [x] POEM_DEV=true detected correctly

**Status**: ‚úÖ Passed

**Notes**: Test "should return true when POEM_DEV=true" passed

---

### Test D: AC7 - All config service tests pass

**What to test**: All 22 unit tests for config service pass

**Command**:

```bash
cd packages/poem-app && npm test -- tests/services/poem-config.test.ts 2>&1 | tail -5
```

**Expected Output**:

```
 ‚úì tests/services/poem-config.test.ts (22 tests) XXms

 Test Files  1 passed (1)
      Tests  22 passed (22)
```

**Validation**:

- [x] All 22 tests pass
- [x] No failures or errors

**Status**: ‚úÖ Passed

**Notes**: 22/22 tests passed in 10ms

---

### Test E: AC1 - API endpoints use config service

**What to test**: render.ts and extract.ts import and use config service

**Command**:

```bash
grep "resolvePathAsync\|loadPoemConfig" packages/poem-app/src/pages/api/prompt/render.ts packages/poem-app/src/pages/api/schema/extract.ts
```

**Expected Output**:

```
packages/poem-app/src/pages/api/prompt/render.ts:import { resolvePathAsync, loadPoemConfig } from '../../../services/config/poem-config.js';
packages/poem-app/src/pages/api/prompt/render.ts:    await loadPoemConfig();
packages/poem-app/src/pages/api/prompt/render.ts:  return resolvePathAsync('prompts', templatePath);
packages/poem-app/src/pages/api/schema/extract.ts:import { resolvePathAsync, loadPoemConfig } from '../../../services/config/poem-config.js';
packages/poem-app/src/pages/api/schema/extract.ts:    await loadPoemConfig();
packages/poem-app/src/pages/api/schema/extract.ts:  return resolvePathAsync('prompts', templatePath);
```

**Validation**:

- [x] render.ts imports config service
- [x] render.ts calls loadPoemConfig()
- [x] render.ts uses resolvePathAsync()
- [x] extract.ts imports config service
- [x] extract.ts calls loadPoemConfig()

**Status**: ‚úÖ Passed

**Notes**: Both API files import and use resolvePathAsync and loadPoemConfig from config service

---

### Test F: AC6 - Slash command has hybrid resolution

**What to test**: Prompt engineer slash command has updated IDE-FILE-RESOLUTION

**Command**:

```bash
grep -A10 "IDE-FILE-RESOLUTION:" .claude/commands/poem/agents/prompt-engineer.md | head -15
```

**Expected Output** (should include):

```yaml
IDE-FILE-RESOLUTION:
  - FOR LATER USE ONLY - NOT FOR ACTIVATION, when executing commands that reference dependencies
  - HYBRID PATH RESOLUTION (works in both development and production):
    - STEP 1: Detect environment by checking which directory exists at project root:
      - If `packages/poem-core/` exists ‚Üí DEVELOPMENT mode
      - If only `.poem-core/` exists ‚Üí PRODUCTION mode
```

**Validation**:

- [x] HYBRID PATH RESOLUTION mentioned
- [x] STEP 1 detection logic present
- [x] Development mode path: packages/poem-core/
- [x] Production mode path: .poem-core/

**Status**: ‚úÖ Passed

**Notes**: Full hybrid resolution with STEP 1/STEP 2 detection and FALLBACK logic present

---

### Test G: AC8 - Development setup script exists

**What to test**: dev-setup.sh script exists and is executable

**Command**:

```bash
ls -la scripts/dev-setup.sh && head -20 scripts/dev-setup.sh
```

**Expected Output**:

```
-rwxr-xr-x  1 user  staff  XXXX  Dec 31 XX:XX scripts/dev-setup.sh
#!/bin/bash
#
# POEM Development Setup Script
...
```

**Validation**:

- [x] Script exists
- [x] Script is executable (has x permission)
- [x] Contains shebang (#!/bin/bash)
- [x] Sets POEM_DEV=true

**Status**: ‚úÖ Passed

**Notes**: Script exists at scripts/dev-setup.sh (2161 bytes), executable, proper shebang

---

### Test H: AC9 - Graceful fallback when config missing

**What to test**: Config service returns defaults when config file not found

**Command**:

```bash
cd packages/poem-app && npm test -- -t "should use fallback defaults when config file not found" 2>&1 | tail -10
```

**Expected Output**:

```
 ‚úì ... > should use fallback defaults when config file not found
```

**Validation**:

- [x] Test passes
- [x] Warning logged (not error)
- [x] Defaults returned

**Status**: ‚úÖ Passed

**Notes**: Fallback tests pass - 22/22 tests including fallback scenarios

---

## üßë Human Tests (Claude Code Conversation)

### Test 1: Development Mode - Agent Activation

**What to test**: `/poem/agents/prompt-engineer` works in development (monorepo)

**Steps**:

1. Navigate to poem project: `cd ~/dev/ad/poem-os/poem`
2. Open Claude Code and activate: `/poem/agents/prompt-engineer`
3. **Observe file read operations and greeting**

**Expected Result**:
‚úÖ Agent activates **WITHOUT** these errors:

```
‚ùå Read(.poem-core/core-config.yaml)
   ‚éø  Error reading file

‚ùå Read(.poem-core/data/poem-principles.md)
   ‚éø  Error reading file
```

‚úÖ Instead, agent should:

- Read from `packages/poem-core/` paths (development mode)
- Greet as **Penny** without file read errors
- Display *help command list

**Status**: ‚úÖ Passed

**Notes**: Agent greets as Penny, loads from packages/poem-core/, no read errors.

---

### Test 2: Installation Mode - Agent Activation

**What to test**: `/poem/agents/prompt-engineer` works after fresh installation

**Steps**:

1. Create clean test directory: `mkdir -p ~/dev/experiments/poem-test && cd ~/dev/experiments/poem-test`
2. Install POEM: `node ~/dev/ad/poem-os/poem/bin/install.js install`
3. Verify install: `ls -la .poem-core/`
4. Open Claude Code and activate: `/poem/agents/prompt-engineer`
5. **Observe agent greeting and name**

**Expected Result**:
‚úÖ Agent activates successfully:

- Reads from `.poem-core/` paths (production mode)
- Greets as **Penny** (not Petra or other names)
- Loads poem-principles.md from `.poem-core/data/`

**Status**: ‚úÖ Passed (after Task 10 fix)

**Notes**:
- **Initial test FAILED** - Agent greeted as "Petra" instead of "Penny"
- Root cause: `.claude/commands/poem/` was separate file from installer source `packages/poem-core/commands/`
- **Fixed via Task 10**: Established single source-of-truth, synced files
- **Re-test PASSED**: Agent now greets as Penny in both modes

---

### Test 3: API Path Resolution

**What to test**: API endpoint resolves template paths in development mode

**Steps**:

1. Start dev server: `cd packages/poem-app && POEM_DEV=true npm run dev`
2. Test API:

```bash
curl -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{"template": "test/hello.hbs", "data": {"name": "SAT Test"}}'
```

**Expected Result**:
‚úÖ Response includes:

```json
{
  "success": true,
  "rendered": "Hello, SAT Test!...",
  "templatePath": "/Users/.../poem-os/poem/prompts/test/hello.hbs"
}
```

**Validation**:

- [x] success: true
- [x] rendered contains the data
- [x] templatePath resolves to monorepo root (not .poem-app/)

**Status**: ‚úÖ Passed

**Notes**: Verified during Task 8 end-to-end testing.

---

### Test 4: Agent Loads Data Files

**What to test**: After activation, agent has loaded poem-principles.md content

**Steps**:

1. After Test 1 activation succeeds
2. Ask the agent: "What are the POEM principles you follow?"
3. Observe response

**Expected Result**:
‚úÖ Agent responds with content from `packages/poem-core/data/poem-principles.md`:

- Mentions POEM principles
- Content matches what's in the data file
- Doesn't say "file not found" or "couldn't load"

**Status**: ‚úÖ Passed

**Notes**: Agent references POEM principles correctly from data files.

---

## Test Checklist

**Terminal Tests:**

- [x] Test A: Config service exports ‚úÖ
- [x] Test B: Config file with workspace paths ‚úÖ
- [x] Test C: Development mode detection ‚úÖ
- [x] Test D: All 22 unit tests pass ‚úÖ
- [x] Test E: API endpoints use config service ‚úÖ
- [x] Test F: Slash command has hybrid resolution ‚úÖ
- [x] Test G: Development setup script exists ‚úÖ
- [x] Test H: Graceful fallback behavior ‚úÖ

**Human Tests:**

- [x] Test 1: Development Mode - Agent Activation ‚úÖ
- [x] Test 2: Installation Mode - Agent Activation ‚úÖ (after Task 10 fix)
- [x] Test 3: API Path Resolution ‚úÖ
- [x] Test 4: Agent Loads Data Files ‚úÖ

**Overall Status**: ‚úÖ Complete (Terminal: 8/8, Human: 4/4)

---

## Relationship to Story 3.1

| Story 3.1 SAT Test | Status Before 3.1.5 | Status After 3.1.5 |
|--------------------|---------------------|-------------------|
| Human Test 1: Slash command activates | ‚ùå Failed (file read errors) | Should be ‚úÖ |
| Human Test 2: Agent greets correctly | Partially worked | Should be ‚úÖ |
| Human Test 3: Persona consistency | Not tested | Should be ‚úÖ |
| Human Test 4: Commands reference workflows | Not tested | Should be ‚úÖ |

**After Story 3.1.5 passes, Story 3.1's Human Tests should be re-executed.**

---

## Troubleshooting

### Issue: Still getting "Error reading file" for .poem-core/

**Symptom**: Agent tries to read from `.poem-core/` instead of `packages/poem-core/`
**Solution**:
1. Verify `.claude/commands/poem/agents/prompt-engineer.md` has the updated IDE-FILE-RESOLUTION
2. Check that the hybrid detection logic mentions checking for `packages/poem-core/` first
3. Restart Claude Code to pick up changes

### Issue: API returns wrong path

**Symptom**: templatePath shows `.poem-app/` instead of monorepo root
**Solution**:
1. Verify POEM_DEV=true is set in environment
2. Check `.env` file exists with POEM_DEV=true
3. Restart the dev server

### Issue: Config fallback not working

**Symptom**: Server crashes when config file missing
**Solution**: This shouldn't happen - the service should log a warning and use defaults. Check `poem-config.ts` error handling.

---

## Test Results Summary

**Date Tested**: 2025-12-31
**Testers**:
- Quinn (Test Architect) - Terminal Tests
- David (Human) - Human Tests

**Results**:

- Terminal Tests: 8 / 8 passed ‚úÖ
- Human Tests: 4 / 4 passed ‚úÖ
- Total: 12 / 12 passed ‚úÖ

**Primary Success Criteria**: ‚úÖ PASSED

**Issues Found & Fixed**:

| Issue | Found In | Root Cause | Fix |
|-------|----------|------------|-----|
| Agent greeted as "Petra" in installation mode | Human Test 2 | Duplicate slash command sources | Task 10: Single source-of-truth |

**Sign-off**: ‚úÖ **Story Accepted**

---

_Generated by Quinn (Test Architect) from Story 3.1.5_
_Updated with Human Test results and Task 10 fix documentation_
_This SAT validates the fix for Story 3.1's path resolution failure_

# Story 1.7 - Acceptance Test Guide

## Quick Summary

**Story**: Startup Script and Port Configuration
**Status**: Ready for Review
**Test Focus**: CLI commands for starting POEM server, configuring port, and managing multi-instance deployments

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Ready for Review"
- [ ] Working directory is the POEM project root (`/Users/davidcruwys/dev/ad/poem-os/poem`)
- [ ] Server is NOT running
- [ ] Dependencies installed (`npm install`)

**Environment Setup:**

- Node.js: 22.x or higher
- Default Port: 4321
- Working directory: Project root (not `.poem-app/`)

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - interactive prompts, server startup, colored logs.

### Test 1: AC3 - Port prompt during installation

**What to test**: During installation, users are prompted for port number with default 4321

**Steps**:

1. Create a test directory: `mkdir /tmp/poem-test-install && cd /tmp/poem-test-install`
2. Run installation: `npx poem-os install` (use `npm link` first if testing local build)
3. Observe the installation flow
4. When prompted "? What port should POEM run on? (default: 4321):", press Enter to accept default
5. Observe confirmation message

**Expected Result**:
‚úÖ Port prompt appears during installation:
- Prompt shows: "? What port should POEM run on? (default: 4321):"
- Pressing Enter accepts 4321
- Installation completes successfully
- Confirmation message: "‚úì Configured server port: 4321"

**Evidence**:
- Screenshot of port prompt
- Screenshot of successful installation with port confirmation

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC1 - Start command launches server from project root

**What to test**: `npx poem-os start` launches POEM server showing Astro logs

**Steps**:

1. From a directory where POEM is installed, run: `npx poem-os start`
2. Observe terminal output for server startup messages
3. Look for Astro dev server messages
4. Verify port number in logs
5. Press Ctrl+C to stop server

**Expected Result**:
‚úÖ Server starts successfully:
- Message: "üöÄ Starting POEM server on port 4321..."
- Astro dev server logs appear (colored, formatted)
- Server accessible at indicated port
- Ctrl+C stops server cleanly

**Evidence**:
- Screenshot of terminal showing startup messages
- Screenshot of Astro logs

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC5 - Temporary port override with --port flag

**What to test**: `npx poem-os start --port=XXXX` overrides port temporarily

**Steps**:

1. Run: `npx poem-os start --port=3000`
2. Observe terminal output
3. Verify Astro logs show port 3000
4. Press Ctrl+C to stop
5. Run `npx poem-os config --list` to verify .env still has original port

**Expected Result**:
‚úÖ Server starts on custom port:
- Message: "üöÄ Starting POEM server on port 3000..."
- Astro logs show port 3000
- Original .env configuration unchanged

**Evidence**:
- Screenshot showing port 3000 in startup logs
- Config --list output showing original port unchanged

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC2 - Error when POEM not installed

**What to test**: Start command validates .poem-app/ exists and shows helpful error

**Command**:

```bash
cd /tmp/poem-not-installed-test && npx poem-os start
```

**Expected Output**:

```
‚ùå POEM is not installed in this directory.
   Run: npx poem-os install
```

**Validation**:

- ‚úÖ Error message is clear and helpful
- ‚úÖ Suggests installation command
- ‚úÖ Exit code is non-zero

**Status**: ‚úÖ Passed

**Notes**: Verified - error message displays correctly with helpful suggestion

---

### Test B: AC4 - Port written to .env file

**What to test**: Installation writes PORT to .poem-app/.env

**Command**:

```bash
# After installation, check .env contents
grep "PORT=" .poem-app/.env
```

**Expected Output**:

```
PORT=4321
```

**Validation**:

- ‚úÖ PORT entry exists in .env file
- ‚úÖ Value matches configured port
- ‚úÖ File is valid key=value format

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC6 - Config command updates port permanently

**What to test**: `npx poem-os config --port XXXX` updates .env file

**Command**:

```bash
# Update port to 8080
npx poem-os config --port 8080

# Verify .env updated
grep "PORT=" .poem-app/.env
```

**Expected Output**:

```
‚úÖ Port updated to 8080
   Restart POEM for changes to take effect:
   npx poem-os start

PORT=8080
```

**Validation**:

- ‚úÖ Success message displayed
- ‚úÖ Restart instructions shown
- ‚úÖ .env file updated with new port
- ‚úÖ Port value is 8080

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: AC7 - Config --list displays current configuration

**What to test**: `npx poem-os config --list` shows current settings

**Command**:

```bash
npx poem-os config --list
```

**Expected Output**:

```
Current POEM Configuration:
  PORT: 4321 (default)
  POEM_DEV: false (default)
```

**Validation**:

- ‚úÖ PORT value displayed correctly
- ‚úÖ POEM_DEV value displayed
- ‚úÖ Defaults indicated with "(default)" suffix
- ‚úÖ Output is formatted and readable

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test E: AC8 - Port validation rejects too low

**What to test**: Port validation rejects values below 1024

**Command**:

```bash
npx poem-os config --port 80
```

**Expected Output**:

```
‚ùå Invalid port: 80
   Port must be between 1024 and 65535.
```

**Validation**:

- ‚úÖ Error message clear and specific
- ‚úÖ Shows valid range (1024-65535)
- ‚úÖ Exit code is non-zero
- ‚úÖ .env file unchanged

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test F: AC8 - Port validation rejects too high

**What to test**: Port validation rejects values above 65535

**Command**:

```bash
npx poem-os config --port 70000
```

**Expected Output**:

```
‚ùå Invalid port: 70000
   Port must be between 1024 and 65535.
```

**Validation**:

- ‚úÖ Error message clear and specific
- ‚úÖ Shows valid range
- ‚úÖ Exit code is non-zero

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test G: AC8 - Port validation rejects non-numeric

**What to test**: Port validation rejects non-numeric values

**Command**:

```bash
npx poem-os config --port abc
```

**Expected Output**:

```
‚ùå Invalid port: abc
   Port must be between 1024 and 65535.
```

**Validation**:

- ‚úÖ Error message clear
- ‚úÖ Rejects alphabetic input
- ‚úÖ Exit code is non-zero

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test H: AC8 - Port validation accepts boundary values

**What to test**: Port validation accepts 1024 and 65535 (boundaries)

**Command**:

```bash
# Test lower boundary
npx poem-os config --port 1024
grep "PORT=" .poem-app/.env

# Test upper boundary
npx poem-os config --port 65535
grep "PORT=" .poem-app/.env
```

**Expected Output**:

```
‚úÖ Port updated to 1024
   Restart POEM for changes to take effect:
   npx poem-os start

PORT=1024

‚úÖ Port updated to 65535
   Restart POEM for changes to take effect:
   npx poem-os start

PORT=65535
```

**Validation**:

- ‚úÖ Both boundary values accepted
- ‚úÖ .env updated correctly for each
- ‚úÖ Success messages displayed

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test I: AC9 - Cross-platform compatibility (shebang)

**What to test**: Scripts have proper shebang for Unix/Linux/macOS

**Command**:

```bash
head -1 bin/install.js
head -1 bin/utils.js
```

**Expected Output**:

```
#!/usr/bin/env node
#!/usr/bin/env node
```

**Validation**:

- ‚úÖ Both files have correct shebang
- ‚úÖ Uses `/usr/bin/env node` (not hardcoded path)
- ‚úÖ Files executable permission set

**Status**: ‚úÖ Passed

**Notes**: Verified - both scripts have correct shebang

---

### Test J: AC9 - Cross-platform compatibility (npm.cmd handling)

**What to test**: Code checks for Windows and uses npm.cmd

**Command**:

```bash
grep -n "process.platform.*win32" bin/install.js
grep -n "npm.cmd" bin/install.js
```

**Expected Output**:

```
597:  const npm = process.platform === 'win32' ? 'npm.cmd' : 'npm';
```

**Validation**:

- ‚úÖ Code detects Windows platform
- ‚úÖ Uses npm.cmd on Windows
- ‚úÖ Uses npm on Unix/macOS

**Status**: ‚úÖ Passed

**Notes**: Verified - Windows compatibility code present at line 597

---

### Test K: AC10 - README.md documentation updated

**What to test**: README.md contains new start and config commands

**Command**:

```bash
grep -E "(npx poem-os start|npx poem-os config)" README.md | head -6
```

**Expected Output**:

```
npx poem-os start
npx poem-os start --port=3000
npx poem-os config --list
npx poem-os config --port 8080
```

**Validation**:

- ‚úÖ Start command documented
- ‚úÖ Port override example shown
- ‚úÖ Config --list documented
- ‚úÖ Config --port documented
- ‚úÖ Examples are copy-paste ready

**Status**: ‚úÖ Passed

**Notes**: Verified - all commands documented with examples in README.md

---

### Test L: AC10 - PUBLISHING.md documentation updated

**What to test**: PUBLISHING.md documents port prompt during installation

**Command**:

```bash
grep -A2 "What port should POEM run on" PUBLISHING.md
```

**Expected Output**:

```
# "? What port should POEM run on? (default: 4321):"
# Press Enter to accept default or enter custom port (1024-65535)
```

**Validation**:

- ‚úÖ Port prompt documented
- ‚úÖ Default value shown (4321)
- ‚úÖ Valid range documented (1024-65535)

**Status**: ‚úÖ Passed

**Notes**: Verified - installation flow with port prompt documented in PUBLISHING.md

---

### Test M: Unit tests passing

**What to test**: All unit tests pass (22 tests total)

**Command**:

```bash
npx vitest run tests/bin/
```

**Expected Output**:

```
‚úì tests/bin/command-router.test.ts (8 tests)
‚úì tests/bin/utils.test.ts (14 tests)

Test Files  2 passed (2)
     Tests  22 passed (22)
```

**Validation**:

- ‚úÖ All 22 unit tests pass
- ‚úÖ No test failures
- ‚úÖ Port validation tests included
- ‚úÖ .env operations tests included

**Status**: ‚úÖ Passed

**Notes**: All unit tests passing - 14 utils tests + 8 command router tests

---

## ‚è≥ Not Testable Yet

None - all acceptance criteria are testable in current implementation.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: Port prompt during installation (AC3)
- [ ] Test 2: Start command launches server (AC1)
- [ ] Test 3: Temporary port override (AC5)

**Terminal Tests:**

- [x] Test A: Error when not installed (AC2)
- [ ] Test B: Port written to .env (AC4)
- [ ] Test C: Config updates port permanently (AC6)
- [ ] Test D: Config --list displays settings (AC7)
- [ ] Test E: Port validation rejects too low (AC8)
- [ ] Test F: Port validation rejects too high (AC8)
- [ ] Test G: Port validation rejects non-numeric (AC8)
- [ ] Test H: Port validation accepts boundaries (AC8)
- [x] Test I: Cross-platform shebang (AC9)
- [x] Test J: Cross-platform npm.cmd (AC9)
- [x] Test K: README.md updated (AC10)
- [x] Test L: PUBLISHING.md updated (AC10)
- [x] Test M: Unit tests passing

**Overall Status**: üîÑ In Progress

---

## Troubleshooting

### Issue: Port already in use

**Symptom**: Server fails to start with EADDRINUSE error
**Solution**:
```bash
# Check what's using the port
lsof -i :4321

# Use different port
npx poem-os start --port=4322
```

### Issue: POEM not installed error

**Symptom**: "POEM is not installed in this directory"
**Solution**:
```bash
# Run installation first
npx poem-os install
```

### Issue: Invalid port error persists

**Symptom**: Port validation fails even with valid port
**Solution**:
- Ensure port is between 1024-65535
- Check for typos in port number
- Use integer values only (no decimals)

### Issue: Config command doesn't show changes

**Symptom**: --list shows old port after --port update
**Solution**:
- .env file updated successfully
- Server needs restart to use new port
- Run `npx poem-os start` to apply changes

---

## Test Results Summary

**Date Tested**: 2026-01-14 (Automated tests)
**Tester**: Taylor (SAT Agent)

**Results**:

- Human Tests: 0 / 3 passed (awaiting David's manual execution)
- Terminal Tests (Automated): 5 / 5 passed ‚úÖ
- Terminal Tests (Require Installation): 0 / 8 pending (David to execute after install)
- Total Automated: 5 / 5 passed ‚úÖ

**Automated Tests Completed**:
- ‚úÖ Test I: Cross-platform shebang verification
- ‚úÖ Test J: Windows npm.cmd handling verification
- ‚úÖ Test K: README.md documentation verification
- ‚úÖ Test L: PUBLISHING.md documentation verification
- ‚úÖ Test M: All 22 unit tests passing (command-router: 8, utils: 14)

**Tests Requiring Installation** (David to execute):
- Test B: Port written to .env file (AC4)
- Test C: Config updates port permanently (AC6)
- Test D: Config --list displays settings (AC7)
- Test E: Port validation rejects too low (AC8)
- Test F: Port validation rejects too high (AC8)
- Test G: Port validation rejects non-numeric (AC8)
- Test H: Port validation accepts boundaries (AC8)
- Test 1: Port prompt during installation (AC3) - Human
- Test 2: Start command launches server (AC1) - Human
- Test 3: Temporary port override (AC5) - Human

**Issues Found**: None in automated tests

**Sign-off**: ‚¨ú Story accepted | ‚¨ú Issues require fixes (pending David's tests)

---

_Generated by Taylor (SAT Guide Creator) from Story 1.7_

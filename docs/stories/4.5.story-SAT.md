# Story 4.5 - Acceptance Test Guide

## Quick Summary

**Story**: Run Single Prompt with Mock Data
**Status**: Review
**Test Focus**: API endpoint that renders Handlebars templates with data and returns metadata

## Prerequisites

**Before testing, ensure:**

- [ ] Story status is "Review" ‚úÖ
- [ ] Server is running on port 4321
- [ ] Required dependencies installed (`npm install`)
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app`

**Environment Setup:**

- Node.js: 22.x LTS
- Port: 4321 (Astro dev server)
- Working directory: `packages/poem-app`
- Dev mode: `POEM_DEV=true`

**Start Server:**

```bash
cd /Users/davidcruwys/dev/ad/poem-os/poem/packages/poem-app
npm run dev
```

Wait for: `Server ready at http://localhost:4321`

---

## üßë Human Tests (Visual/Manual)

**None for this story** - All acceptance criteria are API-testable via terminal commands.

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - API accepts template path and data

**What to test**: API endpoint accepts both raw templates and data in request body

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Hello {{name}}!",
    "data": {"name": "World"},
    "isRawTemplate": true
  }' | jq
```

**Expected Output**:

```json
{
  "success": true,
  "rendered": "Hello World!",
  "renderTimeMs": <number>,
  "warnings": [],
  "dataSource": "provided",
  "helperUsageCount": <number>
}
```

**Validation**:

- ‚úÖ Response is valid JSON
- ‚úÖ `success` field is `true`
- ‚úÖ `rendered` field contains "Hello World!"
- ‚úÖ `renderTimeMs` is a positive number
- ‚úÖ `warnings` is an empty array
- ‚úÖ `dataSource` field is "provided"
- ‚úÖ `helperUsageCount` field is a number ‚â• 0

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test B: AC2 - Template renders with Handlebars helpers

**What to test**: All 4 custom Handlebars helpers work correctly (titleCase, truncate, gt, join, formatTimestamp)

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "{{titleCase name}} - {{truncate description 20}}",
    "data": {
      "name": "hello world",
      "description": "This is a very long description that will be truncated"
    },
    "isRawTemplate": true
  }' | jq
```

**Expected Output**:

```json
{
  "success": true,
  "rendered": "Hello World - This is a very lon...",
  "renderTimeMs": <number>,
  "warnings": [],
  "dataSource": "provided",
  "helperUsageCount": <number>
}
```

**Validation**:

- ‚úÖ `titleCase` helper capitalizes "hello world" to "Hello World"
- ‚úÖ `truncate` helper limits description to 20 characters with "..."
- ‚úÖ `rendered` output shows both helpers working
- ‚úÖ No errors in response

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC3 - Rendered output returned in response

**What to test**: Rendered template content is returned in `rendered` field

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Name: {{firstName}} {{lastName}}\nAge: {{age}}",
    "data": {"firstName": "John", "lastName": "Doe", "age": 30},
    "isRawTemplate": true
  }' | jq -r '.rendered'
```

**Expected Output**:

```
Name: John Doe
Age: 30
```

**Validation**:

- ‚úÖ Output contains "Name: John Doe"
- ‚úÖ Output contains "Age: 30"
- ‚úÖ Newline preserved in output
- ‚úÖ All placeholders replaced correctly

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: AC4 - Missing placeholder fields reported as warnings

**What to test**: Missing data fields generate warnings, not errors (graceful degradation)

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "{{firstName}} {{lastName}} {{email}}",
    "data": {"firstName": "John"},
    "isRawTemplate": true
  }' | jq
```

**Expected Output**:

```json
{
  "success": true,
  "rendered": "John  ",
  "renderTimeMs": <number>,
  "warnings": [
    "Missing field: lastName",
    "Missing field: email"
  ],
  "dataSource": "provided",
  "helperUsageCount": <number>
}
```

**Validation**:

- ‚úÖ `success` is still `true` (not error)
- ‚úÖ `rendered` shows "John  " (empty strings for missing fields)
- ‚úÖ `warnings` array contains "Missing field: lastName"
- ‚úÖ `warnings` array contains "Missing field: email"
- ‚úÖ Template rendered despite missing data (graceful degradation)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test E: AC5 - Helper errors reported with context

**What to test**: Template syntax errors return 400 with helpful error context

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Hello {{name}",
    "data": {"name": "World"},
    "isRawTemplate": true
  }' | jq
```

**Expected Output**:

```json
{
  "success": false,
  "error": "Template syntax error: ...",
  "details": {
    "line": <number>,
    "column": <number>
  }
}
```

**Validation**:

- ‚úÖ HTTP status is 400 (not 200)
- ‚úÖ `success` is `false`
- ‚úÖ `error` message contains "syntax error"
- ‚úÖ `details` object includes line/column information
- ‚úÖ Server doesn't crash

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test F: AC6 - Response includes metadata

**What to test**: Response includes templatePath, dataSource, renderTimeMs, helperUsageCount

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Test",
    "data": {},
    "isRawTemplate": true
  }' | jq 'keys'
```

**Expected Output**:

```json
[
  "dataSource",
  "helperUsageCount",
  "rendered",
  "renderTimeMs",
  "success",
  "warnings"
]
```

**Validation**:

- ‚úÖ Response contains `dataSource` field
- ‚úÖ Response contains `helperUsageCount` field
- ‚úÖ Response contains `renderTimeMs` field
- ‚úÖ Response contains `warnings` field
- ‚úÖ Response contains `rendered` field
- ‚úÖ Response contains `success` field

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test G: AC6 - Verify renderTimeMs < 1 second (NFR3)

**What to test**: Render time is under 1 second for typical templates

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d "{
    \"template\": \"$(printf '{{field}} %.0s' {1..1000})\",
    \"data\": {\"field\": \"value\"},
    \"isRawTemplate\": true
  }" | jq '.renderTimeMs'
```

**Expected Output**:

```
<number less than 1000>
```

**Validation**:

- ‚úÖ `renderTimeMs` is a number
- ‚úÖ `renderTimeMs` is less than 1000 (1 second)
- ‚úÖ Large template (1000 placeholders) renders quickly

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test H: AC7 - YouTube template with all helpers

**What to test**: Complex YouTube template renders with all 4 helpers working together

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "# {{titleCase title}}\n\n{{truncate description 50}}\n\n{{#if (gt chapters.length 0)}}Chapters: {{chapters.length}}{{/if}}\n\nTags: {{join tags \", \"}}",
    "data": {
      "title": "my awesome video",
      "description": "This is a very long description that should be truncated properly for the test",
      "chapters": [{"title": "Intro"}, {"title": "Main"}],
      "tags": ["tutorial", "programming", "javascript"]
    },
    "isRawTemplate": true
  }' | jq -r '.rendered'
```

**Expected Output**:

```
# My Awesome Video

This is a very long description that should be ...

Chapters: 2

Tags: tutorial, programming, javascript
```

**Validation**:

- ‚úÖ `titleCase` helper works: "My Awesome Video"
- ‚úÖ `truncate` helper works: description limited to 50 chars
- ‚úÖ `gt` helper works: chapters condition evaluates true
- ‚úÖ `join` helper works: tags joined with ", "
- ‚úÖ All helpers work together in single template
- ‚úÖ No warnings or errors

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test I: AC8 - Output schema validation (skip if no schema)

**What to test**: When no schema exists, rendering succeeds without validation warnings

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "{\"result\": \"success\"}",
    "data": {},
    "isRawTemplate": true
  }' | jq '.warnings | map(select(contains("Schema")))'
```

**Expected Output**:

```json
[]
```

**Validation**:

- ‚úÖ No schema validation warnings (no schema file exists for raw templates)
- ‚úÖ Rendering succeeds
- ‚úÖ Warnings array doesn't contain "Schema Validation" messages

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test J: AC9 - Schema validation warnings for non-JSON output

**What to test**: Non-JSON output generates warning when schema validation attempted

**Command**:

```bash
# This test validates the warning system - raw templates skip schema validation
curl -s -X POST http://localhost:4321/api/prompt/render \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Plain text output",
    "data": {},
    "isRawTemplate": true
  }' | jq '.success'
```

**Expected Output**:

```json
true
```

**Validation**:

- ‚úÖ Request succeeds (raw templates skip schema validation)
- ‚úÖ Plain text output allowed
- ‚úÖ No errors thrown

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

**None** - All acceptance criteria are testable with current implementation.

---

## Test Checklist

Copy this checklist to track overall progress:

**Terminal Tests:**

- [ ] Test A: AC1 - API accepts template path and data
- [ ] Test B: AC2 - Template renders with helpers
- [ ] Test C: AC3 - Rendered output returned
- [ ] Test D: AC4 - Missing placeholder warnings
- [ ] Test E: AC5 - Helper errors with context
- [ ] Test F: AC6 - Response metadata fields
- [ ] Test G: AC6 - Render time < 1 second (NFR3)
- [ ] Test H: AC7 - YouTube template with all helpers
- [ ] Test I: AC8 - Schema validation skip when no schema
- [ ] Test J: AC9 - Plain text output allowed

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Server not running

**Symptom**: `curl: (7) Failed to connect to localhost port 4321`
**Solution**: Start server with `cd packages/poem-app && npm run dev`

### Issue: Port already in use

**Symptom**: `Error: listen EADDRINUSE: address already in use :::4321`
**Solution**: Kill existing process: `lsof -ti:4321 | xargs kill -9`

### Issue: jq command not found

**Symptom**: `bash: jq: command not found`
**Solution**: Install jq: `brew install jq` (macOS) or use `| python -m json.tool`

### Issue: Invalid JSON response

**Symptom**: `parse error: Invalid numeric literal`
**Solution**: Check server logs for errors, ensure POEM_DEV=true is set

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:

- Terminal Tests: __ / 10 passed
- Total: __ / 10 passed

**Issues Found**:

1. _________________
2. _________________

**Sign-off**: ‚úÖ Story accepted | ‚ùå Issues require fixes

---

_Generated by Taylor (SAT Guide Creator) from Story 4.5_

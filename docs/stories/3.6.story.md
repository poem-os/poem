# Story 3.6: Create Core Skills for Prompt Engineer

## Status

Done

## Story

**As a** prompt engineer,
**I want** autonomous skills that assist with common tasks,
**so that** I can work efficiently without always invoking full workflows.

## Acceptance Criteria

1. `check-my-prompt.md` skill validates current prompt in context
2. `preview-with-data.md` skill renders prompt with provided/mock data
3. `generate-schema.md` skill extracts input AND output schemas from template
4. Skills follow POEM skill format (markdown with instructions)
5. Skills are self-describing (suggest when they're useful)
6. Skills call API endpoints via HTTP for heavy operations
7. Skills documented in `.poem-core/skills/README.md`
8. Enhance `*list` command with formatted table, metadata (size, date modified), filtering
9. Enhance `*view` command with rich formatting, schema details, template statistics

**Note**: Basic `*list` and `*view` commands added to Prompt Engineer agent after Story 3.3 for immediate usability. This story enhances them with proper formatting, error handling, and metadata display.

## Tasks / Subtasks

- [x] Task 1: Create `preview-with-data.md` Skill (AC: 2, 4, 5, 6)
  - [x] Create `packages/poem-core/skills/preview-with-data.md` file
  - [x] Add skill metadata header (name, description, when to use)
  - [x] Document "When to Use" section (contexts for skill activation)
  - [x] Document "What It Does" section (1-2 render preview with data)
  - [x] Document "How It Works" section (sequential steps: elicit data source → load template → call render API → display output)
  - [x] Document "API Calls" section (POST /api/prompt/render)
  - [x] Add "Example Usage" section with conversation flow
  - [x] Write unit tests in `packages/poem-app/tests/skills/preview-with-data.test.ts`

- [x] Task 2: Create `generate-schema.md` Skill (AC: 3, 4, 5, 6)
  - [x] Create `packages/poem-core/skills/generate-schema.md` file
  - [x] Add skill metadata header (name, description, when to use)
  - [x] Document "When to Use" section (new prompts, schema missing, schema updates)
  - [x] Document "What It Does" section (extract input schema AND output schema)
  - [x] Document "How It Works" section (sequential steps: load template → call extract API → parse output section → save schemas)
  - [x] Document "API Calls" section (POST /api/schema/extract)
  - [x] Add "Output Schema Extraction" section (parse "Expected Output" or "Output Format" comments in template)
  - [x] Add "Example Usage" section with dual schema generation
  - [x] Write unit tests in `packages/poem-app/tests/skills/generate-schema.test.ts`

- [x] Task 3: Create Skills README Documentation (AC: 7)
  - [x] Create `packages/poem-core/skills/README.md` file
  - [x] Add overview section (what skills are, when to use vs workflows)
  - [x] Add "Skill vs Workflow" comparison table
  - [x] Add "Available Skills" table with name, file, purpose, key API endpoints
  - [x] Add "Skill Format" section (structure: When to Use, What It Does, How It Works, API Calls, Example Usage)
  - [x] Add "Creating New Skills" guidelines
  - [x] Add "Testing Skills" section (manual testing via Claude Code)

- [x] Task 4: Enhance `*list` Command with Rich Formatting (AC: 8)
  - [x] Update `packages/poem-core/agents/prompt-engineer.md` command description for `*list`
  - [x] Document enhanced behavior in agent file section "Agent Behavior → Listing Prompts"
  - [x] Add instructions to read directory with file stats (size, modified date)
  - [x] Add instructions to check for corresponding schema files in schemas directory
  - [x] Add instructions to format as Markdown table with columns: Name, Size, Modified, Has Schema
  - [x] Add instructions for optional filtering (by name pattern, with/without schema)
  - [x] Add error handling for empty directory
  - [x] Write unit tests in `packages/poem-app/tests/agent-commands/list.test.ts`

- [x] Task 5: Enhance `*view` Command with Rich Formatting (AC: 9)
  - [x] Update `packages/poem-core/agents/prompt-engineer.md` command description for `*view`
  - [x] Document enhanced behavior in agent file section "Agent Behavior → Viewing a Prompt"
  - [x] Add instructions to display template metadata (size, modified date, line count)
  - [x] Add instructions to display template content with syntax highlighting (markdown code block)
  - [x] Add instructions to display schema details (field count, required fields list, types)
  - [x] Add instructions to extract and display template statistics (placeholder count, helper usage, conditional blocks)
  - [x] Add error handling for missing files with helpful suggestions
  - [x] Write unit tests in `packages/poem-app/tests/agent-commands/view.test.ts`

- [x] Task 6: Update Prompt Engineer Agent Dependencies (AC: 2, 3)
  - [x] Update `packages/poem-core/agents/prompt-engineer.md` dependencies section
  - [x] Add `preview-with-data.md` to skills list
  - [x] Add `generate-schema.md` to skills list
  - [x] Verify all three skills listed (check-my-prompt, preview-with-data, generate-schema)

## Dev Notes

### Previous Story Insights

[Source: docs/stories/3.5.story.md § Dev Agent Record]

**Key Learnings from Story 3.5:**
- Skills are markdown documentation files that guide agent behavior, not executable code
- Skills call API endpoints for heavy operations (render, extract, validate)
- Skills should be self-describing with clear "When to Use" sections
- Skills follow structured format: When to Use → What It Does → How It Works → API Calls → Example Usage
- Unit tests validate skill document structure and content, not execution behavior
- Execution testing occurs when agents invoke skills during conversations

### Skills Component Architecture

[Source: docs/architecture/components.md § Component: Skills (poem-core)]

**Responsibility:** Autonomous single-responsibility capabilities that Claude invokes based on context

**Key Interfaces:**
- Self-describing (suggest when useful)
- Invoke via context, not explicit commands
- Call Astro APIs for heavy operations

**Dependencies:**
- Astro APIs (HTTP calls for rendering, schema extraction)
- User Workspace (file operations)

**Technology Stack:** Markdown skill definitions

**Skills to Create:**
| Skill             | File                          | Purpose                              |
| ----------------- | ----------------------------- | ------------------------------------ |
| Check My Prompt   | `skills/check-my-prompt.md`   | Validate prompt structure (EXISTING) |
| Preview with Data | `skills/preview-with-data.md` | Render with mock/example data        |
| Generate Schema   | `skills/generate-schema.md`   | Extract input AND output schemas     |

### API Endpoints for Skills

[Source: docs/architecture/api-specification.md § REST API Specification]

**Render API** (for preview-with-data skill):
- Endpoint: `POST /api/prompt/render`
- Request: `{ template: string, data: object, isRawTemplate?: boolean }`
- Response: `{ rendered: string, renderTimeMs: number, warnings: string[], templatePath: string }`
- Status Codes: 200 (success), 400 (invalid request), 404 (template not found)

**Schema Extract API** (for generate-schema skill):
- Endpoint: `POST /api/schema/extract`
- Request: `{ template: string, isRawTemplate?: boolean }`
- Response: `{ schema: object, requiredHelpers: string[], templatePath: string }`
- Status Codes: 200 (success), 400 (invalid request)

### File Locations

[Source: docs/architecture/unified-project-structure.md § Development Repository Structure]

**Skill Files:**
- Location: `packages/poem-core/skills/`
- Naming: kebab-case.md (e.g., `check-my-prompt.md`, `preview-with-data.md`)
- README: `packages/poem-core/skills/README.md`

**Test Files:**
- Location: `packages/poem-app/tests/skills/`
- Naming: `{skill-name}.test.ts` (e.g., `preview-with-data.test.ts`)
- Test agent command enhancements: `packages/poem-app/tests/agent-commands/`

**Agent File:**
- Location: `packages/poem-core/agents/prompt-engineer.md`
- Updates needed: commands description, dependencies section, agent behavior section

### Skill Document Format

[Source: packages/poem-core/skills/check-my-prompt.md]

**Required Sections:**
1. **Title** (H1) - Skill name
2. **Description** (paragraph) - Brief 1-2 sentence description
3. **When to Use** (H2) - Bulleted list of contexts for skill activation
4. **What It Does** (H2) - Numbered steps of what the skill accomplishes
5. **How It Works** (H2) - Sequential process description
6. **API Calls** (H2) - List of HTTP endpoints used with brief description
7. **Output Format** (H2) - Example output structure (code block)
8. **Example Usage** (H2) - Conversation flow showing skill activation and response

**Markdown Format:**
```markdown
# Skill Name

Brief description of skill purpose.

## When to Use

Invoke this skill when:
- Context 1
- Context 2

## What It Does

1. Step 1
2. Step 2

## How It Works

Sequential process description...

## API Calls

- `POST /api/endpoint` - Description

## Output Format

\`\`\`
Example output
\`\`\`

## Example Usage

**User context**: Context description

**Skill activation**: "User request"

**Skill response**:
\`\`\`
Response example
\`\`\`
```

### Agent Command Enhancement Pattern

[Source: packages/poem-core/agents/prompt-engineer.md § Agent Behavior]

**Current Basic Implementation:**
- `*list` - Simple formatted list of prompts, basic schema check
- `*view` - Display template content and schema, basic error handling

**Enhancement Requirements:**
- `*list` - Add file metadata (size, modified date), format as Markdown table, add filtering options
- `*view` - Add template metadata, schema field details, template statistics (placeholder count, helpers, conditionals)

**Agent Behavior Section Format:**
```markdown
## Agent Behavior

When activated, the Prompt Engineer agent assists users with:

1. **Command Name** (`*command`)
   - Bullet point describing behavior
   - Bullet point describing feature
   - Note: Enhancement details
```

### Coding Standards

[Source: docs/architecture/coding-standards.md § Naming Conventions]

**File Naming:**
- Skills: kebab-case.md (e.g., `preview-with-data.md`)
- Tests: `*.test.ts` (e.g., `preview-with-data.test.ts`)

**Critical Rules:**
- API-First for Heavy Operations: Template rendering, schema extraction MUST go through Astro APIs
- Workspace Isolation: API operations read from/write to workspace only
- Error Context: All API errors must include error type, message, and relevant context
- Graceful Degradation: Missing placeholders render as empty string, missing helpers log warning

### Testing Requirements

[Source: docs/architecture/testing-strategy.md § Manual Testing (Claude Code)]

**Skill Testing Approach:**
- Unit tests validate skill document structure and content (format, required sections, clarity)
- Manual testing via Claude Code validates skill execution (activation in context, API calls, results display)

**Test Organization:**
- Unit tests: `packages/poem-app/tests/skills/{skill-name}.test.ts`
- Agent command tests: `packages/poem-app/tests/agent-commands/{command}.test.ts`

**Test Coverage:**
- Skill document structure validation (required sections present)
- API endpoint documentation accuracy
- Example usage clarity
- When to Use section completeness

### Output Schema Extraction Pattern

[Source: docs/prd/epic-details.md § Story 3.7]

**Note:** Story 3.7 focuses on defining and validating output schemas. This story (3.6) implements the `generate-schema.md` skill which extracts BOTH input and output schemas from templates.

**Output Schema Extraction Strategy:**
1. Parse template comments for "Expected Output" or "Output Format" sections
2. Extract structure from those sections (field names, types, format)
3. Generate JSON schema for output structure
4. Save as `{prompt-name}-output.json` in schemas directory
5. If no output section found, report to user (output schemas are optional)

**Extraction Patterns:**
- Look for HTML comments: `<!-- Expected Output: ... -->`
- Look for Handlebars comments: `{{! Output Format: ... }}`
- Parse structured output examples in comments
- Infer types from examples (string, number, boolean, array, object)

## Testing

[Source: docs/architecture/testing-strategy.md]

**Test Framework:** Vitest 4.x

**Test File Locations:**
- Skill document tests: `packages/poem-app/tests/skills/`
- Agent command tests: `packages/poem-app/tests/agent-commands/`

**Test Categories:**
1. **Skill Document Structure Tests:**
   - Verify required sections present (When to Use, What It Does, How It Works, API Calls, Example Usage)
   - Verify markdown format correctness
   - Verify API endpoint documentation matches actual API spec
   - Verify example usage clarity and completeness

2. **Agent Command Enhancement Tests:**
   - Verify command descriptions updated in agent file
   - Verify enhanced behavior documented in Agent Behavior section
   - Verify command functionality through conversation simulation

3. **Skills README Tests:**
   - Verify skills table includes all skills
   - Verify skill format documentation matches actual skill files
   - Verify creation guidelines are clear

**Manual Testing via Claude Code:**
- Activate Prompt Engineer agent (`/poem/agents/penny`)
- Test `*list` command with various workspace states (empty, with prompts, with/without schemas)
- Test `*view` command with various prompt files (with schema, without schema, missing file)
- Test skills by creating natural language requests that trigger skill context
- Verify skills call correct API endpoints
- Verify output formatting is clear and useful

**NFR Validation:**
- No performance requirements for skill documents (they're static markdown)
- Skills should provide clear guidance for agent behavior
- Error messages should be helpful and actionable (NFR6)

## Change Log

| Date       | Version | Description                              | Author         |
| ---------- | ------- | ---------------------------------------- | -------------- |
| 2026-01-11 | 1.0     | Initial story draft from Epic 3 Story 3.6 | Bob (SM Agent) |
| 2026-01-12 | 1.1     | Story completed - all tasks, tests pass, QA approved | James (Dev Agent), Quinn (QA Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

<!-- Dev agent will populate this -->

### Completion Notes

**Story 3.6 Implementation Complete:**
- All 6 tasks completed successfully
- All 129 Story 3.6 tests passing (100% pass rate)
- Two skills created: preview-with-data.md and generate-schema.md
- Skills README documentation created with comprehensive guidance
- *list command enhanced with metadata table, filtering options
- *view command enhanced with rich formatting, statistics, schema details
- Agent dependencies updated with new skills

**Test Results:**
- tests/skills/preview-with-data.test.ts: 24/24 passed ✓
- tests/skills/generate-schema.test.ts: 34/34 passed ✓
- tests/skills/README.test.ts: 30/30 passed ✓
- tests/agent-commands/list.test.ts: 16/16 passed ✓
- tests/agent-commands/view.test.ts: 25/25 passed ✓
- **Total: 129/129 tests passed ✓**

**Note on Regression Test Failures:**
Full test suite shows 2 pre-existing failures unrelated to Story 3.6:
1. `tests/api/health.test.ts` - NFR performance test (server startup timeout)
2. `tests/services/handlebars/watcher.test.ts` - Helper watcher add detection

These failures existed before Story 3.6 work began and do not impact Story 3.6 functionality.

### File List

**New Files Created:**
- `packages/poem-core/skills/preview-with-data.md` - Skill for rendering prompts with mock/provided data
- `packages/poem-core/skills/generate-schema.md` - Skill for extracting input AND output schemas from templates
- `packages/poem-core/skills/README.md` - Comprehensive skills documentation
- `packages/poem-app/tests/skills/preview-with-data.test.ts` - Unit tests for preview-with-data skill (24 tests)
- `packages/poem-app/tests/skills/generate-schema.test.ts` - Unit tests for generate-schema skill (34 tests)
- `packages/poem-app/tests/skills/README.test.ts` - Unit tests for Skills README (30 tests)
- `packages/poem-app/tests/agent-commands/list.test.ts` - Unit tests for *list command enhancements (16 tests)
- `packages/poem-app/tests/agent-commands/view.test.ts` - Unit tests for *view command enhancements (25 tests)

**Modified Files:**
- `packages/poem-core/agents/prompt-engineer.md` - Enhanced *list and *view command descriptions and Agent Behavior sections

## KDD Knowledge Captured

**KDD Retrospective** (2026-01-16): Epic 3 knowledge extracted and documented during post-epic retrospective.

**Patterns**:
- [Skills Self-Description Format](../../kdd/patterns/skills-self-description-format.md) - Established markdown-based skill pattern with self-describing capabilities, used in preview-with-data.md and generate-schema.md

**Examples**:
- [Skill Creation Pattern](../../examples/skill-creation-pattern/README.md) - Demonstrates how to create skills following the self-description format established in Story 3.6

**Learnings**: None

**ADRs**:
- [ADR-004: Skills as Markdown Documentation](../../kdd/decisions/adr-004-skills-as-markdown-documentation.md) - Formalized skills pattern with YAML metadata and markdown documentation

---

## QA Results

### Review Date: 2026-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Story 3.6 delivers **exceptional quality** across all dimensions. The implementation creates two new skills (preview-with-data, generate-schema), comprehensive skills documentation, and enhances agent commands with rich formatting—all with 100% test pass rate (129/129 tests).

**Documentation Excellence** ★★★★★: All three documentation deliverables (2 skills + README) demonstrate outstanding quality with clear purposes, realistic examples, and proper API documentation.

**Test Architecture** ★★★★★: Comprehensive structure validation with 129 tests. Correctly validates document format rather than execution (appropriate for documentation files).

### Refactoring Performed

None required. Implementation quality is exceptional—no refactoring needed.

### Compliance Check

- **Coding Standards**: ✅ PASS - Perfect kebab-case.md naming conventions
- **Project Structure**: ✅ PASS - Files in correct locations (poem-core/skills, poem-app/tests)
- **Testing Strategy**: ✅ PASS - Document structure tests + manual testing guidance included
- **All ACs Met**: ✅ PASS - 9/9 acceptance criteria fully validated with tests

### Requirements Traceability

| AC | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| AC1 | check-my-prompt.md skill exists | ✅ PASS | Created in Story 3.4, confirmed in agent dependencies |
| AC2 | preview-with-data.md skill | ✅ PASS | Created with 8 sections, 24 tests pass |
| AC3 | generate-schema.md with dual schemas | ✅ PASS | Input + output extraction documented, 34 tests pass |
| AC4 | Skills follow POEM format | ✅ PASS | All skills have 8 required sections |
| AC5 | Skills self-describing | ✅ PASS | "When to Use" sections with 3+ contexts each |
| AC6 | Skills call API endpoints | ✅ PASS | POST /api/prompt/render, POST /api/schema/extract |
| AC7 | Skills README created | ✅ PASS | Comprehensive 255-line README, 30 tests pass |
| AC8 | *list command enhanced | ✅ PASS | Metadata table, filtering options, 16 tests pass |
| AC9 | *view command enhanced | ✅ PASS | Template statistics, schema details, 25 tests pass |

### Test Coverage Analysis

```
tests/skills/preview-with-data.test.ts    : 24 tests ✅
tests/skills/generate-schema.test.ts      : 34 tests ✅
tests/skills/README.test.ts               : 30 tests ✅
tests/agent-commands/list.test.ts         : 16 tests ✅
tests/agent-commands/view.test.ts         : 25 tests ✅
───────────────────────────────────────────────────────
Total Story 3.6 Tests                     : 129 tests ✅ (100% pass rate)
```

**Coverage Assessment:**
- ✅ All skill document sections validated
- ✅ All agent command enhancements validated
- ✅ README completeness validated
- ✅ API endpoint documentation accuracy validated
- ✅ Markdown format correctness validated

### Security Review

✅ **No security concerns**
- Documentation files only (no executable code)
- API-First principle properly followed
- No production data handling

### Performance Considerations

✅ **No performance concerns**
- Skills are static markdown documentation
- No runtime performance impact
- NFR6 compliance: Error messages clear and actionable

### Technical Debt Assessment

**Zero Technical Debt Created:**
- No shortcuts taken
- No missing tests
- No architecture violations
- Documentation complete and accurate

**Pre-Existing Issues (Not Introduced by Story 3.6):**
1. `tests/api/health.test.ts` - NFR performance test failure (server startup timeout)
2. `tests/services/handlebars/watcher.test.ts` - Helper watcher test failure
3. Build requires Astro adapter configuration

**Recommendation**: Address pre-existing test failures in separate maintenance story.

### Strengths

1. **Exceptional Documentation Quality**: Skills are clear, comprehensive, with realistic examples
2. **Perfect Format Adherence**: All skills follow 8-section format exactly
3. **Comprehensive Test Coverage**: 129 tests validating all aspects
4. **Standards Compliance**: Perfect naming conventions, file structure, API-First principle
5. **Self-Describing Skills**: Clear "When to Use" contexts for automatic activation
6. **Dual Schema Extraction**: generate-schema.md handles both input AND output schemas (forward-looking for Story 3.7)

### Improvements Checklist

No improvements required—implementation is complete and production-ready.

**Future Enhancements (Post-Done):**
- [ ] Add manual execution testing examples to CI/CD documentation
- [ ] Consider skill activation telemetry for usage analysis (future Epic)
- [ ] Document skill versioning strategy when API contracts change

### Files Modified During Review

None—no refactoring required.

### Quality Score

```
Quality Score: 100/100
- Critical issues (×20): 0
- Medium concerns (×10): 0
- Minor improvements (×5): 0

Calculation: 100 - 0 = 100
```

### Gate Status

**Gate: PASS** → `docs/qa/gates/3.6-create-core-skills.yml`

**Status Reason:** All acceptance criteria met with exceptional implementation quality. Zero blocking issues. Comprehensive test coverage with 100% pass rate. Perfect standards compliance. Ready for production use.

### Recommended Status

✅ **Ready for Done**

Story meets all requirements with exemplary quality. No changes required.

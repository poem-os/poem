# Story 3.2.9: Document Workflow Architecture & Testing Learnings

## Status

Done

## Story

**As a** developer preparing to implement workflow orchestration,
**I want** comprehensive workflow architecture documented with real-world testing,
**so that** Stories 3.3-3.7 can be implemented with clear architectural guidance and proven patterns.

## Acceptance Criteria

1. Workflow Definition Structure section added to `docs/architecture.md` (~429 lines)
2. Workflow format documented (YAML with name, description, sections, steps)
3. Step structure documented (prompt, inputs, outputs, checkpoint fields)
4. Auto-derived data bus concept documented and explained
5. Sequential execution model with progressive accumulation documented
6. Checkpoint (human-in-the-loop) pattern documented
7. Planning decision document created (`docs/planning/decisions/workflow-definition-format.md`)
8. PRD updated with Story 3.7 (Implement Workflow Orchestration System)
9. PRD updated with Story 4.6.5 (Auto-Generate Workflow Schema from YAML)
10. Example workflow created (`data/youtube-launch-optimizer/youtube-launch-optimizer.yaml`)
11. Real-world test prompts created in dev-workspace (6 prompts with schemas and mock data)
12. Reference Example Schemas section added to architecture.md explaining schema relationships

## Tasks / Subtasks

- [x] Task 1: Create Workflow Architecture Documentation (AC: 1, 2, 3, 4, 5, 6)
  - [x] Add "Workflow Definition Structure" section to `docs/architecture.md`
  - [x] Document basic workflow format (name, description, steps)
  - [x] Document workflow with sections (hierarchical organization)
  - [x] Document step structure (required and optional fields)
  - [x] Document input/output rules and validation
  - [x] Document auto-derived data bus concept
  - [x] Document sequential execution model
  - [x] Document checkpoint pattern for human-in-the-loop
  - [x] Document schema file format for validation
  - [x] Document future enhancements (parallel execution, conditionals, DTO mapping)

- [x] Task 2: Create Planning Decision Document (AC: 7)
  - [x] Create `docs/planning/decisions/workflow-definition-format.md`
  - [x] Document YAML format decision rationale
  - [x] Document core workflow structure examples
  - [x] Document sections pattern for complex workflows
  - [x] Document checkpoint pattern
  - [x] Document auto-derived data bus architecture
  - [x] Document execution engine model
  - [x] Document future enhancements roadmap

- [x] Task 3: Update PRD with New Stories (AC: 8, 9)
  - [x] Add Story 3.7 (Implement Workflow Orchestration System) to PRD
  - [x] Add Story 4.6.5 (Auto-Generate Workflow Schema from YAML) to PRD
  - [x] Update both consolidated PRD and sharded epic-details.md

- [x] Task 4: Create Reference Example Workflow (AC: 10)
  - [x] Create `data/youtube-launch-optimizer/youtube-launch-optimizer.yaml`
  - [x] Demonstrate 8-step workflow with sections
  - [x] Show inputs/outputs pattern
  - [x] Include prominent header explaining it's a reference example
  - [x] Document auto-derivation pattern

- [x] Task 5: Real-World Testing in Dev Workspace (AC: 11)
  - [x] Create `dev-workspace/prompts/summarize-video.hbs`
  - [x] Create `dev-workspace/prompts/abridge-transcript.hbs`
  - [x] Create `dev-workspace/prompts/identify-chapters.hbs`
  - [x] Create `dev-workspace/prompts/generate-title.hbs`
  - [x] Create `dev-workspace/prompts/thumbnail-text.hbs`
  - [x] Create `dev-workspace/prompts/video-description.hbs`
  - [x] Create corresponding JSON schemas for each prompt
  - [x] Create mock data files for testing
  - [x] Verify prompts follow POEM template structure

- [x] Task 6: Clarify Schema Architecture (AC: 12)
  - [x] Add "Reference Example Schemas" section to architecture.md
  - [x] Explain prompt-level vs workflow-level schema distinction
  - [x] Document that workflow schemas auto-derive from step I/O
  - [x] Clarify data/youtube-launch-optimizer/schemas/ are reference examples
  - [x] Update workflow-attributes.json with prominent warning header

- [x] Task 7: Update Story 3.2.5 Status (AC: implicit)
  - [x] Mark Story 3.2.5 as Done in story file

## Dev Notes

### Background Context

This story documents **retroactive work** completed between Story 3.2.5 (Dev Workspace Separation) and Story 3.3 (Refine Prompt Workflow).

**Why This Story Was Created:**
During workflow implementation and testing, significant architectural decisions and documentation were produced that weren't captured in any formal story. This created a context gap for future stories (3.3-3.7).

**Commits Documented:**
- `ce29b67` (2026-01-08): "Add comprehensive workflow definition architecture" (~2,700 lines)
- `a064e56` (2026-01-08): "Clarify workflow schema architecture and reference examples" (~200 lines)

**Total Work:** ~3,000 lines across architecture docs, planning decisions, PRD updates, and test prompts.

### Workflow Architecture Overview

[Source: docs/architecture.md § Workflow Definition Structure]

**Key Architectural Concepts:**

1. **YAML Workflow Format**
   - `name`: Workflow identifier (kebab-case)
   - `description`: Human-readable purpose
   - `sections`: Optional hierarchical grouping (SOPs)
   - `steps`: Sequential prompt execution steps

2. **Step Structure**
   - `name`: Step identifier
   - `prompt`: Path to Handlebars template
   - `inputs`: Array of required workflow attributes
   - `outputs`: Array of attributes this step produces
   - `checkpoint`: Optional flag for human-in-the-loop pauses

3. **Auto-Derived Data Bus**
   - Workflow schema = union of all step inputs + outputs
   - No manual schema definition required for workflows
   - Eliminates duplication between YAML and schema files
   - Types inferred from prompt schemas

4. **Sequential Execution Model**
   - Steps execute in order (parallel execution is future enhancement)
   - Each step reads from shared data bus (workflow-data)
   - Each step writes outputs back to data bus
   - Progressive accumulation pattern

5. **Checkpoint Pattern**
   - Steps marked `checkpoint: true` pause for human review
   - Enables human-in-the-loop workflows
   - User can modify data before continuing

### Design Decision Rationale

[Source: docs/planning/decisions/workflow-definition-format.md]

**Why YAML Format:**
- ✅ Human-readable and accessible to non-developers
- ✅ Industry-standard for configuration and orchestration
- ✅ Consistent with BMAD workflows (`.poem-core/workflows/*.yaml`)
- ✅ Structured format with clear step declarations
- ✅ Simple to extend with future features

**Why Auto-Derived Schema:**
- Eliminates redundant schema definitions
- Workflow YAML is single source of truth
- Reduces maintenance burden
- Prevents schema/workflow drift

### PRD Updates

[Source: docs/prd.md and docs/prd/epic-details.md]

**New Story 3.7: Implement Workflow Orchestration System**
- Epic 3: Prompt Management Interface
- Builds workflow execution engine for multi-step prompt chains
- Implements sequential execution with data bus
- Implements checkpoint pattern
- Depends on architecture documented in this story

**New Story 4.6.5: Auto-Generate Workflow Schema from YAML**
- Epic 4: Agent System - Workflow Integration
- Auto-derives workflow attributes from step I/O declarations
- Generates JSON schema for validation
- Implements type inference from prompt schemas

### Real-World Testing Results

[Source: dev-workspace/prompts/, dev-workspace/schemas/]

**Test Prompts Created:**
1. `summarize-video.hbs` - Video transcript summarization
2. `abridge-transcript.hbs` - Abridged transcript generation
3. `identify-chapters.hbs` - Chapter segmentation
4. `generate-title.hbs` - Video title generation
5. `thumbnail-text.hbs` - Thumbnail text optimization
6. `video-description.hbs` - YouTube description generation

**Learnings:**
- POEM template structure (Context, Input, Task, Output) works well
- Handlebars syntax integrates cleanly with YAML workflow definitions
- Schema extraction API (`POST /api/schema/extract`) successfully generates schemas
- Dev workspace isolation prevents test pollution
- Mock data generation needed for full workflow testing (deferred to Epic 7)

### Schema Architecture Clarification

[Source: docs/architecture.md § Reference Example Schemas]

**Prompt-Level Schemas:**
- Hand-written JSON schemas in `poem/schemas/` or `dev-workspace/schemas/`
- Define expected inputs/outputs for individual prompts
- Used by render API for validation

**Workflow-Level Schemas:**
- Auto-derived from workflow YAML step inputs/outputs
- NOT hand-written files
- Represent the data bus for entire workflow

**Reference Examples:**
- `data/youtube-launch-optimizer/schemas/workflow-attributes.json` is a **planning artifact**
- NOT the source of truth
- Used for validation during Epic 4 implementation
- Prominent warning header added to prevent confusion

### Project Structure Notes

[Source: docs/architecture/unified-project-structure.md]

**New Files Created:**
```
docs/
├── architecture.md                           # MODIFIED: +429 lines
└── planning/decisions/
    └── workflow-definition-format.md         # CREATED: 352 lines

docs/prd/
├── prd.md                                    # MODIFIED: +53 lines
└── epic-details.md                           # MODIFIED: +30 lines

data/youtube-launch-optimizer/
├── youtube-launch-optimizer.yaml             # CREATED: 116 lines
└── schemas/workflow-attributes.json          # MODIFIED: +15 lines (warning)

dev-workspace/
├── prompts/                                  # CREATED: 6 prompts (~500 lines)
├── schemas/                                  # CREATED: 6 schemas (~100 lines)
└── mock-data/                                # CREATED: 6 mock data files
```

### Testing

[Source: docs/architecture/testing-strategy.md]

**Testing Approach:**
- Architecture documentation reviewed manually
- Real-world prompts created and tested via `*new` workflow
- Schema extraction API validated with test prompts
- No automated tests required (documentation story)

**Validation:**
- All 6 prompts render successfully via `POST /api/prompt/render`
- Schemas extract correctly via `POST /api/schema/extract`
- Workflow YAML parses correctly (validated via example)

### Impact on Future Stories

**Stories 3.3-3.6 (Prompt Management Workflows):**
- Can now reference workflow architecture for implementation
- Have clear YAML format to follow
- Understand auto-derived schema concept
- Can use checkpoint pattern for human-in-the-loop

**Story 3.7 (Workflow Orchestration System):**
- Has complete architecture specification
- Has real-world test data (6 prompts)
- Has design decision rationale
- Has reference example workflow

**Story 4.6.5 (Auto-Generate Workflow Schema):**
- Has schema derivation algorithm documented
- Has type inference rules defined
- Has validation approach specified

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Retroactive story draft - Workflow architecture documentation | Bob (SM Agent) |
| 2026-01-09 | 1.0 | Marked Done - Work completed in commits ce29b67, a064e56 | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used

N/A - Retroactive documentation story

### Debug Log References

None - Documentation work only

### Completion Notes List

**Note on Retroactive Stories:**
This story documents work already completed. All tasks were performed during exploratory architecture and testing phase between Stories 3.2.5 and 3.3.

**What Was Completed:**
1. **Architecture Documentation** - 429 lines added to architecture.md covering workflow definition structure, YAML format, auto-derived schema, sequential execution, and checkpoint patterns
2. **Planning Decision** - 352-line decision document explaining YAML format choice and architectural rationale
3. **PRD Updates** - Added Stories 3.7 and 4.6.5 to capture workflow orchestration and schema auto-generation work
4. **Reference Example** - Created youtube-launch-optimizer.yaml demonstrating 8-step workflow with sections
5. **Real-World Testing** - Created 6 prompts, 6 schemas, and 6 mock data files in dev-workspace for validation
6. **Schema Clarification** - Added Reference Example Schemas section to architecture.md explaining prompt vs workflow schemas

**Why This Matters:**
- Prevents context gap for Stories 3.3-3.7
- Provides traceability for ~3,000 lines of architectural work
- Documents design decisions for future reference
- Establishes proven patterns from real-world testing

### File List

**Created:**
- `docs/planning/decisions/workflow-definition-format.md` - Workflow format decision document (352 lines)
- `data/youtube-launch-optimizer/youtube-launch-optimizer.yaml` - Reference example workflow (116 lines)
- `dev-workspace/prompts/summarize-video.hbs` - Video summarization prompt
- `dev-workspace/prompts/abridge-transcript.hbs` - Transcript abridgement prompt
- `dev-workspace/prompts/identify-chapters.hbs` - Chapter identification prompt
- `dev-workspace/prompts/generate-title.hbs` - Title generation prompt
- `dev-workspace/prompts/thumbnail-text.hbs` - Thumbnail text optimization prompt
- `dev-workspace/prompts/video-description.hbs` - Video description generation prompt
- `dev-workspace/schemas/summarize-video.json` - Schema for summarize prompt
- `dev-workspace/schemas/abridge-transcript.json` - Schema for abridge prompt
- `dev-workspace/schemas/identify-chapters.json` - Schema for chapters prompt
- `dev-workspace/schemas/generate-title.json` - Schema for title prompt
- `dev-workspace/schemas/thumbnail-text.json` - Schema for thumbnail prompt
- `dev-workspace/schemas/video-description.json` - Schema for description prompt
- `dev-workspace/mock-data/summarize-video.json` - Mock data for testing
- `dev-workspace/mock-data/abridge-transcript.json` - Mock data for testing
- `dev-workspace/mock-data/identify-chapters.json` - Mock data for testing
- `dev-workspace/mock-data/generate-title.json` - Mock data for testing
- `dev-workspace/mock-data/thumbnail-text.json` - Mock data for testing
- `dev-workspace/mock-data/video-description.json` - Mock data for testing

**Modified:**
- `docs/architecture.md` - Added Workflow Definition Structure section (+429 lines), Reference Example Schemas section (+21 lines)
- `docs/prd.md` - Added Stories 3.7 and 4.6.5 (+53 lines)
- `docs/prd/epic-details.md` - Added Stories 3.7 and 4.6.5 (+30 lines)
- `data/youtube-launch-optimizer/schemas/workflow-attributes.json` - Added warning header (+15 lines)
- `docs/stories/3.2.5.story.md` - Marked status as Done

## QA Results

### Review Date: 2026-01-09

### Reviewed By: N/A - Retroactive Story

### Overall Assessment

**Status:** Ready for Done (Retroactive)

This retroactive story successfully documents ~3,000 lines of workflow architecture exploration completed between Stories 3.2.5 and 3.3. The documentation provides:

- ✅ Clear YAML workflow format specification
- ✅ Auto-derived schema architecture
- ✅ Real-world testing validation (6 prompts)
- ✅ PRD updates for future implementation stories
- ✅ Design decision rationale

**Traceability:**
- Commits ce29b67 and a064e56 fully documented
- Work properly attributed and contextualized
- Future stories (3.3-3.7) can now reference this architecture

**Recommendation:** Mark Done immediately. No QA gate needed for retroactive documentation stories.

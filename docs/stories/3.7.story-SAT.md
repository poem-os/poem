# Story 3.7 - Acceptance Test Guide

## Quick Summary

**Story**: Define and Validate Output Schemas
**Status**: Review
**Test Focus**: Dual schema system (input + output) with extraction from templates and validation API endpoints

## Prerequisites

**Before testing, ensure:**

- [ ] Story 3.7 status is "Review"
- [ ] Server is running on port 4321
- [ ] Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem`
- [ ] Dependencies installed (`npm install` from root, then `cd packages/poem-app && npm install`)
- [ ] Test data files created (Terminal Test setup will create these)

**Environment Setup:**

- Node.js: 20.x+
- Port: 4321
- Server command: `cd packages/poem-app && npm run dev`
- Working directory: `/Users/davidcruwys/dev/ad/poem-os/poem`

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - browser, UI, interactive behavior.

### Test 1: AC7 - Prompt Engineer Agent Handles Dual Schemas

**What to test**: Prompt Engineer agent workflows handle dual schemas (input + output)

**Steps**:

1. In Claude Code terminal, run: `/poem/agents/penny`
2. Observe agent activation message
3. Check that agent mentions dual schema support in commands description
4. Review agent documentation for *new, *test, *validate commands

**Expected Result**:

‚úÖ Agent activation and documentation confirms dual schema support:
- Agent loads successfully
- Commands reference both input and output schemas
- Documentation mentions optional output schemas
- Workflows describe dual schema extraction and validation

**Evidence**:

- Screenshot of agent activation showing dual schema references
- Note specific commands that mention output schemas

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

**NOTE**: These tests require the server to be running. Start it with:
```bash
cd packages/poem-app && npm run dev
```

### Test A: AC2 - Schema TypeScript Interface Includes Output Schema Fields

**What to test**: Schema interface defines expected AI response structure (fields, types, format)

**Command**:

```bash
grep -A 10 "export interface Schema" packages/poem-app/src/services/schema/types.ts
```

**Expected Output**:

```typescript
export interface Schema {
  /** Relative path from /poem/schemas/ */
  path: string;
  /** Schema version */
  version: string;
  /** Human-readable description */
  description?: string;
  /** Schema type: input (data into prompt), output (data from prompt), or both */
  schemaType?: 'input' | 'output' | 'both';
  /** Field definitions */
  fields: SchemaField[];
}
```

**Validation**:

- ‚úÖ Schema interface exists
- ‚úÖ Contains `schemaType` field with 'input' | 'output' | 'both' types
- ‚úÖ Contains `fields` array of SchemaField
- ‚úÖ Field types include string, number, boolean, array, object

**Status**: ‚úÖ Passed

**Notes**: Schema interface correctly includes `schemaType` field with 'input' | 'output' | 'both' types

---

### Test B: AC3 - Output Schema Extraction from Template Comments

**What to test**: Output schema extraction from prompt "Expected Output" section

**Setup** (run once to create test template):

```bash
mkdir -p /tmp/poem-test-templates
cat > /tmp/poem-test-templates/test-dual-schema.hbs << 'EOF'
Generate a title for: {{videoTopic}}

Target audience: {{targetAudience}}

<!-- Expected Output: { "title": "string", "length": number } -->
EOF
```

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Generate a title for: {{videoTopic}}\n\nTarget audience: {{targetAudience}}\n\n<!-- Expected Output: { \"title\": \"string\", \"length\": number } -->",
    "isRawTemplate": true
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "inputSchema": {
    "fields": [
      {
        "name": "videoTopic",
        "type": "string",
        "required": true
      },
      {
        "name": "targetAudience",
        "type": "string",
        "required": true
      }
    ]
  },
  "outputSchema": {
    "fields": [
      {
        "name": "title",
        "type": "string",
        "required": true
      },
      {
        "name": "length",
        "type": "number",
        "required": true
      }
    ]
  },
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ Response includes both `inputSchema` and `outputSchema`
- ‚úÖ Input schema extracted from {{placeholders}}
- ‚úÖ Output schema extracted from <!-- Expected Output --> comment
- ‚úÖ Output schema fields parsed correctly (title: string, length: number)

**Status**: ‚úÖ Passed

**Notes**: Dual schema extraction working correctly. Both inputSchema and outputSchema returned with correct field types.

---

### Test C: AC4 - Schema Validation API Endpoint

**What to test**: API endpoint validates rendered output against output schema

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/validate \
  -H "Content-Type: application/json" \
  -d '{
    "schema": [
      {
        "name": "title",
        "type": "string",
        "required": true
      },
      {
        "name": "views",
        "type": "number",
        "required": true
      }
    ],
    "data": {
      "title": "10 Tips for Better Code",
      "views": 1500
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "valid": true,
  "errors": [],
  "validationTimeMs": 0.50
}
```

**Validation**:

- ‚úÖ Response status is 200
- ‚úÖ `success` is true
- ‚úÖ `valid` is true (data matches schema)
- ‚úÖ `errors` array is empty
- ‚úÖ `validationTimeMs` is present and < 100ms (NFR2)

**Status**: ‚úÖ Passed

**Notes**: Validation endpoint working correctly. validationTimeMs: 2.14ms (well under 100ms NFR2 requirement).

---

### Test D: AC5 - Validation Reports Missing Fields

**What to test**: Validation reports missing fields, type mismatches, format errors

**Command (Missing Required Field)**:

```bash
curl -s -X POST http://localhost:4321/api/schema/validate \
  -H "Content-Type: application/json" \
  -d '{
    "schema": [
      {
        "name": "title",
        "type": "string",
        "required": true
      },
      {
        "name": "views",
        "type": "number",
        "required": true
      }
    ],
    "data": {
      "title": "10 Tips for Better Code"
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "valid": false,
  "errors": [
    {
      "field": "views",
      "message": "Field 'views' is required but missing",
      "severity": "error"
    }
  ],
  "validationTimeMs": 0.30
}
```

**Validation**:

- ‚úÖ `valid` is false
- ‚úÖ `errors` array contains error for missing 'views' field
- ‚úÖ Error message is clear: "Field 'views' is required but missing" (NFR6)
- ‚úÖ Error includes field path, message, and severity

**Status**: ‚úÖ Passed

**Notes**: Clear error message for missing required field. validationTimeMs: 1.57ms. NFR6 requirement met.

---

### Test E: AC5 - Validation Reports Type Mismatches

**What to test**: Validation reports type mismatches

**Command (Type Mismatch)**:

```bash
curl -s -X POST http://localhost:4321/api/schema/validate \
  -H "Content-Type: application/json" \
  -d '{
    "schema": [
      {
        "name": "title",
        "type": "string",
        "required": true
      },
      {
        "name": "views",
        "type": "number",
        "required": true
      }
    ],
    "data": {
      "title": "10 Tips for Better Code",
      "views": "1500"
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "valid": false,
  "errors": [
    {
      "field": "views",
      "message": "Field 'views' expected type 'number' but received 'string'",
      "severity": "error"
    }
  ],
  "validationTimeMs": 0.35
}
```

**Validation**:

- ‚úÖ `valid` is false
- ‚úÖ Error message clearly states expected and actual types (NFR6)
- ‚úÖ Error field path is correct ('views')

**Status**: ‚úÖ Passed

**Notes**: Type mismatch error message is clear and actionable. validationTimeMs: 0.32ms. NFR6 requirement met.

---

### Test F: AC6 - Output Schemas Support Structured JSON

**What to test**: Output schemas support structured (JSON) outputs

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/validate \
  -H "Content-Type: application/json" \
  -d '{
    "schema": [
      {
        "name": "metadata",
        "type": "object",
        "required": true,
        "properties": [
          {
            "name": "author",
            "type": "string",
            "required": true
          },
          {
            "name": "tags",
            "type": "array",
            "required": true,
            "items": {
              "name": "tag",
              "type": "string",
              "required": false
            }
          }
        ]
      }
    ],
    "data": {
      "metadata": {
        "author": "John Doe",
        "tags": ["coding", "tutorial"]
      }
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "valid": true,
  "errors": [],
  "validationTimeMs": 0.60
}
```

**Validation**:

- ‚úÖ Nested object validation works (metadata.author, metadata.tags)
- ‚úÖ Array validation works (tags array with string items)
- ‚úÖ Structured JSON data validated successfully

**Status**: ‚úÖ Passed

**Notes**: Nested object and array validation working correctly. validationTimeMs: 0.47ms.

---

### Test G: AC6 - Output Schemas Support Unstructured Text

**What to test**: Output schemas support unstructured (text) outputs

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/validate \
  -H "Content-Type: application/json" \
  -d '{
    "schema": [
      {
        "name": "response",
        "type": "string",
        "required": true
      }
    ],
    "data": {
      "response": "This is a plain text response with no structure."
    }
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "valid": true,
  "errors": [],
  "validationTimeMs": 0.25
}
```

**Validation**:

- ‚úÖ Plain text (unstructured) data validated successfully
- ‚úÖ String type validation works for long text content

**Status**: ‚úÖ Passed

**Notes**: Unstructured text validation working correctly. validationTimeMs: 0.13ms.

---

### Test H: AC8 - Output Schemas Optional (Null When Missing)

**What to test**: Output schemas optional - prompts can omit if outputs are purely informational

**Command**:

```bash
curl -s -X POST http://localhost:4321/api/schema/extract \
  -H "Content-Type: application/json" \
  -d '{
    "template": "Generate a summary for: {{content}}",
    "isRawTemplate": true
  }' | jq '.'
```

**Expected Output**:

```json
{
  "success": true,
  "inputSchema": {
    "fields": [
      {
        "name": "content",
        "type": "string",
        "required": true
      }
    ]
  },
  "outputSchema": null,
  "requiredHelpers": [],
  "unregisteredHelpers": []
}
```

**Validation**:

- ‚úÖ Input schema extracted successfully
- ‚úÖ `outputSchema` is null (no output section in template)
- ‚úÖ API does not fail when output schema is missing
- ‚úÖ Output schemas are truly optional

**Status**: ‚úÖ Passed

**Notes**: Output schema correctly returns null when no output section present in template. Optional schema feature confirmed.

---

## ‚è≥ Not Testable Yet

**AC1**: Output schema stored alongside input schema (e.g., `generate-title-output.json`)

**Reason**: Requires user workspace with actual schema files. This is a file naming convention tested implicitly through documentation and integration usage.

**When**: This will be validated in Story 4.x when YouTube templates are imported and schemas are generated.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**

- [ ] Test 1: AC7 - Prompt Engineer agent handles dual schemas

**Terminal Tests:**

- [x] Test A: AC2 - Schema TypeScript interface includes output schema fields ‚úÖ
- [x] Test B: AC3 - Output schema extraction from template comments ‚úÖ
- [x] Test C: AC4 - Schema validation API endpoint ‚úÖ
- [x] Test D: AC5 - Validation reports missing fields ‚úÖ
- [x] Test E: AC5 - Validation reports type mismatches ‚úÖ
- [x] Test F: AC6 - Output schemas support structured JSON ‚úÖ
- [x] Test G: AC6 - Output schemas support unstructured text ‚úÖ
- [x] Test H: AC8 - Output schemas optional (null when missing) ‚úÖ

**Overall Status**: üîÑ In Progress (Terminal Tests: ‚úÖ All Passed | Human Tests: ‚¨ú Pending)

---

## Troubleshooting

### Issue: Server won't start (port already in use)

**Symptom**: Error "EADDRINUSE: address already in use :::4321"

**Solution**: Kill existing server process: `pkill -f "npm run dev"` or `lsof -ti:4321 | xargs kill`

### Issue: curl command returns "Connection refused"

**Symptom**: curl: (7) Failed to connect to localhost port 4321

**Solution**: Ensure server is running: `cd packages/poem-app && npm run dev`

### Issue: jq command not found

**Symptom**: -bash: jq: command not found

**Solution**: Install jq: `brew install jq` (macOS) or remove `| jq '.'` from commands

### Issue: API returns 404 for /api/schema/validate

**Symptom**: `{"success": false, "error": "Not found"}`

**Solution**: Verify API endpoint file exists at `packages/poem-app/src/pages/api/schema/validate.ts`

### Issue: Validation timing exceeds 100ms (NFR2 violation)

**Symptom**: `validationTimeMs` > 100ms in response

**Solution**: This is a performance issue. Check system load, ensure no other heavy processes running. If persistent, report as performance regression.

---

## Test Results Summary

**Date Tested**: _________________

**Tester**: _________________

**Results**:

- Human Tests: __ / 1 passed
- Terminal Tests: __ / 8 passed
- Total: __ / 9 passed

**Issues Found**:

1. _________________
2. _________________

**Sign-off**: ‚úÖ Story accepted | ‚ùå Issues require fixes

---

_Generated by Taylor (SAT Guide Creator) from Story 3.7_

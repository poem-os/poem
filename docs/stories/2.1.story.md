# Story 2.1: Configure Astro Server

## Status

Done

## Story

**As a** developer,
**I want** a configured Astro server that starts reliably,
**so that** API endpoints are available for POEM operations.

## Acceptance Criteria

1. Astro server starts with `npm run dev` in `.poem-app/`
2. Server port configurable via environment variable or config file
3. Server startup time under 3 seconds (NFR2)
4. Health check endpoint `/api/health` returns server status
5. Server logs startup information (port, environment, version)
6. Graceful shutdown on SIGTERM/SIGINT
7. Error handling for port conflicts with helpful message

## Tasks / Subtasks

- [x] Task 1: Verify existing server functionality meets AC 1, 2, 3 (AC: 1, 2, 3)
  - [x] Confirm `npm run dev` starts Astro server in packages/poem-app
  - [x] Verify PORT environment variable configuration works
  - [x] Measure and document startup time (must be < 3 seconds)
  - [x] Document the verification results

- [x] Task 2: Enhance health check endpoint (AC: 4)
  - [x] Add `uptime` field (server uptime in seconds)
  - [x] Add `helpersLoaded` field (count of registered Handlebars helpers, 0 for now)
  - [x] Add `environment` field (development/production)
  - [x] Update response to match API specification format
  - [x] Write unit test for health endpoint

- [x] Task 3: Implement startup logging (AC: 5)
  - [x] Create a server lifecycle module (`src/services/server/index.ts`)
  - [x] Log server port on startup
  - [x] Log environment (development/production)
  - [x] Log POEM version
  - [x] Format log output clearly for developer visibility

- [x] Task 4: Implement graceful shutdown (AC: 6)
  - [x] Add SIGTERM signal handler
  - [x] Add SIGINT signal handler (Ctrl+C)
  - [x] Log shutdown message before exiting
  - [x] Ensure clean process exit

- [x] Task 5: Implement port conflict error handling (AC: 7)
  - [x] Detect EADDRINUSE error on startup
  - [x] Display helpful message with current port and suggestions
  - [x] Suggest using PORT env var to change port
  - [x] Exit with appropriate error code

- [x] Task 6: Write integration tests for server lifecycle (AC: 3, 4, 5, 6, 7)
  - [x] Test health endpoint returns all required fields
  - [x] Test startup time is under 3 seconds (NFR2)
  - [x] Document manual verification for signal handling

## Dev Notes

### Previous Story Insights

[Source: Story 1.3 Completion Notes]

Story 1.3 established the poem-app scaffolding:
- Astro 5.16.6 installed and running with ~80ms startup time (well under NFR2)
- Basic health endpoint exists at `src/pages/api/health.ts` returning `{status, timestamp, version}`
- PORT environment variable support in `astro.config.mjs` with 4321 default
- Config service at `src/config/index.ts` exports typed configuration

**Key files from 1.3:**
- `packages/poem-app/package.json` - has dev/build/preview scripts
- `packages/poem-app/astro.config.mjs` - PORT env var already configured
- `packages/poem-app/src/config/index.ts` - config service exists
- `packages/poem-app/src/pages/api/health.ts` - basic implementation exists

**Note from 1.3 QA:** health.ts uses hardcoded version instead of importing from config - this story should improve this.

### API Specification for Health Endpoint

[Source: architecture/api-specification.md#health]

The health endpoint must return:
```json
{
  "status": "ok",
  "version": "1.0.0",
  "uptime": 123.45,
  "helpersLoaded": 6
}
```

Response type: `200 OK` with `Content-Type: application/json`

### Astro Server Component

[Source: architecture/components.md#astro-server]

Responsibilities:
- HTTP server with REST APIs for template rendering, schema operations, provider integration
- File-based routing (`src/pages/api/*.ts`)
- Fast startup (< 3 seconds per NFR2)

Technology Stack: Astro 5.x, TypeScript, Node.js

### Project Structure

[Source: architecture/unified-project-structure.md]

Relevant poem-app structure:
```
packages/poem-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â””â”€â”€ health.ts         â† Enhance in this story
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ server/               â† Create in this story
â”‚   â”‚       â””â”€â”€ index.ts          â† Server lifecycle utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ index.ts              â† Already exists
â”‚   â”‚
â”‚   â””â”€â”€ env.d.ts
â”‚
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ health.test.ts        â† Create in this story
â”‚
â”œâ”€â”€ astro.config.mjs
â””â”€â”€ package.json
```

### Tech Stack

[Source: architecture/tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| Astro | 5.x | API endpoints, file-based routing |
| TypeScript | 5.9.x | Type-safe server code |
| Node.js | 22.x LTS | Server runtime |
| Vitest | 4.x | Testing |

### Coding Standards

[Source: architecture/coding-standards.md]

**API Endpoint Standards:**
```typescript
// âœ… DO: Use consistent error response format
export async function GET({ request }: APIContext) {
  try {
    // ... process
    return new Response(JSON.stringify({ success: true, data }));
  } catch (error) {
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      { status: 400 }
    );
  }
}
```

**Naming Conventions:**
| Element | Convention | Example |
|---------|------------|---------|
| API routes | kebab-case directories | `/api/health.ts` |
| Services | PascalCase classes | `ServerService` |
| Test files | *.test.ts | `health.test.ts` |

**Error Context:** All API errors must include error type, message, and relevant context (file path, line number for parse errors).

### Startup Logging Pattern

[Source: No specific guidance in architecture docs]

Recommended console output format:
```
ðŸš€ POEM Server starting...
   Port: 4321
   Environment: development
   Version: 0.1.0
âœ… Server ready in 80ms
```

### Graceful Shutdown Pattern

[Source: No specific guidance in architecture docs]

Node.js signal handling:
```typescript
// Handle shutdown signals
process.on('SIGTERM', () => {
  console.log('Received SIGTERM, shutting down gracefully...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('Received SIGINT, shutting down gracefully...');
  process.exit(0);
});
```

**Note:** Astro dev server handles these internally, but we should ensure clean exit logging.

### Port Conflict Handling

[Source: No specific guidance in architecture docs]

When EADDRINUSE error occurs:
```
âŒ Port 4321 is already in use

Try one of these:
  â€¢ Use a different port: PORT=4322 npm run dev
  â€¢ Find and stop the process using port 4321
  â€¢ Use 'lsof -i :4321' to identify the process
```

### NFR Performance Requirements

[Source: docs/prd.md, architecture/testing-strategy.md]

- NFR2: Server startup time under 3 seconds
- Current baseline from Story 1.3: ~80ms (excellent margin)

### Testing

[Source: architecture/testing-strategy.md]

**Test file location:** `packages/poem-app/tests/api/health.test.ts`

**Test framework:** Vitest 4.x

**Coverage targets:**
- API Endpoints: 75%

**Test examples from architecture:**
```typescript
// tests/api/health.test.ts
import { describe, it, expect } from 'vitest';

describe('GET /api/health', () => {
  it('should return status ok', async () => {
    const response = await fetch('http://localhost:4321/api/health');
    expect(response.ok).toBe(true);

    const data = await response.json();
    expect(data.status).toBe('ok');
    expect(data.uptime).toBeTypeOf('number');
    expect(data.helpersLoaded).toBeTypeOf('number');
  });
});
```

**NFR validation test:**
```typescript
it('NFR2: Server starts in under 3 seconds', async () => {
  const start = Date.now();
  // Server startup logic
  const elapsed = Date.now() - start;
  expect(elapsed).toBeLessThan(3000);
});
```

**Manual testing required:**
- Graceful shutdown with Ctrl+C
- Port conflict message (run two instances)
- Startup logging visibility

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-28 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-28 | 1.0 | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered during implementation.

### Completion Notes List

- Task 1: Verified existing server starts in ~160-262ms (well under NFR2 3s limit), PORT env var works correctly
- Task 2: Enhanced health endpoint with uptime, helpersLoaded, environment fields via server lifecycle service
- Task 3: Created Astro integration (`poem-server`) that logs startup with formatted output
- Task 4: Graceful shutdown implemented in integration, logs shutdown message on SIGTERM/SIGINT
- Task 5: Port conflict handling detects EADDRINUSE and displays helpful suggestions
- Task 6: 7 tests pass including NFR2 startup time validation (~1046ms in tests)
- ESLint: 0 errors, 1 intentional warning (_context unused param)
- Version now read from config instead of hardcoded (addressing 1.3 QA note)

### File List

**Created:**
- `packages/poem-app/src/services/server/index.ts` - Server lifecycle service (uptime, logging, shutdown)
- `packages/poem-app/src/integrations/poem-server.ts` - Astro integration for lifecycle hooks
- `packages/poem-app/tests/api/health.test.ts` - 7 integration tests for health endpoint
- `packages/poem-app/vitest.config.ts` - Vitest configuration

**Modified:**
- `packages/poem-app/src/pages/api/health.ts` - Enhanced to return uptime, helpersLoaded, version from config
- `packages/poem-app/astro.config.mjs` - Added poemServer() integration

---

## QA Results

### Review Date: 2025-12-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, well-structured implementation following BMAD patterns and project standards.

**Strengths:**
- Server lifecycle service is well-organized with clear separation of concerns
- Astro integration properly uses lifecycle hooks (config:setup, server:setup, server:start)
- Health endpoint delegates to service layer appropriately
- Comprehensive test coverage with 7 tests including NFR2 validation
- Good use of JSDoc comments with examples
- ANSI color codes for terminal visibility
- Version now imported from config (addressing 1.3 QA note)

**Code Highlights:**
- `src/services/server/index.ts`: Clean utility functions with explicit types
- `src/integrations/poem-server.ts`: Proper Astro integration pattern
- `tests/api/health.test.ts`: Server lifecycle management in tests with proper cleanup

### Refactoring Performed

None required - implementation is clean and follows project standards.

### Compliance Check

- Coding Standards: âœ“ Follows API endpoint patterns, JSDoc documentation, naming conventions
- Project Structure: âœ“ Files in correct locations per unified-project-structure.md
- Testing Strategy: âœ“ Vitest integration tests, NFR validation, manual test documentation
- All ACs Met: âœ“ All 7 acceptance criteria verified

### Requirements Traceability

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Server starts with npm run dev | Test setup in health.test.ts | âœ“ |
| 2 | PORT env var configurable | SAT Test B verified | âœ“ |
| 3 | Startup time < 3 seconds | NFR2 test (1036ms) | âœ“ |
| 4 | Health endpoint returns status | 6 tests validate all fields | âœ“ |
| 5 | Startup logging | Manual verification documented | âœ“ |
| 6 | Graceful shutdown | Manual verification documented | âœ“ |
| 7 | Port conflict handling | Manual verification documented | âœ“ |

### Improvements Checklist

All items complete - no improvements required:

- [x] Health endpoint returns all required fields (status, version, uptime, helpersLoaded)
- [x] Server lifecycle service properly tracks uptime
- [x] Astro integration handles startup, shutdown, and port conflicts
- [x] Tests cover all health endpoint behaviors
- [x] NFR2 performance requirement validated
- [x] Manual test scenarios documented in test file

### Security Review

No security concerns - this story implements local server lifecycle management only:
- No user input handling
- No authentication/authorization
- No external network requests
- No sensitive data storage

### Performance Considerations

**NFR2 Validated:**
- Target: Server startup < 3 seconds
- Actual: ~1036ms in tests, ~160-262ms observed in development
- Margin: Excellent (>60% under limit)

### Files Modified During Review

None - no refactoring needed.

### Gate Status

**Gate: PASS** â†’ docs/qa/gates/2.1-configure-astro-server.yml

### Recommended Status

âœ“ **Ready for Done** - All acceptance criteria met, tests passing, code quality excellent.
